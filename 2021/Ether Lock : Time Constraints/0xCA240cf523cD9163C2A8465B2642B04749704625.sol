['// SPDX-License-Identifier: MIT\n', 'pragma solidity 0.8.0;\n', '\n', 'import "./interfaces/ERC20Interface.sol";\n', '\n', '/****\n', '\n', '████████╗██╗░░██╗███████╗\u2003\u2003███████╗███████╗██╗░░░░░██╗░░░░░░█████╗░░██╗░░░░░░░██╗░██████╗██╗░░██╗██╗██████╗░\n', '╚══██╔══╝██║░░██║██╔════╝\u2003\u2003██╔════╝██╔════╝██║░░░░░██║░░░░░██╔══██╗░██║░░██╗░░██║██╔════╝██║░░██║██║██╔══██╗\n', '░░░██║░░░███████║█████╗░░\u2003\u2003█████╗░░█████╗░░██║░░░░░██║░░░░░██║░░██║░╚██╗████╗██╔╝╚█████╗░███████║██║██████╔╝\n', '░░░██║░░░██╔══██║██╔══╝░░\u2003\u2003██╔══╝░░██╔══╝░░██║░░░░░██║░░░░░██║░░██║░░████╔═████║░░╚═══██╗██╔══██║██║██╔═══╝░\n', '░░░██║░░░██║░░██║███████╗\u2003\u2003██║░░░░░███████╗███████╗███████╗╚█████╔╝░░╚██╔╝░╚██╔╝░██████╔╝██║░░██║██║██║░░░░░\n', '░░░╚═╝░░░╚═╝░░╚═╝╚══════╝\u2003\u2003╚═╝░░░░░╚══════╝╚══════╝╚══════╝░╚════╝░░░░╚═╝░░░╚═╝░░╚═════╝░╚═╝░░╚═╝╚═╝╚═╝░░░░░\n', '\n', '*****/\n', '\n', '/** \n', ' @author Tellor Inc.\n', ' @title Fellowship\n', ' @dev This contract holds the selected few chosen as part of the Fellowship\n', '**/\n', 'contract Fellowship {\n', '    //Storage\n', '    enum Status {INACTIVE, ACTIVE, PENDING_WITHDRAW, UNFUNDED}\n', '\n', '    struct Walker {\n', '        Status status; //status of walker\n', '        uint256 date; //date the walker initally was chosen\n', '        uint256 fellowshipIndex; //index of walker in the fellowship array\n', '        uint256 balance; //TRB balance of walker (must be > stakeAmount to be ACTIVE)\n', '        uint256 rewardBalance; //balance of rewards they own\n', '        string name; //name of walker\n', '    }\n', '\n', '    uint256 public lastPayDate; //most recent date walkers were paid\n', '    uint256 public rewardPool; //sum of all payments for services in contract\n', '    uint256 public stakeAmount; //minimum amount each walker needs to stake\n', '    address public rivendell; //the address of the voting contract\n', '    address public tellor; //address of tellor (the token for staking and payments)\n', '\n', '    mapping(address => mapping(bytes32 => bytes)) information; //allows parties to store arbitrary information\n', '    mapping(address => Walker) public walkers; //a mapping of an address to their information as a Walker\n', "    mapping(address => uint256) public payments; //a mapping of an address to the payment amount they've given\n", '    //The Fellowship:\n', '    address[] public fellowship; //The array of chosen individuals who are part of the fellowship\n', '\n', '    //Events\n', '    event NewWalker(address walker);\n', '    event NewWalkerInformation(address walker, bytes32 input, bytes output);\n', '    event WalkerBanished(address walker);\n', '    event StakeWithdrawalRequestStarted(address walker);\n', '    event StakeWithdrawn(address walker);\n', '    event PaymentDeposited(address payee, uint256 amount);\n', '    event RewardsPaid(uint256 rewardPerWalker);\n', '\n', '    //Modifiers\n', '    /**\n', '     * @dev This modifier restricts the function to only the Rivendell contract\n', '     */\n', '    modifier onlyRivendell {\n', '        require(\n', '            msg.sender == rivendell,\n', '            "Only rivendell can call this function."\n', '        );\n', '        _;\n', '    }\n', '\n', '    //Functions\n', '    /**\n', '     * @dev Constructor for setting initial variables\n', '     * @param _tellor the address of the tellor contract\n', '     * @param _initialWalkers an array of three addresses to serve as the initial walkers\n', '     */\n', '    constructor(address _tellor, address[3] memory _initialWalkers) {\n', '        tellor = _tellor;\n', '        _newWalker(_initialWalkers[0], "Aragorn");\n', '        _newWalker(_initialWalkers[1], "Legolas");\n', '        _newWalker(_initialWalkers[2], "Gimli");\n', '        stakeAmount = 10 ether;\n', '    }\n', '\n', '    /**\n', '     * @dev Function to banish a walker\n', '     * @param _oldWalker address of walker to be banished (removed from Fellowship)\n', '     **/\n', '    function banishWalker(address _oldWalker) external onlyRivendell {\n', '        require(\n', '            walkers[_oldWalker].status != Status.INACTIVE,\n', '            "walker is already banished"\n', '        );\n', '        _banishWalker(_oldWalker);\n', '        emit WalkerBanished(_oldWalker);\n', '    }\n', '\n', '    /**\n', '     * @dev Function to deposit payment to use Fellowship\n', '     * @param _amount amount of TRB to be used as payment\n', '     **/\n', '    function depositPayment(uint256 _amount) external {\n', '        if (rewardPool > 0) {\n', '            payReward();\n', '        } else {\n', '            lastPayDate = block.timestamp;\n', '        }\n', '        ERC20Interface(tellor).transferFrom(msg.sender, address(this), _amount);\n', '        payments[msg.sender] += _amount;\n', '        rewardPool += _amount;\n', '        emit PaymentDeposited(msg.sender, _amount);\n', '    }\n', '\n', '    /**\n', '     * @dev Function to deposit a stake for walkers\n', '     * @param _amount amount of TRB to deposit to account\n', '     **/\n', '    function depositStake(uint256 _amount) external {\n', '        ERC20Interface(tellor).transferFrom(msg.sender, address(this), _amount);\n', '        walkers[msg.sender].balance += _amount;\n', '        require(\n', '            walkers[msg.sender].status != Status.INACTIVE,\n', '            "Walker has wrong status"\n', '        );\n', '        require(\n', '            walkers[msg.sender].status != Status.PENDING_WITHDRAW,\n', '            "Walker has wrong status"\n', '        );\n', '        if (walkers[msg.sender].balance >= stakeAmount) {\n', '            walkers[msg.sender].status = Status.ACTIVE;\n', '        }\n', '    }\n', '\n', '    /**\n', '     * @dev Change the rivendell (governance) contract\n', '     * @param _newRivendell address to act as owner of the Fellowship\n', '     **/\n', '    function newRivendell(address _newRivendell) external {\n', '        require(\n', '            msg.sender == rivendell || rivendell == address(0),\n', '            "Only rivendell can call this function."\n', '        );\n', '        rivendell = _newRivendell;\n', '    }\n', '\n', '    /**\n', '     * @dev Function to add a new walker\n', '     * @param _walker address of walker to be banished (removed from Fellowship)\n', '     * @param _name name of walker\n', '     **/\n', '    function newWalker(address _walker, string memory _name)\n', '        external\n', '        onlyRivendell\n', '    {\n', '        _newWalker(_walker, _name);\n', '    }\n', '\n', '    /**\n', '     * @dev function to pay a reward to the walkers\n', '     **/\n', '    function payReward() public {\n', '        uint256 timeSinceLastPayment = block.timestamp - lastPayDate;\n', '        if (timeSinceLastPayment > 6 * 30 days) {\n', '            timeSinceLastPayment = 6 * 30 days;\n', '        }\n', '        uint256 reward =\n', '            (rewardPool * timeSinceLastPayment) /\n', '                6 /\n', '                30 days /\n', '                fellowship.length;\n', '        if (reward > 0) {\n', '            for (uint256 i = 0; i < fellowship.length; i++) {\n', '                if (walkers[fellowship[i]].status == Status.ACTIVE) {\n', '                    walkers[fellowship[i]].rewardBalance += reward;\n', '                    rewardPool -= reward;\n', '                }\n', '            }\n', '            lastPayDate = block.timestamp;\n', '            emit RewardsPaid(reward);\n', '        }\n', '    }\n', '\n', '    /**\n', '     * @dev Function lets walkers recieve their reward\n', '     **/\n', '    function recieveReward() external {\n', '        require(\n', '            walkers[msg.sender].status == Status.ACTIVE,\n', '            "Walker has wrong status"\n', '        );\n', '        ERC20Interface(tellor).transfer(\n', '            msg.sender,\n', '            walkers[msg.sender].rewardBalance\n', '        );\n', '        walkers[msg.sender].rewardBalance = 0;\n', '    }\n', '\n', '    /**\n', '     * @dev Function for walkers to request to withdraw their stake\n', '     **/\n', '    function requestStakingWithdraw() external {\n', '        require(\n', '            walkers[msg.sender].status != Status.INACTIVE,\n', '            "Walker has wrong status"\n', '        );\n', '        walkers[msg.sender].status = Status.PENDING_WITHDRAW;\n', '        walkers[msg.sender].date = block.timestamp;\n', '        emit StakeWithdrawalRequestStarted(msg.sender);\n', '    }\n', '\n', '    /**\n', '     * @dev Function for rivendell to change the staking amount\n', '     * @param _amount the staking requirement in TRB\n', '     **/\n', '    function setStakeAmount(uint256 _amount) external onlyRivendell {\n', '        stakeAmount = _amount;\n', '        for (uint256 i = 0; i < fellowship.length; i++) {\n', '            if (walkers[fellowship[i]].status == Status.ACTIVE && walkers[fellowship[i]].balance < stakeAmount) {\n', '                walkers[fellowship[i]].status = Status.UNFUNDED;\n', '            }\n', '        }\n', '    }\n', '\n', '    /**\n', '     * @dev Function for walkers to store arbitrary information mapped to their account\n', '     * @param _input the key for the mapping\n', '     * @param _output the result for the mapping\n', '     **/\n', '    function setWalkerInformation(bytes32 _input, bytes memory _output) external {\n', '        require(\n', '            isWalker(msg.sender) || msg.sender == rivendell,\n', '            "must be a valid walker to use this function"\n', '        );\n', '        information[msg.sender][_input] = _output;\n', '        emit NewWalkerInformation(msg.sender, _input, _output);\n', '    }\n', '\n', '    /**\n', '     * @dev Function for rivendell to slash a walker\n', '     * @param _walker the address of the slashed walker\n', '     * @param _amount the amount to slash\n', '     * @param _banish a bool to say whether the walker is also banished\n', '     **/\n', '    function slashWalker(\n', '        address _walker,\n', '        uint256 _amount,\n', '        bool _banish\n', '    ) external onlyRivendell {\n', '        if (walkers[_walker].balance >= _amount) {\n', '            walkers[_walker].balance -= _amount;\n', '            rewardPool += _amount;\n', '        } else if (walkers[_walker].balance > 0) {\n', '            rewardPool += walkers[_walker].balance;\n', '            walkers[_walker].balance = 0;\n', '        }\n', '        if (_banish) {\n', '            if (walkers[_walker].status != Status.INACTIVE) {\n', '                _banishWalker(_walker);\n', '            }\n', '        } else if (walkers[_walker].balance < stakeAmount) {\n', '            walkers[_walker].status = Status.UNFUNDED;\n', '        }\n', '    }\n', '\n', '    /**\n', '     * @dev Function for walkers to withdraw stake two weeks after requesting a withdrawal\n', '     **/\n', '    function withdrawStake() external {\n', '        require(\n', '            walkers[msg.sender].status == Status.PENDING_WITHDRAW,\n', '            "walker has wrong status"\n', '        );\n', '        require(\n', '            block.timestamp - walkers[msg.sender].date > 14 days,\n', '            "has not been long enough to withdraw"\n', '        );\n', '        ERC20Interface(tellor).transfer(\n', '            msg.sender,\n', '            walkers[msg.sender].balance\n', '        );\n', '        walkers[msg.sender].balance = 0;\n', '        _banishWalker(msg.sender);\n', '        emit StakeWithdrawn(msg.sender);\n', '    }\n', '\n', '    //View Functions\n', '    /**\n', '     * @dev Function returns the current reward for each walker\n', '     * @return uint256 reward\n', '     **/\n', '    function checkReward() external view returns (uint256) {\n', '        uint256 timeSinceLastPayment = block.timestamp - lastPayDate;\n', '        if (timeSinceLastPayment > 6 * 30 days) {\n', '            timeSinceLastPayment = 6 * 30 days;\n', '        }\n', '        return ((rewardPool * timeSinceLastPayment) /\n', '            6 /\n', '            30 days /\n', '            fellowship.length);\n', '    }\n', '\n', '    /**\n', '     * @dev Function to return the fellowship size\n', '     * @return uint256 size\n', '     **/\n', '    function getFellowshipSize() external view returns (uint256) {\n', '        return fellowship.length;\n', '    }\n', '\n', '    /**\n', '     * @dev Function for walkers to withdraw stake two weeks after requesting a withdrawal\n', '     * @param _walker address of the walker of interest\n', '     * @return uint256 epoch timestamp of date walker started\n', '     * @return uint256 index in the fellowship array\n', '     * @return Status of the walker\n', '     * @return uint256 balance of the walker staked\n', '     * @return uint256 balance for withrawal by the walker\n', '     * @return string name of the walker\n', '     **/\n', '    function getWalkerDetails(address _walker)\n', '        external\n', '        view\n', '        returns (\n', '            uint256,\n', '            uint256,\n', '            Status,\n', '            uint256,\n', '            uint256,\n', '            string memory\n', '        )\n', '    {\n', '        return (\n', '            walkers[_walker].date,\n', '            walkers[_walker].fellowshipIndex,\n', '            walkers[_walker].status,\n', '            walkers[_walker].balance,\n', '            walkers[_walker].rewardBalance,\n', '            walkers[_walker].name\n', '        );\n', '    }\n', '\n', '    /**\n', '     * @dev Function to get arbitrary information set by the walker\n', '     * @param _walker address of walker\n', '     * @param _input mapping key for information mapping\n', '     * @return bytes output of mapping\n', '     **/\n', '    function getWalkerInformation(address _walker, bytes32 _input)\n', '        external\n', '        view\n', '        returns (bytes memory)\n', '    {\n', '        return information[_walker][_input];\n', '    }\n', '\n', '    /**\n', "     * @dev Function to check if walker's status is active\n", '     * @param _party address of walker\n', '     * @return bool if walker has Status.ACTIVE\n', '     **/\n', '    function isWalker(address _party) public view returns (bool) {\n', '        if (walkers[_party].status == Status.ACTIVE) {\n', '            return true;\n', '        }\n', '        return false;\n', '    }\n', '\n', '    //Internal Functions\n', '    /**\n', '     * @dev Internal function to banish a given walker\n', '     * @param _oldWalker walker to banish\n', '     **/\n', '    function _banishWalker(address _oldWalker) internal {\n', '        fellowship[walkers[_oldWalker].fellowshipIndex] = fellowship[\n', '            fellowship.length - 1\n', '        ];\n', '        walkers[fellowship[fellowship.length - 1]].fellowshipIndex = walkers[\n', '            _oldWalker\n', '        ]\n', '            .fellowshipIndex;\n', '        fellowship.pop();\n', '        walkers[_oldWalker].fellowshipIndex = 0;\n', '        walkers[_oldWalker].status = Status.INACTIVE;\n', '        ERC20Interface(tellor).transfer(\n', '            _oldWalker,\n', '            walkers[_oldWalker].balance\n', '        );\n', '        walkers[_oldWalker].balance = 0;\n', '        rewardPool += walkers[_oldWalker].rewardBalance;\n', '        walkers[_oldWalker].rewardBalance = 0;\n', '    }\n', '\n', '    /**\n', '     * @dev Internal function to add a new walker\n', '     * @param _walker address of new walker\n', '     * @param _name name of new walker\n', '     **/\n', '    function _newWalker(address _walker, string memory _name) internal {\n', '        require(walkers[_walker].date == 0, "cannot already be a walker");\n', '        fellowship.push(_walker);\n', '        walkers[_walker] = Walker({\n', '            date: block.timestamp,\n', '            name: _name,\n', '            status: Status.UNFUNDED,\n', '            fellowshipIndex: fellowship.length - 1,\n', '            balance: 0,\n', '            rewardBalance: 0\n', '        });\n', '        emit NewWalker(_walker);\n', '    }\n', '}\n', '\n', '// SPDX-License-Identifier: MIT\n', 'pragma solidity ^0.8.0;\n', '\n', 'interface ERC20Interface {\n', '    function transfer(address _to, uint256 _amount) external returns (bool);\n', '\n', '    function transferFrom(\n', '        address _from,\n', '        address _to,\n', '        uint256 _amount\n', '    ) external returns (bool);\n', '\n', '    function balanceOf(address _addy) external returns (uint256);\n', '\n', '    function balanceOfAt(address _addy, uint256 _block)\n', '        external\n', '        returns (uint256);\n', '}\n', '\n', '{\n', '  "optimizer": {\n', '    "enabled": true,\n', '    "runs": 999999\n', '  },\n', '  "outputSelection": {\n', '    "*": {\n', '      "*": [\n', '        "evm.bytecode",\n', '        "evm.deployedBytecode",\n', '        "abi"\n', '      ]\n', '    }\n', '  },\n', '  "libraries": {}\n', '}']