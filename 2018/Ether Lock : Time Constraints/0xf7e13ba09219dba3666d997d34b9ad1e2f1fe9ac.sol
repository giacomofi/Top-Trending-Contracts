['pragma solidity ^0.4.15;\n', '\n', '\n', '\n', '\n', '\n', '\n', '\n', 'library DateTime {\n', '        /*\n', '         *  Date and Time utilities for ethereum contracts\n', '         *\n', '         */\n', '        struct _DateTime {\n', '                uint16 year;\n', '                uint8 month;\n', '                uint8 day;\n', '                uint8 hour;\n', '                uint8 minute;\n', '                uint8 second;\n', '                uint8 weekday;\n', '        }\n', '\n', '        uint private constant DAY_IN_SECONDS = 86400;\n', '        uint private constant YEAR_IN_SECONDS = 31536000;\n', '        uint private constant LEAP_YEAR_IN_SECONDS = 31622400;\n', '\n', '        uint private constant HOUR_IN_SECONDS = 3600;\n', '        uint private constant MINUTE_IN_SECONDS = 60;\n', '\n', '        uint16 private constant ORIGIN_YEAR = 1970;\n', '\n', '        function isLeapYear(uint16 year) public constant returns (bool) {\n', '                if (year % 4 != 0) {\n', '                        return false;\n', '                }\n', '                if (year % 100 != 0) {\n', '                        return true;\n', '                }\n', '                if (year % 400 != 0) {\n', '                        return false;\n', '                }\n', '                return true;\n', '        }\n', '\n', '        function leapYearsBefore(uint year) public constant  returns (uint) {\n', '                year -= 1;\n', '                return year / 4 - year / 100 + year / 400;\n', '        }\n', '\n', '        function getDaysInMonth(uint8 month, uint16 year) public constant  returns (uint8) {\n', '                if (month == 1 || month == 3 || month == 5 || month == 7 || month == 8 || month == 10 || month == 12) {\n', '                        return 31;\n', '                }\n', '                else if (month == 4 || month == 6 || month == 9 || month == 11) {\n', '                        return 30;\n', '                }\n', '                else if (isLeapYear(year)) {\n', '                        return 29;\n', '                }\n', '                else {\n', '                        return 28;\n', '                }\n', '        }\n', '\n', '        function parseTimestamp(uint timestamp) internal constant returns (_DateTime dt) {\n', '                uint secondsAccountedFor = 0;\n', '                uint buf;\n', '                uint8 i;\n', '\n', '                // Year\n', '                dt.year = getYear(timestamp);\n', '                buf = leapYearsBefore(dt.year) - leapYearsBefore(ORIGIN_YEAR);\n', '\n', '                secondsAccountedFor += LEAP_YEAR_IN_SECONDS * buf;\n', '                secondsAccountedFor += YEAR_IN_SECONDS * (dt.year - ORIGIN_YEAR - buf);\n', '\n', '                // Month\n', '                uint secondsInMonth;\n', '                for (i = 1; i <= 12; i++) {\n', '                        secondsInMonth = DAY_IN_SECONDS * getDaysInMonth(i, dt.year);\n', '                        if (secondsInMonth + secondsAccountedFor > timestamp) {\n', '                                dt.month = i;\n', '                                break;\n', '                        }\n', '                        secondsAccountedFor += secondsInMonth;\n', '                }\n', '\n', '                // Day\n', '                for (i = 1; i <= getDaysInMonth(dt.month, dt.year); i++) {\n', '                        if (DAY_IN_SECONDS + secondsAccountedFor > timestamp) {\n', '                                dt.day = i;\n', '                                break;\n', '                        }\n', '                        secondsAccountedFor += DAY_IN_SECONDS;\n', '                }\n', '\n', '                // Hour\n', '                dt.hour = getHour(timestamp);\n', '\n', '                // Minute\n', '                dt.minute = getMinute(timestamp);\n', '\n', '                // Second\n', '                dt.second = getSecond(timestamp);\n', '\n', '                // Day of week.\n', '                dt.weekday = getWeekday(timestamp);\n', '        }\n', '\n', '        function getYear(uint timestamp) public constant returns (uint16) {\n', '                uint secondsAccountedFor = 0;\n', '                uint16 year;\n', '                uint numLeapYears;\n', '\n', '                // Year\n', '                year = uint16(ORIGIN_YEAR + timestamp / YEAR_IN_SECONDS);\n', '                numLeapYears = leapYearsBefore(year) - leapYearsBefore(ORIGIN_YEAR);\n', '\n', '                secondsAccountedFor += LEAP_YEAR_IN_SECONDS * numLeapYears;\n', '                secondsAccountedFor += YEAR_IN_SECONDS * (year - ORIGIN_YEAR - numLeapYears);\n', '\n', '                while (secondsAccountedFor > timestamp) {\n', '                        if (isLeapYear(uint16(year - 1))) {\n', '                                secondsAccountedFor -= LEAP_YEAR_IN_SECONDS;\n', '                        }\n', '                        else {\n', '                                secondsAccountedFor -= YEAR_IN_SECONDS;\n', '                        }\n', '                        year -= 1;\n', '                }\n', '                return year;\n', '        }\n', '\n', '        function getMonth(uint timestamp) public constant returns (uint8) {\n', '                return parseTimestamp(timestamp).month;\n', '        }\n', '\n', '        function getDay(uint timestamp) public constant returns (uint8) {\n', '                return parseTimestamp(timestamp).day;\n', '        }\n', '\n', '        function getHour(uint timestamp) public constant returns (uint8) {\n', '                return uint8((timestamp / 60 / 60) % 24);\n', '        }\n', '\n', '        function getMinute(uint timestamp) public constant returns (uint8) {\n', '                return uint8((timestamp / 60) % 60);\n', '        }\n', '\n', '        function getSecond(uint timestamp) public constant returns (uint8) {\n', '                return uint8(timestamp % 60);\n', '        }\n', '\n', '        function getWeekday(uint timestamp) public constant returns (uint8) {\n', '                return uint8((timestamp / DAY_IN_SECONDS + 4) % 7);\n', '        }\n', '\n', '        function toTimestamp(uint16 year, uint8 month, uint8 day) public constant returns (uint timestamp) {\n', '                return toTimestamp(year, month, day, 0, 0, 0);\n', '        }\n', '\n', '        function toTimestamp(uint16 year, uint8 month, uint8 day, uint8 hour) public constant returns (uint timestamp) {\n', '                return toTimestamp(year, month, day, hour, 0, 0);\n', '        }\n', '\n', '        function toTimestamp(uint16 year, uint8 month, uint8 day, uint8 hour, uint8 minute) public constant returns (uint timestamp) {\n', '                return toTimestamp(year, month, day, hour, minute, 0);\n', '        }\n', '\n', '        function toTimestamp(uint16 year, uint8 month, uint8 day, uint8 hour, uint8 minute, uint8 second) public constant returns (uint timestamp) {\n', '                uint16 i;\n', '\n', '                // Year\n', '                for (i = ORIGIN_YEAR; i < year; i++) {\n', '                        if (isLeapYear(i)) {\n', '                                timestamp += LEAP_YEAR_IN_SECONDS;\n', '                        }\n', '                        else {\n', '                                timestamp += YEAR_IN_SECONDS;\n', '                        }\n', '                }\n', '\n', '                // Month\n', '                uint8[12] memory monthDayCounts;\n', '                monthDayCounts[0] = 31;\n', '                if (isLeapYear(year)) {\n', '                        monthDayCounts[1] = 29;\n', '                }\n', '                else {\n', '                        monthDayCounts[1] = 28;\n', '                }\n', '                monthDayCounts[2] = 31;\n', '                monthDayCounts[3] = 30;\n', '                monthDayCounts[4] = 31;\n', '                monthDayCounts[5] = 30;\n', '                monthDayCounts[6] = 31;\n', '                monthDayCounts[7] = 31;\n', '                monthDayCounts[8] = 30;\n', '                monthDayCounts[9] = 31;\n', '                monthDayCounts[10] = 30;\n', '                monthDayCounts[11] = 31;\n', '\n', '                for (i = 1; i < month; i++) {\n', '                        timestamp += DAY_IN_SECONDS * monthDayCounts[i - 1];\n', '                }\n', '\n', '                // Day\n', '                timestamp += DAY_IN_SECONDS * (day - 1);\n', '\n', '                // Hour\n', '                timestamp += HOUR_IN_SECONDS * (hour);\n', '\n', '                // Minute\n', '                timestamp += MINUTE_IN_SECONDS * (minute);\n', '\n', '                // Second\n', '                timestamp += second;\n', '\n', '                return timestamp;\n', '        }\n', '\n', '\t\t// -1 t1 < t2\n', '\t\t// 0  t1 == t2\n', '\t\t// 1  t1 > t2\n', '\t\tfunction compareDatesWithoutTime(uint t1, uint t2) public constant returns (int res)\n', '\t\t{\n', '\t\t\t_DateTime memory dt1 = parseTimestamp(t1);\n', '\t\t\t_DateTime memory dt2 = parseTimestamp(t2);\n', '\n', '\t\t\tres = compareInts(dt1.year, dt2.year);\n', '\t\t\tif (res == 0)\n', '\t\t\t{\n', '\t\t\t\tres = compareInts(dt1.month, dt2.month);\n', '\t\t\t\tif (res == 0)\n', '\t\t\t\t{\n', '\t\t\t\t\tres = compareInts(dt1.day, dt2.day);\n', '\t\t\t\t}\n', '\t\t\t}\n', '\t\t}\n', '\n', '\n', '\t\t//  t2 -> MoveIn or MoveOut day in GMT, will be counted as beginning of a day\n', '\t\t//  t1 -> Current System DateTime\n', '\t\t// -1 t1 before t2\n', '\t\t//--------------------------------\n', '\t\t// 0  t1 same day as t2\n', '\t\t// 1  t1 after t2\n', '\t\tfunction compareDateTimesForContract(uint t1, uint t2) public constant returns (int res)\n', '\t\t{\n', '\t\t    uint endOfDay = t2 + (60 * 60 * 24);\n', '\t\t    res = 0;\n', '\t\t    \n', '\t\t    if (t2 <= t1 && t1 <= endOfDay)\n', '\t\t    {\n', '\t\t        res = 0;\n', '\t\t    }\n', '\t\t    else if (t2 > t1)\n', '\t\t    {\n', '\t\t        res = -1;\n', '\t\t    }\n', '\t\t    else if (t1 > endOfDay)\n', '\t\t    {\n', '\t\t        res = 1;\n', '\t\t    }\n', '\t\t}\t\n', '\n', '\n', '\t\t// -1 n1 < n2\n', '\t\t// 0  n1 == n2\n', '\t\t// 1  n1 > n2\n', '\t\tfunction compareInts(int n1, int n2) internal constant returns (int res)\n', '\t\t{\n', '\t\t\tif (n1 == n2)\n', '\t\t\t{\n', '\t\t\t\tres = 0;\n', '\t\t\t}\n', '\t\t\telse if (n1 < n2)\n', '\t\t\t{\n', '\t\t\t\tres = -1;\n', '\t\t\t}\n', '\t\t\telse if (n1 > n2)\n', '\t\t\t{\n', '\t\t\t\tres = 1;\n', '\t\t\t}\n', '\t\t}\n', '}\n', '\n', '// ----------------------------------------------------------------------------\n', '// ERC Token Standard #20 Interface\n', '// https://github.com/ethereum/EIPs/blob/master/EIPS/eip-20-token-standard.md\n', '// ----------------------------------------------------------------------------\n', 'contract ERC20Interface {\n', '    function totalSupply() public constant returns (uint);\n', '    function balanceOf(address tokenOwner) public constant returns (uint balance);\n', '    function allowance(address tokenOwner, address spender) public constant returns (uint remaining);\n', '    function transfer(address to, uint tokens) public returns (bool success);\n', '    function approve(address spender, uint tokens) public returns (bool success);\n', '    function transferFrom(address from, address to, uint tokens) public returns (bool success);\n', '\n', '    event Transfer(address indexed from, address indexed to, uint tokens);\n', '    event Approval(address indexed tokenOwner, address indexed spender, uint tokens);\n', '}\n', '\n', '\n', 'library BaseEscrowLib\n', '{\n', '    struct EscrowContractState { \n', '\t\tuint _CurrentDate;\n', '\t\tuint _CreatedDate;\n', '\t\tint _RentPerDay;\n', '\t\tuint _MoveInDate;\n', '\t\tuint _MoveOutDate;\t\t\t\t\n', '\t\tint _TotalAmount;\t\t\t\t\t\n', '\t\tint _SecDeposit;\n', '\t\tint _State;\t\n', '\t\tuint _ActualMoveInDate;\n', '\t\tuint _ActualMoveOutDate;\n', '\t\taddress _landlord;\n', '\t\taddress _tenant;\n', '\t\tbool _TenantConfirmedMoveIn;\t\t\n', '\t\tbool _MisrepSignaled;\t\t\t\n', '\t\tstring _DoorLockData;\n', '\t\taddress _ContractAddress;\t\t\n', '\t\tERC20Interface _tokenApi;\n', '\t\tint _landlBal;\n', '\t\tint _tenantBal;\n', '\t\tint _Id;\n', '\t\tint _CancelPolicy;\n', '\t\tuint _Balance;\n', '\t\tstring _Guid;\n', '    }\n', '\n', '    //Define public constants\n', '\t//Pre-Move In\n', '\tint internal constant ContractStateActive = 1;\n', '\tint internal constant ContractStateCancelledByTenant = 2;\n', '\tint internal constant ContractStateCancelledByLandlord = 3;\n', '\n', '\t//Move-In\n', '\tint internal constant ContractStateTerminatedMisrep = 4;\n', '\n', '\t//Living\n', '\tint internal constant ContractStateEarlyTerminatedByTenant = 5;\n', '\tint internal constant ContractStateEarlyTerminatedByTenantSecDep = 6;\n', '\tint internal constant ContractStateEarlyTerminatedByLandlord = 7;\t\t\n', '\n', '\t//Move-Out\n', '\tint internal constant ContractStateTerminatedOK = 8;\t\n', '\tint internal constant ContractStateTerminatedSecDep = 9;\n', '\t\n', '\t//Stages\n', '\tint internal constant ContractStagePreMoveIn = 0;\n', '\tint internal constant ContractStageLiving = 1;\n', '\tint internal constant ContractStageTermination = 2;\n', '\n', '\t//Action\n', '\tint internal constant ActionKeyTerminate = 0;\n', '\tint internal constant ActionKeyMoveIn = 1;\t\n', '\tint internal constant ActionKeyTerminateMisrep = 2;\t\n', '\tint internal constant ActionKeyPropOk = 3;\n', '\tint internal constant ActionKeyClaimDeposit = 4;\n', '\n', '\t//Log\n', '\tint internal constant LogMessageInfo = 0;\n', '\tint internal constant LogMessageWarning = 1;\n', '\tint internal constant LogMessageError = 2;\n', '\n', '\tevent logEvent(int stage, int atype, uint timestamp, string guid, string text);\n', '\n', '\n', '\t//DEBUG or TESTNET\n', '\t//bool private constant EnableSimulatedCurrentDate = true;\n', '\n', '\t//RELEASE\n', '\tbool private constant EnableSimulatedCurrentDate = false;\n', '\n', '\n', '\t//LogEvent wrapper\n', '\tfunction ContractLogEvent(int stage, int atype, uint timestamp, string guid, string text) public\n', '\t{\n', '\t\tlogEvent(stage, atype, timestamp, guid, text);\n', '\t}\n', '\n', '\t//Constant function wrappers\n', '\tfunction GetContractStateActive() public constant returns (int)\n', '\t{\n', '\t\treturn ContractStateActive;\n', '\t}\n', '\n', '\tfunction GetContractStateCancelledByTenant() public constant returns (int)\n', '\t{\n', '\t\treturn ContractStateCancelledByTenant;\n', '\t}\n', '\n', '\tfunction GetContractStateCancelledByLandlord() public constant returns (int)\n', '\t{\n', '\t\treturn ContractStateCancelledByLandlord;\n', '\t}\n', '\t\n', '\tfunction GetContractStateTerminatedMisrep() public constant returns (int)\n', '\t{\n', '\t\treturn ContractStateTerminatedMisrep;\n', '\t}\n', '\n', '\tfunction GetContractStateEarlyTerminatedByTenant() public constant returns (int)\n', '\t{\n', '\t\treturn ContractStateEarlyTerminatedByTenant;\n', '\t}\n', '\n', '\tfunction GetContractStateEarlyTerminatedByTenantSecDep() public constant returns (int)\n', '\t{\n', '\t\treturn ContractStateEarlyTerminatedByTenantSecDep;\n', '\t}\n', '\n', '\tfunction GetContractStateEarlyTerminatedByLandlord() public constant returns (int)\n', '\t{\n', '\t\treturn ContractStateEarlyTerminatedByLandlord;\t\t\n', '\t}\n', '\n', '\tfunction GetContractStateTerminatedOK() public constant returns (int)\n', '\t{\n', '\t\treturn ContractStateTerminatedOK;\t\n', '\t}\n', '\n', '\tfunction GetContractStateTerminatedSecDep() public constant returns (int)\n', '\t{\n', '\t\treturn ContractStateTerminatedSecDep;\n', '\t}\n', '\t\n', '\tfunction GetContractStagePreMoveIn() public constant returns (int)\n', '\t{\n', '\t\treturn ContractStagePreMoveIn;\n', '\t}\n', '\n', '\tfunction GetContractStageLiving() public constant returns (int)\n', '\t{\n', '\t\treturn ContractStageLiving;\n', '\t}\n', '\n', '\tfunction GetContractStageTermination() public constant returns (int)\n', '\t{\n', '\t\treturn ContractStageTermination;\n', '\t}\n', '\t\n', '\tfunction GetLogMessageInfo() public constant returns (int)\n', '\t{\n', '\t\treturn LogMessageInfo;\n', '\t}\n', '\n', '\tfunction GetLogMessageWarning() public constant returns (int)\n', '\t{\n', '\t\treturn LogMessageWarning;\n', '\t}\n', '\n', '\tfunction GetLogMessageError() public constant returns (int)\n', '\t{\n', '\t\treturn LogMessageError;\n', '\t}\n', '\n', '\n', '\t//////////////////////////////////////////////////////////////////////////////////////////////////////////////\n', '\tfunction initialize(EscrowContractState storage self) {\n', '\n', '\t\t//Check parameters\n', '\t\t//all dates must be in the future\n', '\n', '\t\trequire(self._CurrentDate < self._MoveInDate);\n', '\t\trequire(self._MoveInDate < self._MoveOutDate);\n', '\t\t\t\t\t\t\t\n', '\t\tint nPotentialBillableDays = (int)(self._MoveOutDate - self._MoveInDate) / (60 * 60 * 24);\n', '\t\tint nPotentialBillableAmount = nPotentialBillableDays * (self._RentPerDay);\n', '\t\t\n', '\t\t//Limit 2 months stay\n', '\t\trequire (nPotentialBillableDays <= 60); \n', '\n', '\t\tself._TotalAmount = nPotentialBillableAmount + self._SecDeposit;\n', '\t\t\t\t\n', '\t\t//Sec Deposit should not be more than 30 perecent\n', '\t\trequire (self._SecDeposit / nPotentialBillableAmount * 100 <= 30);\n', '\t\t\t\t\n', '\n', '\t\tself._TenantConfirmedMoveIn = false;\n', '\t\tself._MisrepSignaled = false;\n', '\t\tself._State = GetContractStateActive();\n', '\t\tself._ActualMoveInDate = 0;\n', '\t\tself._ActualMoveOutDate = 0;\n', '\t\tself._landlBal = 0;\n', '\t\tself._tenantBal = 0;\n', '\t}\n', '\n', '\n', '\tfunction TerminateContract(EscrowContractState storage self, int tenantBal, int landlBal, int state) public\n', '\t{\n', '\t\tint stage = GetCurrentStage(self);\n', '\t\tuint nCurrentDate = GetCurrentDate(self);\n', '\t\tint nActualBalance = int(GetContractBalance(self));\n', '\n', '\t\tif (nActualBalance == 0)\n', '\t\t{\n', '\t\t    //If it was unfunded, just change state\n', '\t\t    self._State = state;   \n', '\t\t}\n', '\t\telse if (self._State == ContractStateActive && state != ContractStateActive)\n', '\t\t{\n', '\t\t\t//Check if some balances are negative\n', '\t\t\tif (landlBal < 0)\n', '\t\t\t{\n', '\t\t\t\ttenantBal += landlBal;\n', '\t\t\t\tlandlBal = 0;\n', '\t\t\t}\n', '\n', '\t\t\tif (tenantBal < 0) {\n', '\t\t\t\tlandlBal += tenantBal;\n', '\t\t\t\ttenantBal = 0;\n', '\t\t\t}\n', '\n', '\t\t\t//Check if balances exceed total amount\n', '\t\t\tif ((landlBal + tenantBal) > nActualBalance)\n', '\t\t\t{\n', '\t\t\t\tvar nOverrun = (landlBal + tenantBal) - self._TotalAmount;\n', '\t\t\t\tlandlBal -= (nOverrun / 2);\n', '\t\t\t\ttenantBal -= (nOverrun / 2);\n', '\t\t\t}\n', '\n', '\t\t\tself._State = state;\n', '\n', '\t\t\tstring memory strState = "";\n', '\n', '\t\t\tif (state == ContractStateTerminatedOK)\n', '\t\t\t{\n', '\t\t\t\tstrState = " State is: OK";\n', '\t\t\t}\n', '\t\t\telse if (state == ContractStateEarlyTerminatedByTenant)\n', '\t\t\t{\n', '\t\t\t\tstrState = " State is: Early terminated by tenant";\n', '\t\t\t}\n', '\t\t\telse if (state == ContractStateEarlyTerminatedByTenantSecDep)\n', '\t\t\t{\n', '\t\t\t\tstrState = " State is: Early terminated by tenant, Security Deposit claimed";\n', '\t\t\t}\n', '\t\t\telse if (state == ContractStateEarlyTerminatedByLandlord)\n', '\t\t\t{\n', '\t\t\t\tstrState = " State is: Early terminated by landlord";\n', '\t\t\t}\n', '\t\t\telse if (state == ContractStateCancelledByTenant)\n', '\t\t\t{\n', '\t\t\t\tstrState = " State is: Cancelled by tenant";\n', '\t\t\t}\n', '\t\t\telse if (state == ContractStateCancelledByLandlord)\n', '\t\t\t{\n', '\t\t\t\tstrState = " State is: Cancelled by landlord";\n', '\t\t\t}\n', '\t\t\telse if (state == ContractStateTerminatedSecDep)\n', '\t\t\t{\n', '\t\t\t\tstrState = " State is: Security Deposit claimed";\n', '\t\t\t}\n', '\t\t\n', '\t\t\t\n', '\t\t\t\n', '\t\t\tbytes32 b1;\n', '\t\t\tbytes32 b2;\n', '\t\t\tb1 = uintToBytes(uint(landlBal));\n', '\t\t\tb2 = uintToBytes(uint(tenantBal));\n', '\n', '                        /*\n', '\t\t    string memory s1;\n', '\t\t    string memory s2;\t\n', '\t\t    s1 = bytes32ToString(b1);\n', '\t\t    s2 = bytes32ToString(b2);\n', '                        */\n', '\t\t\t\n', '\t\t\tstring memory strMessage = strConcat(\n', '\t\t\t    "Contract is termintaing. Landlord balance is _$b_", \n', '\t\t\t    bytes32ToString(b1), \n', '\t\t\t    "_$e_, Tenant balance is _$b_", \n', '\t\t\t    bytes32ToString(b2));\n', '\n', '            \n', '\t\t\tstring memory strMessage2 = strConcat(\n', '\t\t\t\tstrMessage,\n', '\t\t\t\t"_$e_.",\n', '\t\t\t\tstrState\n', '\t\t\t);\n', '\n', '            string memory sGuid;\n', '            sGuid = self._Guid;\n', '\t\t\t\n', '            logEvent(stage, LogMessageInfo, nCurrentDate, sGuid, strMessage2);\n', '            \n', '\t\t\t//Send tokens\n', '\t\t\tself._landlBal = landlBal;\n', '\t\t\tself._tenantBal = tenantBal;\n', '\t\t}\t\n', '\t}\n', '\n', '\tfunction GetCurrentStage(EscrowContractState storage self) public constant returns (int stage)\n', '\t{\n', '\t\tuint nCurrentDate = GetCurrentDate(self);\n', '\t\tuint nActualBalance = GetContractBalance(self);\n', '        \n', '        stage = ContractStagePreMoveIn;\n', '        \n', '\t\tif (self._State == ContractStateActive && uint(self._TotalAmount) > nActualBalance)\n', '\t\t{\n', '\t\t\t//Contract unfunded\n', '\t\t\tstage = ContractStagePreMoveIn;\n', '\t\t}\t\t\n', '\t\telse if (DateTime.compareDateTimesForContract(nCurrentDate, self._MoveInDate) < 0)\n', '\t\t{\n', '\t\t\tstage = ContractStagePreMoveIn;\n', '\t\t}\n', '\t\telse if (DateTime.compareDateTimesForContract(nCurrentDate, self._MoveInDate) >= 0 && \n', '\t\t         DateTime.compareDateTimesForContract(nCurrentDate, self._MoveOutDate) < 0 && \n', '\t\t         self._TenantConfirmedMoveIn)\n', '\t\t{\n', '\t\t\tstage = ContractStageLiving;\n', '\t\t}\n', '\t\telse if (DateTime.compareDateTimesForContract(nCurrentDate, self._MoveOutDate) >= 0)\n', '\t\t{\n', '\t\t\tstage = ContractStageTermination;\n', '\t\t}\t\n', '\t}\n', '\n', '\n', '\n', '\t///Helper functions\n', '\tfunction SimulateCurrentDate(EscrowContractState storage self, uint n) public\n', '\t{\n', '\t\tif (EnableSimulatedCurrentDate)\n', '\t\t{\n', '\t\t\tself._CurrentDate = n;\n', '\t\t\t//int stage = GetCurrentStage(self);\n', '\t\t\t//logEvent(stage, LogMessageInfo, self._CurrentDate, "SimulateCurrentDate was called.");\t\n', '\t\t}\n', '\t}\n', '\t\n', '\t\n', '\t\n', '\tfunction GetCurrentDate(EscrowContractState storage self) public constant returns (uint nCurrentDate)\n', '\t{\n', '\t\tif (EnableSimulatedCurrentDate)\n', '\t\t{\n', '\t\t\tnCurrentDate = self._CurrentDate;\n', '\t\t}\n', '\t\telse\n', '\t\t{\n', '\t\t\tnCurrentDate = now;\n', '\t\t}\t\n', '\t}\n', '\n', '\tfunction GetContractBalance(EscrowContractState storage self) public returns (uint res)\n', '\t{\n', '\t    res = self._Balance;\n', '\t}\n', '\n', '\n', '\tfunction splitBalanceAccordingToRatings(int balance, int tenantScore, int landlScore) public constant returns (int tenantBal, int landlBal)\n', '\t{\n', '\t\tif (tenantScore == landlScore) {\n', '\t\t\t//Just split in two \n', '\t\t\ttenantBal = balance / 2;\n', '\t\t\tlandlBal = balance / 2;\n', '\t\t}\n', '\t\telse if (tenantScore == 0)\n', '\t\t{\n', '\t\t\ttenantBal = 0;\n', '\t\t\tlandlBal = balance;\t\t\t\n', '\t\t}\n', '\t\telse if (landlScore == 0) {\n', '\t\t\ttenantBal = balance;\n', '\t\t\tlandlBal = 0;\n', '\t\t}\n', '\t\telse if (tenantScore > landlScore) {\t\t\t\n', '\t\t\tlandlBal = ((landlScore * balance / 2) / tenantScore);\n', '\t\t\ttenantBal = balance - landlBal;\t\t\t\n', '\t\t}\n', '\t\telse if (tenantScore < landlScore) {\t\t\t\n', '\t\t\ttenantBal = ((tenantScore * balance / 2) / landlScore);\n', '\t\t\tlandlBal = balance - tenantBal;\t\t\t\n', '\t\t}\t\t\n', '\t}\n', '\n', '\tfunction formatDate(uint dt) public constant returns (string strDate)\n', '\t{\n', '\t\tbytes32 b1;\n', '\t\tbytes32 b2;\n', '\t\tbytes32 b3;\n', '\t\tb1 = uintToBytes(uint(DateTime.getMonth(dt)));\n', '\t\tb2 = uintToBytes(uint(DateTime.getDay(dt)));\n', '\t\tb3 = uintToBytes(uint(DateTime.getYear(dt)));\n', '\t\tstring memory s1;\n', '\t\tstring memory s2;\t\n', '\t\tstring memory s3;\n', '\t\ts1 = bytes32ToString(b1);\n', '\t\ts2 = bytes32ToString(b2);\n', '\t\ts3 = bytes32ToString(b3);\n', '\t\t\n', '\t\tstring memory strDate1 = strConcat(s1, "/", s2, "/");\n', '\t\tstrDate = strConcat(strDate1, s3);\t\t\t\n', '\t}\n', '\t\n', '\n', '    function strConcat(string _a, string _b, string _c, string _d, string _e) internal constant returns (string){\n', '        bytes memory _ba = bytes(_a);\n', '        bytes memory _bb = bytes(_b);\n', '        bytes memory _bc = bytes(_c);\n', '        bytes memory _bd = bytes(_d);\n', '        bytes memory _be = bytes(_e);\n', '        string memory abcde = new string(_ba.length + _bb.length + _bc.length + _bd.length + _be.length);\n', '        bytes memory babcde = bytes(abcde);\n', '        uint k = 0;\n', '        for (uint i = 0; i < _ba.length; i++) babcde[k++] = _ba[i];\n', '        for (i = 0; i < _bb.length; i++) babcde[k++] = _bb[i];\n', '        for (i = 0; i < _bc.length; i++) babcde[k++] = _bc[i];\n', '        for (i = 0; i < _bd.length; i++) babcde[k++] = _bd[i];\n', '        for (i = 0; i < _be.length; i++) babcde[k++] = _be[i];\n', '        return string(babcde);\n', '    }\n', '    \n', '    function strConcat(string _a, string _b, string _c, string _d) internal constant returns (string) {\n', '        return strConcat(_a, _b, _c, _d, "");\n', '    }\n', '    \n', '    function strConcat(string _a, string _b, string _c) internal constant returns (string) {\n', '        return strConcat(_a, _b, _c, "", "");\n', '    }\n', '    \n', '    function strConcat(string _a, string _b) internal constant returns (string) {\n', '        return strConcat(_a, _b, "", "", "");\n', '    } \n', '    \n', '    function bytes32ToString(bytes32 x) internal constant returns (string) {\n', '        bytes memory bytesString = new bytes(32);\n', '        uint charCount = 0;\n', '        for (uint j = 0; j < 32; j++) {\n', '            byte char = byte(bytes32(uint(x) * 2 ** (8 * j)));\n', '            if (char != 0) {\n', '                bytesString[charCount] = char;\n', '                charCount++;\n', '            }\n', '        }\n', '        bytes memory bytesStringTrimmed = new bytes(charCount);\n', '        for (j = 0; j < charCount; j++) {\n', '            bytesStringTrimmed[j] = bytesString[j];\n', '        }\n', '        return string(bytesStringTrimmed);\n', '    }\n', '\n', '    function bytes32ArrayToString(bytes32[] data) internal constant returns (string) {\n', '        bytes memory bytesString = new bytes(data.length * 32);\n', '        uint urlLength;\n', '        for (uint i=0; i<data.length; i++) {\n', '            for (uint j=0; j<32; j++) {\n', '                byte char = byte(bytes32(uint(data[i]) * 2 ** (8 * j)));\n', '                if (char != 0) {\n', '                    bytesString[urlLength] = char;\n', '                    urlLength += 1;\n', '                }\n', '            }\n', '        }\n', '        bytes memory bytesStringTrimmed = new bytes(urlLength);\n', '        for (i=0; i<urlLength; i++) {\n', '            bytesStringTrimmed[i] = bytesString[i];\n', '        }\n', '        return string(bytesStringTrimmed);\n', '    }  \n', '    \n', '    \n', '    function uintToBytes(uint v) internal constant returns (bytes32 ret) {\n', '        if (v == 0) {\n', '            ret = &#39;0&#39;;\n', '        }\n', '        else {\n', '            while (v > 0) {\n', '                ret = bytes32(uint(ret) / (2 ** 8));\n', '                ret |= bytes32(((v % 10) + 48) * 2 ** (8 * 31));\n', '                v /= 10;\n', '            }\n', '        }\n', '        return ret;\n', '    }\n', '\n', '    /// @dev Converts a numeric string to it&#39;s unsigned integer representation.\n', '    /// @param v The string to be converted.\n', '    function bytesToUInt(bytes32 v) internal constant returns (uint ret) {\n', '        if (v == 0x0) {\n', '            throw;\n', '        }\n', '\n', '        uint digit;\n', '\n', '        for (uint i = 0; i < 32; i++) {\n', '            digit = uint((uint(v) / (2 ** (8 * (31 - i)))) & 0xff);\n', '            if (digit == 0) {\n', '                break;\n', '            }\n', '            else if (digit < 48 || digit > 57) {\n', '                throw;\n', '            }\n', '            ret *= 10;\n', '            ret += (digit - 48);\n', '        }\n', '        return ret;\n', '    }    \n', '\n', '\n', '}\n', '\n', '\n', 'library FlexibleEscrowLib\n', '{\n', '\tusing BaseEscrowLib for BaseEscrowLib.EscrowContractState;\n', '\n', '    //Cancel days\n', '\tint internal constant FreeCancelBeforeMoveInDays = 14;\n', '\n', '\t//Expiration\n', '\tint internal constant ExpireAfterMoveOutDays = 14;\n', '\t\t    \n', '\n', '    \n', '\tfunction TenantTerminate(BaseEscrowLib.EscrowContractState storage self) public\n', '    {\n', '\t\tint nCurrentStage = BaseEscrowLib.GetCurrentStage(self);\n', '\t\tuint nCurrentDate = BaseEscrowLib.GetCurrentDate(self);\n', '\t\tint nActualBalance = int(BaseEscrowLib.GetContractBalance(self));\n', '\t\tint tenantBal = 0;\n', '\t\tint landlBal = 0;\n', '\t\tint state = 0; \n', '\t\tbool bProcessed = false;\n', '        string memory sGuid;\n', '        sGuid = self._Guid;\n', '\n', '\t\tif (nActualBalance == 0)\n', '\t\t{\n', '\t\t\t//If contract is unfunded, just cancel it\n', '\t\t\tstate = BaseEscrowLib.GetContractStateCancelledByTenant();\n', '\t\t\tbProcessed = true;\t\t\t\n', '\t\t}\n', '\t\telse if (nCurrentStage == BaseEscrowLib.GetContractStagePreMoveIn())\n', '\t\t{\t\t\t\n', '\t\t\tint nDaysBeforeMoveIn = (int)(self._MoveInDate - nCurrentDate) / (60 * 60 * 24);\n', '\t\t\tif (nDaysBeforeMoveIn < FreeCancelBeforeMoveInDays)\n', '\t\t\t{\n', '\t\t\t\t//Pay cancel fee\n', '\t\t\t\t//Contract must be fully funded\n', '\t\t\t\trequire(self._RentPerDay <= nActualBalance);\n', '\n', '\t\t\t\t//Cancellation fee is one day rent\n', '\t\t\t\ttenantBal = nActualBalance - self._RentPerDay;\n', '\t\t\t\tlandlBal = self._RentPerDay;\n', '\t\t\t\tstate = BaseEscrowLib.GetContractStateCancelledByTenant();\n', '\t\t\t\tbProcessed = true;\n', '\n', '\t\t\t\tBaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageWarning(), nCurrentDate, sGuid, "Tenant cancelled escrow. Cancellation fee will be withheld from tenant.");\t\t\t\t\t\t\t\t\t\t\n', '\t\t\t}\n', '\t\t\telse\n', '\t\t\t{\n', '\t\t\t\t//No cancel fee\n', '\t\t\t\ttenantBal = nActualBalance;\n', '\t\t\t\tlandlBal = 0;\n', '\t\t\t\tstate = BaseEscrowLib.GetContractStateCancelledByTenant();\n', '\t\t\t\tbProcessed = true;\n', '\n', '\t\t\t\tBaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageWarning(), nCurrentDate, sGuid, "Tenant cancelled escrow.");\n', '\t\t\t}\t\t\t\t\t\n', '\t\t}\n', '\t\telse if (nCurrentStage == BaseEscrowLib.GetContractStageLiving())\n', '\t\t{\n', '\t\t\tstate = 0;\n', '\t\t\tself._ActualMoveOutDate = nCurrentDate;\n', '\t\t\tbProcessed = true;\n', '\t\t\t//In this case landlord will close escrow\n', '\n', '\t\t\tBaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageWarning(), nCurrentDate, sGuid, "Tenant signaled early move-out");\n', '\t\t}\n', '\t\telse if (nCurrentStage == BaseEscrowLib.GetContractStageTermination())\n', '\t\t{\n', '\t\t\t//If landlord did not close the escrow, and if it is expired, tenant may only pay for rent without sec deposit\n', '\t\t\tint nDaysAfterMoveOut = (int)(nCurrentDate - self._MoveOutDate) / (60 * 60 * 24);\n', '\n', '\t\t\tif (nDaysAfterMoveOut > ExpireAfterMoveOutDays)\n', '\t\t\t{\n', '\t\t\t\tint nPotentialBillableDays = (int)(self._MoveOutDate - self._MoveInDate) / (60 * 60 * 24);\n', '\t\t\t\trequire(self._RentPerDay * nPotentialBillableDays <= nActualBalance);\n', '\n', '\t\t\t\tlandlBal = self._RentPerDay * nPotentialBillableDays;\n', '\t\t\t\ttenantBal = nActualBalance - landlBal;\n', '\t\t\t\tbProcessed = true;\n', '\t\t\t\tstate = BaseEscrowLib.GetContractStateTerminatedOK();\n', '\n', '\t\t\t\tBaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageInfo(), nCurrentDate, sGuid, "Tenant closed escrow because it was expired");\n', '\t\t\t}\n', '\t\t}\n', '\n', '\t\trequire(bProcessed);\n', '\t\tif (state > 0)\n', '\t\t{\n', '\t\t\tBaseEscrowLib.TerminateContract(self,tenantBal,landlBal,state);\n', '\t\t}\n', '\n', '    }\n', '    \n', '    function TenantMoveIn(BaseEscrowLib.EscrowContractState storage self) public\n', '    {\n', '\t\tint nCurrentStage = BaseEscrowLib.GetCurrentStage(self);\n', '\t\tuint nCurrentDate = BaseEscrowLib.GetCurrentDate(self);\n', '\t\tint nActualBalance = int(BaseEscrowLib.GetContractBalance(self));\n', '\t\tstring memory sGuid;\n', '        sGuid = self._Guid;\n', '\t\t\t\t\n', '\t\trequire(nCurrentStage == BaseEscrowLib.GetContractStagePreMoveIn() && nActualBalance >= self._TotalAmount && \n', '\t\t\t\tDateTime.compareDateTimesForContract(nCurrentDate, self._MoveInDate) >= 0);\n', '\n', '        BaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageInfo(), nCurrentDate, sGuid, "Tenant signaled move-in");\n', '\n', '\t\tself._TenantConfirmedMoveIn = true;\n', '    } \n', '\t       \n', '    function TenantTerminateMisrep(BaseEscrowLib.EscrowContractState storage self) public\n', '    {\n', '\t\tint nCurrentStage = BaseEscrowLib.GetCurrentStage(self);\n', '\t\tuint nCurrentDate = BaseEscrowLib.GetCurrentDate(self);\n', '\t\tint nActualBalance = int(BaseEscrowLib.GetContractBalance(self));\n', '\t\tint tenantBal = 0;\n', '\t\tint landlBal = 0;\n', '        string memory sGuid;\n', '        sGuid = self._Guid;\n', '\n', '\t\trequire(nCurrentStage == BaseEscrowLib.GetContractStagePreMoveIn() && nActualBalance >= self._RentPerDay && \n', '\t\t\t\tDateTime.compareDateTimesForContract(nCurrentDate, self._MoveInDate) == 0);\n', '\n', '\t\t(tenantBal, landlBal) = BaseEscrowLib.splitBalanceAccordingToRatings(self._RentPerDay,0,0);\n', '\t\t\t\t\t\n', '\t\ttenantBal = nActualBalance - landlBal;\n', '\t\t\n', '\t\tBaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageWarning(), nCurrentDate, sGuid, "Tenant signaled misrepresentation and terminated escrow!");\n', '\t\tself._MisrepSignaled = true;\n', '\n', '\t\tBaseEscrowLib.TerminateContract(self,tenantBal,landlBal,BaseEscrowLib.GetContractStateTerminatedMisrep());\t         \n', '    }    \n', '\t\n', '\tfunction LandlordTerminate(BaseEscrowLib.EscrowContractState storage self, uint SecDeposit) public\n', '\t{\n', '\t\tint nCurrentStage = BaseEscrowLib.GetCurrentStage(self);\n', '\t\tuint nCurrentDate = BaseEscrowLib.GetCurrentDate(self);\n', '\t\tint nActualBalance = int(BaseEscrowLib.GetContractBalance(self));\n', '\t\tint tenantBal = 0;\n', '\t\tint landlBal = 0;\n', '\t\tint state = 0; \n', '\t\tbool bProcessed = false;\n', '\t\tint nPotentialBillableDays = 0;\n', '        string memory sGuid;\n', '        sGuid = self._Guid;\n', '\n', '\t\tif (nActualBalance == 0)\n', '\t\t{\n', '\t\t\t//If contract is unfunded, just cancel it\n', '\t\t\tstate = BaseEscrowLib.GetContractStateCancelledByLandlord();\n', '\t\t\tbProcessed = true;\t\t\t\n', '\t\t}\n', '\t\telse if (nCurrentStage == BaseEscrowLib.GetContractStagePreMoveIn())\n', '\t\t{\t\n', '\t\t\tif (DateTime.compareDateTimesForContract(nCurrentDate, self._MoveInDate) > 0 && \n', '\t\t\t\t!self._TenantConfirmedMoveIn)\n', '\t\t\t{\n', '\t\t\t\t//Landlord gets cancell fee if tenant did not signal anything after move in date\n', '\t\t\t\ttenantBal = nActualBalance - self._RentPerDay;\t\n', '\t\t\t\tlandlBal = self._RentPerDay;\n', '\t\t\t\tstate = BaseEscrowLib.GetContractStateCancelledByLandlord();\n', '\t\t\t\tbProcessed = true;\n', '\t\t\t\tBaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageWarning(), nCurrentDate, sGuid, "Landlord cancelled escrow. Tenant did not show up and will pay cancellation fee.");\t\t\t\t\t\t\t\t\n', '\t\t\t}\n', '\t\t\telse\n', '\t\t\t{\t\t        \t\t\t\t\n', '\t\t\t\t//No cancel fee\n', '\t\t\t\ttenantBal = nActualBalance;\n', '\t\t\t\tlandlBal = 0;\n', '\t\t\t\tstate = BaseEscrowLib.GetContractStateCancelledByLandlord();\n', '\t\t\t\tbProcessed = true;\n', '\t\t\t\tBaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageInfo(), nCurrentDate, sGuid, "Landlord cancelled esqrow");\t\t\t\t\t\t\t\t\n', '\t\t\t}\n', '\t\t}\n', '\t\telse if (nCurrentStage == BaseEscrowLib.GetContractStageLiving())\n', '\t\t{\n', '\t\t\tnPotentialBillableDays = (int)(nCurrentDate - self._MoveInDate) / (60 * 60 * 24);\n', '\t\t\t\n', '\t\t\tif (self._ActualMoveOutDate == 0)\n', '\t\t\t{\n', '\t\t\t\t//If landlord initiates it, he cannot claim sec deposit\n', '\t\t\t\trequire(nActualBalance >= nPotentialBillableDays * self._RentPerDay);\n', '\t\t\t\tstate = BaseEscrowLib.GetContractStateEarlyTerminatedByLandlord();\n', '\t\t\t\tlandlBal = nPotentialBillableDays * self._RentPerDay;\n', '\t\t\t\ttenantBal = nActualBalance - landlBal;\n', '\t\t\t\tbProcessed = true;\n', '\t\t\t\tBaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageInfo(), nCurrentDate, sGuid, "Landlord signaled early move-out");\n', '\t\t\t}\n', '\t\t\telse{\n', '\t\t\t\t//If tenant initiates it, landlord can claim sec deposit, and tenant pays for one extra day\n', '\t\t\t\trequire(int(SecDeposit) <= self._SecDeposit && nActualBalance >= (nPotentialBillableDays + 1) * self._RentPerDay + int(SecDeposit));\n', '\t\t\t\t\n', '\t\t\t\tif (SecDeposit == 0)\n', '\t\t\t\t{\n', '\t\t\t\t\tstate = BaseEscrowLib.GetContractStateEarlyTerminatedByTenant();\n', '\t\t\t\t}\n', '\t\t\t\telse\n', '\t\t\t\t{\n', '\t\t\t\t\tBaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageInfo(), nCurrentDate, sGuid, "Landlord signaled Security Deposit");\n', '\t\t\t\t\tstate = BaseEscrowLib.GetContractStateEarlyTerminatedByTenantSecDep();\n', '\t\t\t\t}\n', '\n', '\t\t\t\tlandlBal = (nPotentialBillableDays + 1) * self._RentPerDay + int(SecDeposit);\n', '\t\t\t\ttenantBal = nActualBalance - landlBal;\n', '\t\t\t\tbProcessed = true;\n', '\t\t\t}\n', '\t\t}\n', '\t\telse if (nCurrentStage == BaseEscrowLib.GetContractStageTermination())\n', '\t\t{\n', '\t\t\tnPotentialBillableDays = (int)(self._MoveOutDate - self._MoveInDate) / (60 * 60 * 24);\n', '\t\t\trequire(int(SecDeposit) <= self._SecDeposit && nActualBalance >= nPotentialBillableDays * self._RentPerDay + int(SecDeposit));\n', '\t\t\tif (SecDeposit == 0)\n', '\t\t\t{\n', '\t\t\t\tstate = BaseEscrowLib.GetContractStateTerminatedOK();\n', '\t\t\t}\n', '\t\t\telse\n', '\t\t\t{\n', '\t\t\t\tBaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageInfo(), nCurrentDate, sGuid, "Landlord signaled Security Deposit");\n', '\t\t\t\tstate = BaseEscrowLib.GetContractStateTerminatedSecDep();\n', '\t\t\t}\n', '\t\t\tlandlBal = nPotentialBillableDays * self._RentPerDay + int(SecDeposit);\n', '\t\t\ttenantBal = nActualBalance - landlBal;\n', '\t\t\tbProcessed = true;\n', '\t\t}\n', '\n', '\t\trequire(bProcessed);\n', '\t\tif (state > 0)\n', '\t\t{\n', '\t\t\tBaseEscrowLib.TerminateContract(self,tenantBal,landlBal,state);\n', '\t\t}\t\n', '\t}\n', '}\n', '\n', 'library ModerateEscrowLib\n', '{\n', '\tusing BaseEscrowLib for BaseEscrowLib.EscrowContractState;\n', '\n', '    //Cancel days\n', '\tint internal constant FreeCancelBeforeMoveInDays = 30;\n', '\n', '\t//Expiration\n', '\tint internal constant ExpireAfterMoveOutDays = 14;\n', '\t\t    \n', '    \n', '\tfunction TenantTerminate(BaseEscrowLib.EscrowContractState storage self) public\n', '    {\n', '\t\tint nCurrentStage = BaseEscrowLib.GetCurrentStage(self);\n', '\t\tuint nCurrentDate = BaseEscrowLib.GetCurrentDate(self);\n', '\t\tint nActualBalance = int(BaseEscrowLib.GetContractBalance(self));\n', '\t\tint tenantBal = 0;\n', '\t\tint landlBal = 0;\n', '\t\tint state = 0; \n', '\t\tbool bProcessed = false;\n', '        string memory sGuid;\n', '        sGuid = self._Guid;\n', '\n', '\t\tif (nActualBalance == 0)\n', '\t\t{\n', '\t\t\t//If contract is unfunded, just cancel it\n', '\t\t\tstate = BaseEscrowLib.GetContractStateCancelledByTenant();\n', '\t\t\tbProcessed = true;\t\t\t\n', '\t\t}\n', '\t\telse if (nCurrentStage == BaseEscrowLib.GetContractStagePreMoveIn())\n', '\t\t{\t\t\t\n', '\t\t\tint nDaysBeforeMoveIn = (int)(self._MoveInDate - nCurrentDate) / (60 * 60 * 24);\n', '\t\t\tif (nDaysBeforeMoveIn < FreeCancelBeforeMoveInDays)\n', '\t\t\t{\n', '\t\t\t\t//Pay cancel fee\n', '\t\t\t\t//Contract must be fully funded\n', '\n', '\t\t\t\tint cancelFee = (self._TotalAmount - self._SecDeposit) / 2;\n', '\n', '\t\t\t\trequire(cancelFee <= nActualBalance);\n', '\n', '\t\t\t\t//Cancellation fee is half of the rent to pay\n', '\t\t\t\ttenantBal = nActualBalance - cancelFee;\n', '\t\t\t\tlandlBal = cancelFee;\n', '\t\t\t\tstate = BaseEscrowLib.GetContractStateCancelledByTenant();\n', '\t\t\t\tbProcessed = true;\n', '\n', '\t\t\t\tBaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageWarning(), nCurrentDate, sGuid, "Tenant cancelled escrow. Cancellation fee will be withheld from tenant.");\t\t\t\t\t\t\t\t\t\t\n', '\t\t\t}\n', '\t\t\telse\n', '\t\t\t{\n', '\t\t\t\t//No cancel fee\n', '\t\t\t\ttenantBal = nActualBalance;\n', '\t\t\t\tlandlBal = 0;\n', '\t\t\t\tstate = BaseEscrowLib.GetContractStateCancelledByTenant();\n', '\t\t\t\tbProcessed = true;\n', '\n', '\t\t\t\tBaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageWarning(), nCurrentDate, sGuid, "Tenant cancelled escrow.");\n', '\t\t\t}\t\t\t\t\t\n', '\t\t}\n', '\t\telse if (nCurrentStage == BaseEscrowLib.GetContractStageLiving())\n', '\t\t{\n', '\t\t\tstate = 0;\n', '\t\t\tself._ActualMoveOutDate = nCurrentDate;\n', '\t\t\tbProcessed = true;\n', '\t\t\t//In this case landlord will close escrow\n', '\n', '\t\t\tBaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageWarning(), nCurrentDate, sGuid, "Tenant signaled early move-out");\n', '\t\t}\n', '\t\telse if (nCurrentStage == BaseEscrowLib.GetContractStageTermination())\n', '\t\t{\n', '\t\t\t//If landlord did not close the escrow, and if it is expired, tenant may only pay for rent without sec deposit\n', '\t\t\tint nDaysAfterMoveOut = (int)(nCurrentDate - self._MoveOutDate) / (60 * 60 * 24);\n', '\n', '\t\t\tif (nDaysAfterMoveOut > ExpireAfterMoveOutDays)\n', '\t\t\t{\n', '\t\t\t\tint nPotentialBillableDays = (int)(self._MoveOutDate - self._MoveInDate) / (60 * 60 * 24);\n', '\t\t\t\trequire(self._RentPerDay * nPotentialBillableDays <= nActualBalance);\n', '\n', '\t\t\t\tlandlBal = self._RentPerDay * nPotentialBillableDays;\n', '\t\t\t\ttenantBal = nActualBalance - landlBal;\n', '\t\t\t\tbProcessed = true;\n', '\t\t\t\tstate = BaseEscrowLib.GetContractStateTerminatedOK();\n', '\n', '\t\t\t\tBaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageInfo(), nCurrentDate, sGuid, "Tenant closed escrow because it was expired");\n', '\t\t\t}\n', '\t\t}\n', '\n', '\t\trequire(bProcessed);\n', '\t\tif (state > 0)\n', '\t\t{\n', '\t\t\tBaseEscrowLib.TerminateContract(self,tenantBal,landlBal,state);\n', '\t\t}\n', '\n', '    }\n', '    \n', '    function TenantMoveIn(BaseEscrowLib.EscrowContractState storage self) public\n', '    {\n', '\t\tint nCurrentStage = BaseEscrowLib.GetCurrentStage(self);\n', '\t\tuint nCurrentDate = BaseEscrowLib.GetCurrentDate(self);\n', '\t\tint nActualBalance = int(BaseEscrowLib.GetContractBalance(self));\n', '        string memory sGuid;\n', '        sGuid = self._Guid;\n', '\t\t\t\t\n', '\t\trequire(nCurrentStage == BaseEscrowLib.GetContractStagePreMoveIn() && nActualBalance >= self._TotalAmount && \n', '\t\t\t\tDateTime.compareDateTimesForContract(nCurrentDate, self._MoveInDate) >= 0);\n', '\n', '        BaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageInfo(), nCurrentDate, sGuid, "Tenant signaled move-in");\n', '\n', '\t\tself._TenantConfirmedMoveIn = true;\n', '    } \n', '\t       \n', '    function TenantTerminateMisrep(BaseEscrowLib.EscrowContractState storage self) public\n', '    {\n', '\t\tint nCurrentStage = BaseEscrowLib.GetCurrentStage(self);\n', '\t\tuint nCurrentDate = BaseEscrowLib.GetCurrentDate(self);\n', '\t\tint nActualBalance = int(BaseEscrowLib.GetContractBalance(self));\n', '\t\tint tenantBal = 0;\n', '\t\tint landlBal = 0;\n', '\t\tint cancelFee = (self._TotalAmount - self._SecDeposit) / 2;\n', '        string memory sGuid;\n', '        sGuid = self._Guid;\n', '\n', '\t\trequire(nCurrentStage == BaseEscrowLib.GetContractStagePreMoveIn() && nActualBalance >= cancelFee && \n', '\t\t\t\tDateTime.compareDateTimesForContract(nCurrentDate, self._MoveInDate) == 0);\n', '\n', '\t\t(tenantBal, landlBal) = BaseEscrowLib.splitBalanceAccordingToRatings(cancelFee,0,0);\n', '\t\t\t\t\t\n', '\t\ttenantBal = nActualBalance - landlBal;\n', '\t\t\n', '\t\tBaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageWarning(), nCurrentDate, sGuid, "Tenant signaled misrepresentation and terminated escrow!");\n', '\t\tself._MisrepSignaled = true;\n', '\n', '\t\tBaseEscrowLib.TerminateContract(self,tenantBal,landlBal,BaseEscrowLib.GetContractStateTerminatedMisrep());\t         \n', '    }    \n', '\t\n', '\tfunction LandlordTerminate(BaseEscrowLib.EscrowContractState storage self, uint SecDeposit) public\n', '\t{\n', '\t\t//int nCurrentStage = BaseEscrowLib.GetCurrentStage(self);\n', '\t\tuint nCurrentDate = BaseEscrowLib.GetCurrentDate(self);\n', '\t\tint nActualBalance = int(BaseEscrowLib.GetContractBalance(self));\n', '\t\tint tenantBal = 0;\n', '\t\tint landlBal = 0;\n', '\t\tint state = 0; \n', '\t\tbool bProcessed = false;\n', '\t\tint nPotentialBillableDays = 0;\n', '\t\tint cancelFee = (self._TotalAmount - self._SecDeposit) / 2;\n', '        string memory sGuid;\n', '        sGuid = self._Guid;\n', '\n', '\t\tif (nActualBalance == 0)\n', '\t\t{\n', '\t\t\t//If contract is unfunded, just cancel it\n', '\t\t\tstate = BaseEscrowLib.GetContractStateCancelledByLandlord();\n', '\t\t\tbProcessed = true;\t\t\t\n', '\t\t}\n', '\t\telse if (BaseEscrowLib.GetCurrentStage(self) == BaseEscrowLib.GetContractStagePreMoveIn())\n', '\t\t{\t\n', '\t\t\tif (DateTime.compareDateTimesForContract(nCurrentDate, self._MoveInDate) > 0 && \n', '\t\t\t\t!self._TenantConfirmedMoveIn)\n', '\t\t\t{\n', '\t\t\t\t//Landlord gets cancell fee if tenant did not signal anything after move in date\n', '\t\t\t\ttenantBal = nActualBalance - cancelFee;\t\n', '\t\t\t\tlandlBal = cancelFee;\n', '\t\t\t\tstate = BaseEscrowLib.GetContractStateCancelledByLandlord();\n', '\t\t\t\tbProcessed = true;\n', '\t\t\t\tBaseEscrowLib.ContractLogEvent(BaseEscrowLib.GetCurrentStage(self), BaseEscrowLib.GetLogMessageWarning(), nCurrentDate, sGuid, "Landlord cancelled escrow. Tenant did not show up and will pay cancellation fee.");\t\t\t\t\t\t\t\t\n', '\t\t\t}\n', '\t\t\telse\n', '\t\t\t{\t\t        \t\t\t\t\n', '\t\t\t\t//No cancel fee\n', '\t\t\t\ttenantBal = nActualBalance;\n', '\t\t\t\tlandlBal = 0;\n', '\t\t\t\tstate = BaseEscrowLib.GetContractStateCancelledByLandlord();\n', '\t\t\t\tbProcessed = true;\n', '\t\t\t\tBaseEscrowLib.ContractLogEvent(BaseEscrowLib.GetCurrentStage(self), BaseEscrowLib.GetLogMessageInfo(), nCurrentDate, sGuid, "Landlord cancelled esqrow");\t\t\t\t\t\t\t\t\n', '\t\t\t}\n', '\t\t}\n', '\t\telse if (BaseEscrowLib.GetCurrentStage(self) == BaseEscrowLib.GetContractStageLiving())\n', '\t\t{\n', '\t\t\tnPotentialBillableDays = (int)(nCurrentDate - self._MoveInDate) / (60 * 60 * 24);\n', '\t\t\t\n', '\t\t\tif (self._ActualMoveOutDate == 0)\n', '\t\t\t{\n', '\t\t\t\t//If landlord initiates it, he cannot claim sec deposit\n', '\t\t\t\trequire(nActualBalance >= nPotentialBillableDays * self._RentPerDay);\n', '\t\t\t\tstate = BaseEscrowLib.GetContractStateEarlyTerminatedByLandlord();\n', '\t\t\t\tlandlBal = nPotentialBillableDays * self._RentPerDay;\n', '\t\t\t\ttenantBal = nActualBalance - landlBal;\n', '\t\t\t\tbProcessed = true;\n', '\t\t\t\tBaseEscrowLib.ContractLogEvent(BaseEscrowLib.GetCurrentStage(self), BaseEscrowLib.GetLogMessageInfo(), nCurrentDate, sGuid, "Landlord signaled early move-out");\n', '\t\t\t}\n', '\t\t\telse{\n', '\t\t\t\t//If tenant initiates it, landlord can claim sec deposit, and tenant pays cancellation fee\n', '\t\t\t\tint nContractBillableDays = (int)(self._MoveOutDate - self._MoveInDate) / (60 * 60 * 24);\n', '\t\t\t\tcancelFee = (nContractBillableDays - nPotentialBillableDays) * self._RentPerDay / 2;\n', '\n', '\t\t\t\trequire(int(SecDeposit) <= self._SecDeposit && nActualBalance >= (nPotentialBillableDays * self._RentPerDay + int(SecDeposit) + cancelFee));\n', '\t\t\t\t\n', '\t\t\t\tif (SecDeposit == 0)\n', '\t\t\t\t{\n', '\t\t\t\t\tstate = BaseEscrowLib.GetContractStateEarlyTerminatedByTenant();\n', '\t\t\t\t}\n', '\t\t\t\telse\n', '\t\t\t\t{\n', '\t\t\t\t\tBaseEscrowLib.ContractLogEvent(BaseEscrowLib.GetCurrentStage(self), BaseEscrowLib.GetLogMessageInfo(), nCurrentDate, sGuid, "Landlord signaled Security Deposit");\n', '\t\t\t\t\tstate = BaseEscrowLib.GetContractStateEarlyTerminatedByTenantSecDep();\n', '\t\t\t\t}\n', '\n', '\t\t\t\tlandlBal = nPotentialBillableDays * self._RentPerDay + int(SecDeposit) + cancelFee;\n', '\t\t\t\ttenantBal = nActualBalance - landlBal;\n', '\t\t\t\tbProcessed = true;\n', '\t\t\t}\n', '\t\t}\n', '\t\telse if (BaseEscrowLib.GetCurrentStage(self) == BaseEscrowLib.GetContractStageTermination())\n', '\t\t{\n', '\t\t\tnPotentialBillableDays = (int)(self._MoveOutDate - self._MoveInDate) / (60 * 60 * 24);\n', '\t\t\trequire(int(SecDeposit) <= self._SecDeposit && nActualBalance >= nPotentialBillableDays * self._RentPerDay + int(SecDeposit));\n', '\t\t\tif (SecDeposit == 0)\n', '\t\t\t{\n', '\t\t\t\tstate = BaseEscrowLib.GetContractStateTerminatedOK();\n', '\t\t\t}\n', '\t\t\telse\n', '\t\t\t{\n', '\t\t\t\tBaseEscrowLib.ContractLogEvent(BaseEscrowLib.GetCurrentStage(self), BaseEscrowLib.GetLogMessageInfo(), nCurrentDate, sGuid, "Landlord signaled Security Deposit");\n', '\t\t\t\tstate = BaseEscrowLib.GetContractStateTerminatedSecDep();\n', '\t\t\t}\n', '\t\t\tlandlBal = nPotentialBillableDays * self._RentPerDay + int(SecDeposit);\n', '\t\t\ttenantBal = nActualBalance - landlBal;\n', '\t\t\tbProcessed = true;\n', '\t\t}\n', '\n', '\t\trequire(bProcessed);\n', '\t\tif (state > 0)\n', '\t\t{\n', '\t\t\tBaseEscrowLib.TerminateContract(self,tenantBal,landlBal,state);\n', '\t\t}\t\n', '\t}\n', '}\n', '\n', 'library StrictEscrowLib\n', '{\n', '\tusing BaseEscrowLib for BaseEscrowLib.EscrowContractState;\n', '\n', '    //Cancel days\n', '\tint internal constant FreeCancelBeforeMoveInDays = 60;\n', '\n', '\t//Expiration\n', '\tint internal constant ExpireAfterMoveOutDays = 14;\n', '\t\t    \n', '    \n', '\tfunction TenantTerminate(BaseEscrowLib.EscrowContractState storage self) public\n', '    {\n', '\t\tint nCurrentStage = BaseEscrowLib.GetCurrentStage(self);\n', '\t\tuint nCurrentDate = BaseEscrowLib.GetCurrentDate(self);\n', '\t\tint nActualBalance = int(BaseEscrowLib.GetContractBalance(self));\n', '\t\tint tenantBal = 0;\n', '\t\tint landlBal = 0;\n', '\t\tint state = 0; \n', '\t\tbool bProcessed = false;\n', '        string memory sGuid;\n', '        sGuid = self._Guid;\n', '\n', '\n', '\t\tif (nActualBalance == 0)\n', '\t\t{\n', '\t\t\t//If contract is unfunded, just cancel it\n', '\t\t\tstate = BaseEscrowLib.GetContractStateCancelledByTenant();\n', '\t\t\tbProcessed = true;\t\t\t\n', '\t\t}\n', '\t\telse if (nCurrentStage == BaseEscrowLib.GetContractStagePreMoveIn())\n', '\t\t{\t\t\t\n', '\t\t\tint nDaysBeforeMoveIn = (int)(self._MoveInDate - nCurrentDate) / (60 * 60 * 24);\n', '\t\t\tif (nDaysBeforeMoveIn < FreeCancelBeforeMoveInDays)\n', '\t\t\t{\n', '\t\t\t\t//Pay cancel fee\n', '\t\t\t\tint cancelFee = self._TotalAmount - self._SecDeposit;\n', '\n', '\t\t\t\t//Contract must be fully funded\n', '\t\t\t\trequire(cancelFee <= nActualBalance);\n', '\n', '\t\t\t\t//Cancel fee is the whole rent\n', '\t\t\t\ttenantBal = nActualBalance - cancelFee;\n', '\t\t\t\tlandlBal = cancelFee;\n', '\t\t\t\tstate = BaseEscrowLib.GetContractStateCancelledByTenant();\n', '\t\t\t\tbProcessed = true;\n', '\n', '\t\t\t\tBaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageWarning(), nCurrentDate, sGuid, "Tenant cancelled escrow. Cancellation fee will be withheld from tenant.");\t\t\t\t\t\t\t\t\t\t\n', '\t\t\t}\n', '\t\t\telse\n', '\t\t\t{\n', '\t\t\t\t//No cancel fee\n', '\t\t\t\ttenantBal = nActualBalance;\n', '\t\t\t\tlandlBal = 0;\n', '\t\t\t\tstate = BaseEscrowLib.GetContractStateCancelledByTenant();\n', '\t\t\t\tbProcessed = true;\n', '\n', '\t\t\t\tBaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageWarning(), nCurrentDate, sGuid, "Tenant cancelled escrow.");\n', '\t\t\t}\t\t\t\t\t\n', '\t\t}\n', '\t\telse if (nCurrentStage == BaseEscrowLib.GetContractStageTermination())\n', '\t\t{\n', '\t\t\t//If landlord did not close the escrow, and if it is expired, tenant may only pay for rent without sec deposit\n', '\t\t\tint nDaysAfterMoveOut = (int)(nCurrentDate - self._MoveOutDate) / (60 * 60 * 24);\n', '\n', '\t\t\tif (nDaysAfterMoveOut > ExpireAfterMoveOutDays)\n', '\t\t\t{\n', '\t\t\t\tint nPotentialBillableDays = (int)(self._MoveOutDate - self._MoveInDate) / (60 * 60 * 24);\n', '\t\t\t\trequire(self._RentPerDay * nPotentialBillableDays <= nActualBalance);\n', '\n', '\t\t\t\tlandlBal = self._RentPerDay * nPotentialBillableDays;\n', '\t\t\t\ttenantBal = nActualBalance - landlBal;\n', '\t\t\t\tbProcessed = true;\n', '\t\t\t\tstate = BaseEscrowLib.GetContractStateTerminatedOK();\n', '\n', '\t\t\t\tBaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageInfo(), nCurrentDate, sGuid, "Tenant closed escrow because it was expired");\n', '\t\t\t}\n', '\t\t}\n', '\n', '\t\trequire(bProcessed);\n', '\t\tif (state > 0)\n', '\t\t{\n', '\t\t\tBaseEscrowLib.TerminateContract(self,tenantBal,landlBal,state);\n', '\t\t}\n', '    }\n', '    \n', '    function TenantMoveIn(BaseEscrowLib.EscrowContractState storage self) public\n', '    {\n', '\t\tint nCurrentStage = BaseEscrowLib.GetCurrentStage(self);\n', '\t\tuint nCurrentDate = BaseEscrowLib.GetCurrentDate(self);\n', '\t\tint nActualBalance = int(BaseEscrowLib.GetContractBalance(self));\n', '        string memory sGuid;\n', '        sGuid = self._Guid;\n', '\n', '\t\t\t\t\n', '\t\trequire(nCurrentStage == BaseEscrowLib.GetContractStagePreMoveIn() && nActualBalance >= self._TotalAmount && \n', '\t\t\t\tDateTime.compareDateTimesForContract(nCurrentDate, self._MoveInDate) >= 0);\n', '\n', '        BaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageInfo(), nCurrentDate, sGuid, "Tenant signaled move-in");\n', '\n', '\t\tself._TenantConfirmedMoveIn = true;\n', '    } \n', '\t       \n', '    function TenantTerminateMisrep(BaseEscrowLib.EscrowContractState storage self) public\n', '    {\n', '\t\tint nCurrentStage = BaseEscrowLib.GetCurrentStage(self);\n', '\t\tuint nCurrentDate = BaseEscrowLib.GetCurrentDate(self);\n', '\t\tint nActualBalance = int(BaseEscrowLib.GetContractBalance(self));\n', '\t\tint tenantBal = 0;\n', '\t\tint landlBal = 0;\n', '\t\tint cancelFee = self._TotalAmount - self._SecDeposit;\n', '        string memory sGuid;\n', '        sGuid = self._Guid;\n', '\n', '\t\trequire(nCurrentStage == BaseEscrowLib.GetContractStagePreMoveIn() && nActualBalance >= cancelFee && \n', '\t\t\t\tDateTime.compareDateTimesForContract(nCurrentDate, self._MoveInDate) == 0);\n', '\t\t\n', '\t\t//For strict escrow, give everything to landl\n', '\t\tlandlBal = cancelFee;\t\t\t\n', '\t\ttenantBal = nActualBalance - landlBal;\n', '\t\t\n', '\t\tBaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageWarning(), nCurrentDate, sGuid, "Tenant signaled misrepresentation and terminated escrow!");\n', '\t\tself._MisrepSignaled = true;\n', '\n', '\t\tBaseEscrowLib.TerminateContract(self,tenantBal,landlBal,BaseEscrowLib.GetContractStateTerminatedMisrep());    \n', '\t}    \n', '\t\n', '\tfunction LandlordTerminate(BaseEscrowLib.EscrowContractState storage self, uint SecDeposit) public\n', '\t{\n', '\t\tint nCurrentStage = BaseEscrowLib.GetCurrentStage(self);\n', '\t\tuint nCurrentDate = BaseEscrowLib.GetCurrentDate(self);\n', '\t\tint nActualBalance = int(BaseEscrowLib.GetContractBalance(self));\n', '\t\tint tenantBal = 0;\n', '\t\tint landlBal = 0;\n', '\t\tint state = 0; \n', '\t\tbool bProcessed = false;\n', '\t\tint nPotentialBillableDays = 0;\n', '\t\tint cancelFee = self._TotalAmount - self._SecDeposit;\n', '        string memory sGuid;\n', '        sGuid = self._Guid;\n', '\n', '\t\tif (nActualBalance == 0)\n', '\t\t{\n', '\t\t\t//If contract is unfunded, just cancel it\n', '\t\t\tstate = BaseEscrowLib.GetContractStateCancelledByLandlord();\n', '\t\t\tbProcessed = true;\t\t\t\n', '\t\t}\n', '\t\telse if (nCurrentStage == BaseEscrowLib.GetContractStagePreMoveIn())\n', '\t\t{\t\n', '\t\t\tif (DateTime.compareDateTimesForContract(nCurrentDate, self._MoveInDate) > 0 && \n', '\t\t\t\t!self._TenantConfirmedMoveIn)\n', '\t\t\t{\n', '\t\t\t\t//Landlord gets cancell fee if tenant did not signal anything after move in date\n', '\t\t\t\ttenantBal = nActualBalance - cancelFee;\t\n', '\t\t\t\tlandlBal = cancelFee;\n', '\t\t\t\tstate = BaseEscrowLib.GetContractStateCancelledByLandlord();\n', '\t\t\t\tbProcessed = true;\n', '\t\t\t\tBaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageWarning(), nCurrentDate, sGuid, "Landlord cancelled escrow. Tenant did not show up and will pay cancellation fee.");\t\t\t\t\t\t\t\t\n', '\t\t\t}\n', '\t\t\telse\n', '\t\t\t{\t\t        \t\t\t\t\n', '\t\t\t\t//No cancel fee\n', '\t\t\t\ttenantBal = nActualBalance;\n', '\t\t\t\tlandlBal = 0;\n', '\t\t\t\tstate = BaseEscrowLib.GetContractStateCancelledByLandlord();\n', '\t\t\t\tbProcessed = true;\n', '\t\t\t\tBaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageInfo(), nCurrentDate, sGuid, "Landlord cancelled esqrow");\t\t\t\t\t\t\t\t\n', '\t\t\t}\n', '\t\t}\n', '\t\telse if (nCurrentStage == BaseEscrowLib.GetContractStageLiving())\n', '\t\t{\n', '\t\t\tnPotentialBillableDays = (int)(self._MoveOutDate - self._MoveInDate) / (60 * 60 * 24);\n', '\t\t\t\n', '\n', '\t\t\t//If landlord initiates it, he cannot claim sec deposit\n', '\t\t\trequire(nActualBalance >= nPotentialBillableDays * self._RentPerDay);\n', '\t\t\tstate = BaseEscrowLib.GetContractStateEarlyTerminatedByLandlord();\n', '\t\t\tlandlBal = nPotentialBillableDays * self._RentPerDay;\n', '\t\t\ttenantBal = nActualBalance - landlBal;\n', '\t\t\tbProcessed = true;\n', '\t\t\tBaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageInfo(), nCurrentDate, sGuid, "Landlord signaled early move-out");\t\t\t\n', '\t\t}\n', '\t\telse if (nCurrentStage == BaseEscrowLib.GetContractStageTermination())\n', '\t\t{\n', '\t\t\tnPotentialBillableDays = (int)(self._MoveOutDate - self._MoveInDate) / (60 * 60 * 24);\n', '\t\t\trequire(int(SecDeposit) <= self._SecDeposit && nActualBalance >= nPotentialBillableDays * self._RentPerDay + int(SecDeposit));\n', '\t\t\tif (SecDeposit == 0)\n', '\t\t\t{\n', '\t\t\t\tstate = BaseEscrowLib.GetContractStateTerminatedOK();\n', '\t\t\t}\n', '\t\t\telse\n', '\t\t\t{\n', '\t\t\t\tBaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageInfo(), nCurrentDate, sGuid, "Landlord signaled Security Deposit");\n', '\t\t\t\tstate = BaseEscrowLib.GetContractStateTerminatedSecDep();\n', '\t\t\t}\n', '\t\t\tlandlBal = nPotentialBillableDays * self._RentPerDay + int(SecDeposit);\n', '\t\t\ttenantBal = nActualBalance - landlBal;\n', '\t\t\tbProcessed = true;\n', '\t\t}\n', '\n', '\t\trequire(bProcessed);\n', '\t\tif (state > 0)\n', '\t\t{\n', '\t\t\tBaseEscrowLib.TerminateContract(self,tenantBal,landlBal,state);\n', '\t\t}\t\n', '\t}\n', '}\n', '\n', '/**\n', ' * @title Ownable\n', ' * @dev The Ownable contract has an owner address, and provides basic authorization control\n', ' * functions, this simplifies the implementation of "user permissions".\n', ' */\n', 'contract Ownable {\n', '  address private owner_;\n', '\n', '  \n', '  event OwnershipTransferred(\n', '    address indexed previousOwner,\n', '    address indexed newOwner\n', '  );\n', '\n', '\n', '  /**\n', '   * @dev The Ownable constructor sets the original `owner` of the contract to the sender\n', '   * account.\n', '   */\n', '  function Ownable() public {\n', '    owner_ = msg.sender;\n', '  }\n', '\n', '  /**\n', '   * @return the address of the owner.\n', '   */\n', '  function owner() public constant returns(address) {\n', '    return owner_;\n', '  }\n', '\n', '  /**\n', '   * @dev Throws if called by any account other than the owner.\n', '   */\n', '  modifier onlyOwner() {\n', '    require(msg.sender == owner_);\n', '    _;\n', '  }\n', '\n', '\n', '  /**\n', '   * @dev Allows the current owner to transfer control of the contract to a newOwner.\n', '   * @param _newOwner The address to transfer ownership to.\n', '   */\n', '  function transferOwnership(address _newOwner) public onlyOwner {\n', '    _transferOwnership(_newOwner);\n', '  }\n', '\n', '  /**\n', '   * @dev Transfers control of the contract to a newOwner.\n', '   * @param _newOwner The address to transfer ownership to.\n', '   */\n', '  function _transferOwnership(address _newOwner) internal {\n', '    require(_newOwner != address(0));\n', '    OwnershipTransferred(owner_, _newOwner);\n', '    owner_ = _newOwner;\n', '  }\n', '}\n', '\n', 'contract StayBitContractFactory is Ownable\n', '{\n', '    struct EscrowTokenInfo { \n', '\t\tuint _RentMin;  //Min value for rent per day\n', '\t\tuint _RentMax;  //Max value for rent per day\n', '\t\taddress _ContractAddress; //Token address\n', '\t\tuint _ContractFeeBal;  //Earned balance\n', '    }\n', '\n', '\tusing BaseEscrowLib for BaseEscrowLib.EscrowContractState;\n', '    mapping(bytes32 => BaseEscrowLib.EscrowContractState) private contracts;\n', '\tmapping(uint => EscrowTokenInfo) private supportedTokens;\n', '\tbool private CreateEnabled; // Enables / disables creation of new contracts\n', '\tbool private PercentageFee;  // true - percentage fee per contract false - fixed fee per contract\n', '\tuint ContractFee;  //Either fixed amount or percentage\n', '\t\t\n', '\tevent contractCreated(int rentPerDay, int cancelPolicy, uint moveInDate, uint moveOutDate, int secDeposit, address landlord, uint tokenId, int Id, string Guid, uint extraAmount);\n', '\tevent contractTerminated(int Id, string Guid, int State);\n', '\n', '\tfunction StayBitContractFactory()\n', '\t{\n', '\t\tCreateEnabled = true;\n', '\t\tPercentageFee = false;\n', '\t\tContractFee = 0;\n', '\t}\n', '\n', '\tfunction SetFactoryParams(bool enable, bool percFee, uint contrFee) public onlyOwner\n', '\t{\n', '\t\tCreateEnabled = enable;\t\n', '\t\tPercentageFee = percFee;\n', '\t\tContractFee = contrFee;\n', '\t}\n', '\n', '\tfunction GetFeeBalance(uint tokenId) public constant returns (uint)\n', '\t{\n', '\t\treturn supportedTokens[tokenId]._ContractFeeBal;\n', '\t}\n', '\n', '\tfunction WithdrawFeeBalance(uint tokenId, address to, uint amount) public onlyOwner\n', '\t{\t    \n', '\t\trequire(supportedTokens[tokenId]._RentMax > 0);\t\t\n', '\t\trequire(supportedTokens[tokenId]._ContractFeeBal >= amount);\t\t\n', '\t\tsupportedTokens[tokenId]._ContractFeeBal -= amount;\t\t\n', '\t\tERC20Interface tokenApi = ERC20Interface(supportedTokens[tokenId]._ContractAddress);\n', '\t\ttokenApi.transfer(to, amount);\n', '\t}\n', '\n', '\n', '\tfunction SetTokenInfo(uint tokenId, address tokenAddress, uint rentMin, uint rentMax) public onlyOwner\n', '\t{\n', '\t\tsupportedTokens[tokenId]._RentMin = rentMin;\n', '\t\tsupportedTokens[tokenId]._RentMax = rentMax;\n', '\t\tsupportedTokens[tokenId]._ContractAddress = tokenAddress;\n', '\t}\n', '\n', '\tfunction CalculateCreateFee(uint amount) public constant returns (uint)\n', '\t{\n', '\t\tuint result = 0;\n', '\t\tif (PercentageFee)\n', '\t\t{\n', '\t\t\tresult = amount * ContractFee / 100;\n', '\t\t}\n', '\t\telse\n', '\t\t{\n', '\t\t\tresult = ContractFee;\n', '\t\t}\n', '\t\treturn result;\n', '\t}\n', '\n', '\n', '    //75, 1, 1533417601, 1534281601, 100, "0x4b0897b0513fdc7c541b6d9d7e929c4e5364d2db", "", "0x4514d8d91a10bda73c10e2b8ffd99cb9646620a9", 1, "test"\n', '\tfunction CreateContract(int rentPerDay, int cancelPolicy, uint moveInDate, uint moveOutDate, int secDeposit, address landlord, string doorLockData, uint tokenId, int Id, string Guid, uint extraAmount) public\n', '\t{\n', '\t\t//It must be enabled\n', '\t\trequire (CreateEnabled && rentPerDay > 0 && secDeposit > 0 && moveInDate > 0 && moveOutDate > 0 && landlord != address(0) && landlord != msg.sender && Id > 0);\n', '\n', '\t\t//Token must be supported\n', '\t\trequire(supportedTokens[tokenId]._RentMax > 0);\n', '\n', '\t\t//Rent per day values must be within range for this token\n', '\t\trequire(supportedTokens[tokenId]._RentMin <= uint(rentPerDay) && supportedTokens[tokenId]._RentMax >= uint(rentPerDay));\n', '\n', '\t\t//Check that we support cancel policy\n', '\t\t//TESTNET\n', '\t\t//require (cancelPolicy == 1 || cancelPolicy == 2 || cancelPolicy == 3);\n', '\n', '\t\t//PRODUCTION\n', '\t\trequire (cancelPolicy == 1 || cancelPolicy == 2);\n', '\n', '\t\t//Check that GUID does not exist\t\t\n', '\t\trequire (contracts[keccak256(Guid)]._Id == 0);\n', '\n', '\t\tcontracts[keccak256(Guid)]._CurrentDate = now;\n', '\t\tcontracts[keccak256(Guid)]._CreatedDate = now;\n', '\t\tcontracts[keccak256(Guid)]._RentPerDay = rentPerDay;\n', '\t\tcontracts[keccak256(Guid)]._MoveInDate = moveInDate;\n', '\t\tcontracts[keccak256(Guid)]._MoveOutDate = moveOutDate;\n', '\t\tcontracts[keccak256(Guid)]._SecDeposit = secDeposit;\n', '\t\tcontracts[keccak256(Guid)]._DoorLockData = doorLockData;\n', '\t\tcontracts[keccak256(Guid)]._landlord = landlord;\n', '\t\tcontracts[keccak256(Guid)]._tenant = msg.sender;\n', '\t\tcontracts[keccak256(Guid)]._ContractAddress = this;\t\t\n', '\t\tcontracts[keccak256(Guid)]._tokenApi = ERC20Interface(supportedTokens[tokenId]._ContractAddress);\n', '\t\tcontracts[keccak256(Guid)]._Id = Id;\n', '\t\tcontracts[keccak256(Guid)]._Guid = Guid;\n', '\t\tcontracts[keccak256(Guid)]._CancelPolicy = cancelPolicy;\n', '\n', '\t\tcontracts[keccak256(Guid)].initialize();\n', '\n', '\t\tuint256 startBalance = contracts[keccak256(Guid)]._tokenApi.balanceOf(this);\n', '\n', '\t\t//Calculate our fees\n', '\t\tsupportedTokens[tokenId]._ContractFeeBal += CalculateCreateFee(uint(contracts[keccak256(Guid)]._TotalAmount));\n', '\n', '\t\t//Check that tenant has funds\n', '\t\trequire(extraAmount + uint(contracts[keccak256(Guid)]._TotalAmount) + CalculateCreateFee(uint(contracts[keccak256(Guid)]._TotalAmount)) <= contracts[keccak256(Guid)]._tokenApi.balanceOf(msg.sender));\n', '\n', '\t\t//Fund. Token fee, if any, will be witheld here \n', '\t\tcontracts[keccak256(Guid)]._tokenApi.transferFrom(msg.sender, this, extraAmount + uint(contracts[keccak256(Guid)]._TotalAmount) + CalculateCreateFee(uint(contracts[keccak256(Guid)]._TotalAmount)));\n', '\n', '\t\t//We need to measure balance diff because some tokens (TrueUSD) charge fees per transfer\n', '\t\tcontracts[keccak256(Guid)]._Balance = contracts[keccak256(Guid)]._tokenApi.balanceOf(this) - startBalance - CalculateCreateFee(uint(contracts[keccak256(Guid)]._TotalAmount));\n', '\n', '\t\t//Check that balance is still greater than contract&#39;s amount\n', '\t\trequire(contracts[keccak256(Guid)]._Balance >= uint(contracts[keccak256(Guid)]._TotalAmount));\n', '\n', '\t\t//raise event\n', '\t\tcontractCreated(rentPerDay, cancelPolicy, moveInDate, moveOutDate, secDeposit, landlord, tokenId, Id, Guid, extraAmount);\n', '\t}\n', '\n', '\tfunction() payable\n', '\t{\t\n', '\t\trevert();\n', '\t}\n', '\n', '\tfunction SimulateCurrentDate(uint n, string Guid) public {\n', '\t    if (contracts[keccak256(Guid)]._Id != 0)\n', '\t\t{\n', '\t\t\tcontracts[keccak256(Guid)].SimulateCurrentDate(n);\n', '\t\t}\n', '\t}\n', '\t\n', '\t\n', '\tfunction GetContractInfo(string Guid) public constant returns (uint curDate, int escrState, int escrStage, bool tenantMovedIn, uint actualBalance, bool misrepSignaled, string doorLockData, int calcAmount, uint actualMoveOutDate, int cancelPolicy)\n', '\t{\n', '\t\tif (contracts[keccak256(Guid)]._Id != 0)\n', '\t\t{\n', '\t\t\tactualBalance = contracts[keccak256(Guid)].GetContractBalance();\n', '\t\t\tcurDate = contracts[keccak256(Guid)].GetCurrentDate();\n', '\t\t\ttenantMovedIn = contracts[keccak256(Guid)]._TenantConfirmedMoveIn;\n', '\t\t\tmisrepSignaled = contracts[keccak256(Guid)]._MisrepSignaled;\n', '\t\t\tdoorLockData = contracts[keccak256(Guid)]._DoorLockData;\n', '\t\t\tescrStage = contracts[keccak256(Guid)].GetCurrentStage();\n', '\t\t\tescrState = contracts[keccak256(Guid)]._State;\n', '\t\t\tcalcAmount = contracts[keccak256(Guid)]._TotalAmount;\n', '\t\t\tactualMoveOutDate = contracts[keccak256(Guid)]._ActualMoveOutDate;\n', '\t\t\tcancelPolicy = contracts[keccak256(Guid)]._CancelPolicy;\n', '\t\t}\n', '\t}\n', '\t\t\n', '\tfunction TenantTerminate(string Guid) public\n', '\t{\n', '\t\tif (contracts[keccak256(Guid)]._Id != 0)\n', '\t\t{\n', '\t\t\trequire(contracts[keccak256(Guid)]._State == BaseEscrowLib.GetContractStateActive() && msg.sender == contracts[keccak256(Guid)]._tenant);\n', '\n', '\t\t\tif (contracts[keccak256(Guid)]._CancelPolicy == 1)\n', '\t\t\t{\n', '\t\t\t\tFlexibleEscrowLib.TenantTerminate(contracts[keccak256(Guid)]);\n', '\t\t\t}\n', '\t\t\telse if (contracts[keccak256(Guid)]._CancelPolicy == 2)\n', '\t\t\t{\n', '\t\t\t\tModerateEscrowLib.TenantTerminate(contracts[keccak256(Guid)]);\n', '\t\t\t}\n', '\t\t\telse if (contracts[keccak256(Guid)]._CancelPolicy == 3)\n', '\t\t\t{\n', '\t\t\t\tStrictEscrowLib.TenantTerminate(contracts[keccak256(Guid)]);\n', '\t\t\t}\n', '\t\t\telse{\n', '\t\t\t\trevert();\n', '\t\t\t\treturn;\n', '\t\t\t}\n', '\n', '\t\t\tSendTokens(Guid);\n', '\n', '\t\t\t//Raise event\n', '\t\t\tcontractTerminated(contracts[keccak256(Guid)]._Id, Guid, contracts[keccak256(Guid)]._State);\n', '\n', '\t\t}\n', '\t}\n', '\n', '\tfunction TenantTerminateMisrep(string Guid) public\n', '\t{\t\n', '\t\tif (contracts[keccak256(Guid)]._Id != 0)\n', '\t\t{\n', '\t\t\trequire(contracts[keccak256(Guid)]._State == BaseEscrowLib.GetContractStateActive() && msg.sender == contracts[keccak256(Guid)]._tenant);\n', '\n', '\t\t\tif (contracts[keccak256(Guid)]._CancelPolicy == 1)\n', '\t\t\t{\n', '\t\t\t\tFlexibleEscrowLib.TenantTerminateMisrep(contracts[keccak256(Guid)]);\n', '\t\t\t}\n', '\t\t\telse if (contracts[keccak256(Guid)]._CancelPolicy == 2)\n', '\t\t\t{\n', '\t\t\t\tModerateEscrowLib.TenantTerminateMisrep(contracts[keccak256(Guid)]);\n', '\t\t\t}\n', '\t\t\telse if (contracts[keccak256(Guid)]._CancelPolicy == 3)\n', '\t\t\t{\n', '\t\t\t\tStrictEscrowLib.TenantTerminateMisrep(contracts[keccak256(Guid)]);\n', '\t\t\t}\n', '\t\t\telse{\n', '\t\t\t\trevert();\n', '\t\t\t\treturn;\n', '\t\t\t}\n', '\n', '\t\t\tSendTokens(Guid);\n', '\n', '\t\t\t//Raise event\n', '\t\t\tcontractTerminated(contracts[keccak256(Guid)]._Id, Guid, contracts[keccak256(Guid)]._State);\n', '\t\t}\n', '\t}\n', '    \n', '\tfunction TenantMoveIn(string Guid) public\n', '\t{\t\n', '\t\tif (contracts[keccak256(Guid)]._Id != 0)\n', '\t\t{\n', '\t\t\trequire(contracts[keccak256(Guid)]._State == BaseEscrowLib.GetContractStateActive() && msg.sender == contracts[keccak256(Guid)]._tenant);\n', '\n', '\t\t\tif (contracts[keccak256(Guid)]._CancelPolicy == 1)\n', '\t\t\t{\n', '\t\t\t\tFlexibleEscrowLib.TenantMoveIn(contracts[keccak256(Guid)]);\n', '\t\t\t}\n', '\t\t\telse if (contracts[keccak256(Guid)]._CancelPolicy == 2)\n', '\t\t\t{\n', '\t\t\t\tModerateEscrowLib.TenantMoveIn(contracts[keccak256(Guid)]);\n', '\t\t\t}\n', '\t\t\telse if (contracts[keccak256(Guid)]._CancelPolicy == 3)\n', '\t\t\t{\n', '\t\t\t\tStrictEscrowLib.TenantMoveIn(contracts[keccak256(Guid)]);\n', '\t\t\t}\n', '\t\t\telse{\n', '\t\t\t\trevert();\n', '\t\t\t}\n', '\t\t}\n', '\t}\n', '\n', '\tfunction LandlordTerminate(uint SecDeposit, string Guid) public\n', '\t{\t\t\n', '\t\tif (contracts[keccak256(Guid)]._Id != 0)\n', '\t\t{\n', '\t\t\trequire(SecDeposit >= 0 && SecDeposit <= uint256(contracts[keccak256(Guid)]._SecDeposit));\n', '\t\t\trequire(contracts[keccak256(Guid)]._State == BaseEscrowLib.GetContractStateActive() && msg.sender == contracts[keccak256(Guid)]._landlord);\n', '\n', '\t\t\tif (contracts[keccak256(Guid)]._CancelPolicy == 1)\n', '\t\t\t{\n', '\t\t\t\tFlexibleEscrowLib.LandlordTerminate(contracts[keccak256(Guid)], SecDeposit);\n', '\t\t\t}\n', '\t\t\telse if (contracts[keccak256(Guid)]._CancelPolicy == 2)\n', '\t\t\t{\n', '\t\t\t\tModerateEscrowLib.LandlordTerminate(contracts[keccak256(Guid)], SecDeposit);\n', '\t\t\t}\n', '\t\t\telse if (contracts[keccak256(Guid)]._CancelPolicy == 3)\n', '\t\t\t{\n', '\t\t\t\tStrictEscrowLib.LandlordTerminate(contracts[keccak256(Guid)], SecDeposit);\n', '\t\t\t}\n', '\t\t\telse{\n', '\t\t\t\trevert();\n', '\t\t\t\treturn;\n', '\t\t\t}\n', '\n', '\t\t\tSendTokens(Guid);\n', '\n', '\t\t\t//Raise event\n', '\t\t\tcontractTerminated(contracts[keccak256(Guid)]._Id, Guid, contracts[keccak256(Guid)]._State);\n', '\t\t}\n', '\t}\n', '\n', '\tfunction SendTokens(string Guid) private\n', '\t{\t\t\n', '\t\tif (contracts[keccak256(Guid)]._Id != 0)\n', '\t\t{\n', '\t\t\tif (contracts[keccak256(Guid)]._landlBal > 0)\n', '\t\t\t{\t\n', '\t\t\t\tuint landlBal = uint(contracts[keccak256(Guid)]._landlBal);\n', '\t\t\t\tcontracts[keccak256(Guid)]._landlBal = 0;\t\t\n', '\t\t\t\tcontracts[keccak256(Guid)]._tokenApi.transfer(contracts[keccak256(Guid)]._landlord, landlBal);\n', '\t\t\t\tcontracts[keccak256(Guid)]._Balance -= landlBal;\t\t\t\t\t\t\n', '\t\t\t}\n', '\t    \n', '\t\t\tif (contracts[keccak256(Guid)]._tenantBal > 0)\n', '\t\t\t{\t\t\t\n', '\t\t\t\tuint tenantBal = uint(contracts[keccak256(Guid)]._tenantBal);\n', '\t\t\t\tcontracts[keccak256(Guid)]._tenantBal = 0;\n', '\t\t\t\tcontracts[keccak256(Guid)]._tokenApi.transfer(contracts[keccak256(Guid)]._tenant, tenantBal);\t\t\t\n', '\t\t\t\tcontracts[keccak256(Guid)]._Balance -= tenantBal;\n', '\t\t\t}\n', '\t\t}\t\t\t    \n', '\t}\n', '}']
['pragma solidity ^0.4.15;\n', '\n', '\n', '\n', '\n', '\n', '\n', '\n', 'library DateTime {\n', '        /*\n', '         *  Date and Time utilities for ethereum contracts\n', '         *\n', '         */\n', '        struct _DateTime {\n', '                uint16 year;\n', '                uint8 month;\n', '                uint8 day;\n', '                uint8 hour;\n', '                uint8 minute;\n', '                uint8 second;\n', '                uint8 weekday;\n', '        }\n', '\n', '        uint private constant DAY_IN_SECONDS = 86400;\n', '        uint private constant YEAR_IN_SECONDS = 31536000;\n', '        uint private constant LEAP_YEAR_IN_SECONDS = 31622400;\n', '\n', '        uint private constant HOUR_IN_SECONDS = 3600;\n', '        uint private constant MINUTE_IN_SECONDS = 60;\n', '\n', '        uint16 private constant ORIGIN_YEAR = 1970;\n', '\n', '        function isLeapYear(uint16 year) public constant returns (bool) {\n', '                if (year % 4 != 0) {\n', '                        return false;\n', '                }\n', '                if (year % 100 != 0) {\n', '                        return true;\n', '                }\n', '                if (year % 400 != 0) {\n', '                        return false;\n', '                }\n', '                return true;\n', '        }\n', '\n', '        function leapYearsBefore(uint year) public constant  returns (uint) {\n', '                year -= 1;\n', '                return year / 4 - year / 100 + year / 400;\n', '        }\n', '\n', '        function getDaysInMonth(uint8 month, uint16 year) public constant  returns (uint8) {\n', '                if (month == 1 || month == 3 || month == 5 || month == 7 || month == 8 || month == 10 || month == 12) {\n', '                        return 31;\n', '                }\n', '                else if (month == 4 || month == 6 || month == 9 || month == 11) {\n', '                        return 30;\n', '                }\n', '                else if (isLeapYear(year)) {\n', '                        return 29;\n', '                }\n', '                else {\n', '                        return 28;\n', '                }\n', '        }\n', '\n', '        function parseTimestamp(uint timestamp) internal constant returns (_DateTime dt) {\n', '                uint secondsAccountedFor = 0;\n', '                uint buf;\n', '                uint8 i;\n', '\n', '                // Year\n', '                dt.year = getYear(timestamp);\n', '                buf = leapYearsBefore(dt.year) - leapYearsBefore(ORIGIN_YEAR);\n', '\n', '                secondsAccountedFor += LEAP_YEAR_IN_SECONDS * buf;\n', '                secondsAccountedFor += YEAR_IN_SECONDS * (dt.year - ORIGIN_YEAR - buf);\n', '\n', '                // Month\n', '                uint secondsInMonth;\n', '                for (i = 1; i <= 12; i++) {\n', '                        secondsInMonth = DAY_IN_SECONDS * getDaysInMonth(i, dt.year);\n', '                        if (secondsInMonth + secondsAccountedFor > timestamp) {\n', '                                dt.month = i;\n', '                                break;\n', '                        }\n', '                        secondsAccountedFor += secondsInMonth;\n', '                }\n', '\n', '                // Day\n', '                for (i = 1; i <= getDaysInMonth(dt.month, dt.year); i++) {\n', '                        if (DAY_IN_SECONDS + secondsAccountedFor > timestamp) {\n', '                                dt.day = i;\n', '                                break;\n', '                        }\n', '                        secondsAccountedFor += DAY_IN_SECONDS;\n', '                }\n', '\n', '                // Hour\n', '                dt.hour = getHour(timestamp);\n', '\n', '                // Minute\n', '                dt.minute = getMinute(timestamp);\n', '\n', '                // Second\n', '                dt.second = getSecond(timestamp);\n', '\n', '                // Day of week.\n', '                dt.weekday = getWeekday(timestamp);\n', '        }\n', '\n', '        function getYear(uint timestamp) public constant returns (uint16) {\n', '                uint secondsAccountedFor = 0;\n', '                uint16 year;\n', '                uint numLeapYears;\n', '\n', '                // Year\n', '                year = uint16(ORIGIN_YEAR + timestamp / YEAR_IN_SECONDS);\n', '                numLeapYears = leapYearsBefore(year) - leapYearsBefore(ORIGIN_YEAR);\n', '\n', '                secondsAccountedFor += LEAP_YEAR_IN_SECONDS * numLeapYears;\n', '                secondsAccountedFor += YEAR_IN_SECONDS * (year - ORIGIN_YEAR - numLeapYears);\n', '\n', '                while (secondsAccountedFor > timestamp) {\n', '                        if (isLeapYear(uint16(year - 1))) {\n', '                                secondsAccountedFor -= LEAP_YEAR_IN_SECONDS;\n', '                        }\n', '                        else {\n', '                                secondsAccountedFor -= YEAR_IN_SECONDS;\n', '                        }\n', '                        year -= 1;\n', '                }\n', '                return year;\n', '        }\n', '\n', '        function getMonth(uint timestamp) public constant returns (uint8) {\n', '                return parseTimestamp(timestamp).month;\n', '        }\n', '\n', '        function getDay(uint timestamp) public constant returns (uint8) {\n', '                return parseTimestamp(timestamp).day;\n', '        }\n', '\n', '        function getHour(uint timestamp) public constant returns (uint8) {\n', '                return uint8((timestamp / 60 / 60) % 24);\n', '        }\n', '\n', '        function getMinute(uint timestamp) public constant returns (uint8) {\n', '                return uint8((timestamp / 60) % 60);\n', '        }\n', '\n', '        function getSecond(uint timestamp) public constant returns (uint8) {\n', '                return uint8(timestamp % 60);\n', '        }\n', '\n', '        function getWeekday(uint timestamp) public constant returns (uint8) {\n', '                return uint8((timestamp / DAY_IN_SECONDS + 4) % 7);\n', '        }\n', '\n', '        function toTimestamp(uint16 year, uint8 month, uint8 day) public constant returns (uint timestamp) {\n', '                return toTimestamp(year, month, day, 0, 0, 0);\n', '        }\n', '\n', '        function toTimestamp(uint16 year, uint8 month, uint8 day, uint8 hour) public constant returns (uint timestamp) {\n', '                return toTimestamp(year, month, day, hour, 0, 0);\n', '        }\n', '\n', '        function toTimestamp(uint16 year, uint8 month, uint8 day, uint8 hour, uint8 minute) public constant returns (uint timestamp) {\n', '                return toTimestamp(year, month, day, hour, minute, 0);\n', '        }\n', '\n', '        function toTimestamp(uint16 year, uint8 month, uint8 day, uint8 hour, uint8 minute, uint8 second) public constant returns (uint timestamp) {\n', '                uint16 i;\n', '\n', '                // Year\n', '                for (i = ORIGIN_YEAR; i < year; i++) {\n', '                        if (isLeapYear(i)) {\n', '                                timestamp += LEAP_YEAR_IN_SECONDS;\n', '                        }\n', '                        else {\n', '                                timestamp += YEAR_IN_SECONDS;\n', '                        }\n', '                }\n', '\n', '                // Month\n', '                uint8[12] memory monthDayCounts;\n', '                monthDayCounts[0] = 31;\n', '                if (isLeapYear(year)) {\n', '                        monthDayCounts[1] = 29;\n', '                }\n', '                else {\n', '                        monthDayCounts[1] = 28;\n', '                }\n', '                monthDayCounts[2] = 31;\n', '                monthDayCounts[3] = 30;\n', '                monthDayCounts[4] = 31;\n', '                monthDayCounts[5] = 30;\n', '                monthDayCounts[6] = 31;\n', '                monthDayCounts[7] = 31;\n', '                monthDayCounts[8] = 30;\n', '                monthDayCounts[9] = 31;\n', '                monthDayCounts[10] = 30;\n', '                monthDayCounts[11] = 31;\n', '\n', '                for (i = 1; i < month; i++) {\n', '                        timestamp += DAY_IN_SECONDS * monthDayCounts[i - 1];\n', '                }\n', '\n', '                // Day\n', '                timestamp += DAY_IN_SECONDS * (day - 1);\n', '\n', '                // Hour\n', '                timestamp += HOUR_IN_SECONDS * (hour);\n', '\n', '                // Minute\n', '                timestamp += MINUTE_IN_SECONDS * (minute);\n', '\n', '                // Second\n', '                timestamp += second;\n', '\n', '                return timestamp;\n', '        }\n', '\n', '\t\t// -1 t1 < t2\n', '\t\t// 0  t1 == t2\n', '\t\t// 1  t1 > t2\n', '\t\tfunction compareDatesWithoutTime(uint t1, uint t2) public constant returns (int res)\n', '\t\t{\n', '\t\t\t_DateTime memory dt1 = parseTimestamp(t1);\n', '\t\t\t_DateTime memory dt2 = parseTimestamp(t2);\n', '\n', '\t\t\tres = compareInts(dt1.year, dt2.year);\n', '\t\t\tif (res == 0)\n', '\t\t\t{\n', '\t\t\t\tres = compareInts(dt1.month, dt2.month);\n', '\t\t\t\tif (res == 0)\n', '\t\t\t\t{\n', '\t\t\t\t\tres = compareInts(dt1.day, dt2.day);\n', '\t\t\t\t}\n', '\t\t\t}\n', '\t\t}\n', '\n', '\n', '\t\t//  t2 -> MoveIn or MoveOut day in GMT, will be counted as beginning of a day\n', '\t\t//  t1 -> Current System DateTime\n', '\t\t// -1 t1 before t2\n', '\t\t//--------------------------------\n', '\t\t// 0  t1 same day as t2\n', '\t\t// 1  t1 after t2\n', '\t\tfunction compareDateTimesForContract(uint t1, uint t2) public constant returns (int res)\n', '\t\t{\n', '\t\t    uint endOfDay = t2 + (60 * 60 * 24);\n', '\t\t    res = 0;\n', '\t\t    \n', '\t\t    if (t2 <= t1 && t1 <= endOfDay)\n', '\t\t    {\n', '\t\t        res = 0;\n', '\t\t    }\n', '\t\t    else if (t2 > t1)\n', '\t\t    {\n', '\t\t        res = -1;\n', '\t\t    }\n', '\t\t    else if (t1 > endOfDay)\n', '\t\t    {\n', '\t\t        res = 1;\n', '\t\t    }\n', '\t\t}\t\n', '\n', '\n', '\t\t// -1 n1 < n2\n', '\t\t// 0  n1 == n2\n', '\t\t// 1  n1 > n2\n', '\t\tfunction compareInts(int n1, int n2) internal constant returns (int res)\n', '\t\t{\n', '\t\t\tif (n1 == n2)\n', '\t\t\t{\n', '\t\t\t\tres = 0;\n', '\t\t\t}\n', '\t\t\telse if (n1 < n2)\n', '\t\t\t{\n', '\t\t\t\tres = -1;\n', '\t\t\t}\n', '\t\t\telse if (n1 > n2)\n', '\t\t\t{\n', '\t\t\t\tres = 1;\n', '\t\t\t}\n', '\t\t}\n', '}\n', '\n', '// ----------------------------------------------------------------------------\n', '// ERC Token Standard #20 Interface\n', '// https://github.com/ethereum/EIPs/blob/master/EIPS/eip-20-token-standard.md\n', '// ----------------------------------------------------------------------------\n', 'contract ERC20Interface {\n', '    function totalSupply() public constant returns (uint);\n', '    function balanceOf(address tokenOwner) public constant returns (uint balance);\n', '    function allowance(address tokenOwner, address spender) public constant returns (uint remaining);\n', '    function transfer(address to, uint tokens) public returns (bool success);\n', '    function approve(address spender, uint tokens) public returns (bool success);\n', '    function transferFrom(address from, address to, uint tokens) public returns (bool success);\n', '\n', '    event Transfer(address indexed from, address indexed to, uint tokens);\n', '    event Approval(address indexed tokenOwner, address indexed spender, uint tokens);\n', '}\n', '\n', '\n', 'library BaseEscrowLib\n', '{\n', '    struct EscrowContractState { \n', '\t\tuint _CurrentDate;\n', '\t\tuint _CreatedDate;\n', '\t\tint _RentPerDay;\n', '\t\tuint _MoveInDate;\n', '\t\tuint _MoveOutDate;\t\t\t\t\n', '\t\tint _TotalAmount;\t\t\t\t\t\n', '\t\tint _SecDeposit;\n', '\t\tint _State;\t\n', '\t\tuint _ActualMoveInDate;\n', '\t\tuint _ActualMoveOutDate;\n', '\t\taddress _landlord;\n', '\t\taddress _tenant;\n', '\t\tbool _TenantConfirmedMoveIn;\t\t\n', '\t\tbool _MisrepSignaled;\t\t\t\n', '\t\tstring _DoorLockData;\n', '\t\taddress _ContractAddress;\t\t\n', '\t\tERC20Interface _tokenApi;\n', '\t\tint _landlBal;\n', '\t\tint _tenantBal;\n', '\t\tint _Id;\n', '\t\tint _CancelPolicy;\n', '\t\tuint _Balance;\n', '\t\tstring _Guid;\n', '    }\n', '\n', '    //Define public constants\n', '\t//Pre-Move In\n', '\tint internal constant ContractStateActive = 1;\n', '\tint internal constant ContractStateCancelledByTenant = 2;\n', '\tint internal constant ContractStateCancelledByLandlord = 3;\n', '\n', '\t//Move-In\n', '\tint internal constant ContractStateTerminatedMisrep = 4;\n', '\n', '\t//Living\n', '\tint internal constant ContractStateEarlyTerminatedByTenant = 5;\n', '\tint internal constant ContractStateEarlyTerminatedByTenantSecDep = 6;\n', '\tint internal constant ContractStateEarlyTerminatedByLandlord = 7;\t\t\n', '\n', '\t//Move-Out\n', '\tint internal constant ContractStateTerminatedOK = 8;\t\n', '\tint internal constant ContractStateTerminatedSecDep = 9;\n', '\t\n', '\t//Stages\n', '\tint internal constant ContractStagePreMoveIn = 0;\n', '\tint internal constant ContractStageLiving = 1;\n', '\tint internal constant ContractStageTermination = 2;\n', '\n', '\t//Action\n', '\tint internal constant ActionKeyTerminate = 0;\n', '\tint internal constant ActionKeyMoveIn = 1;\t\n', '\tint internal constant ActionKeyTerminateMisrep = 2;\t\n', '\tint internal constant ActionKeyPropOk = 3;\n', '\tint internal constant ActionKeyClaimDeposit = 4;\n', '\n', '\t//Log\n', '\tint internal constant LogMessageInfo = 0;\n', '\tint internal constant LogMessageWarning = 1;\n', '\tint internal constant LogMessageError = 2;\n', '\n', '\tevent logEvent(int stage, int atype, uint timestamp, string guid, string text);\n', '\n', '\n', '\t//DEBUG or TESTNET\n', '\t//bool private constant EnableSimulatedCurrentDate = true;\n', '\n', '\t//RELEASE\n', '\tbool private constant EnableSimulatedCurrentDate = false;\n', '\n', '\n', '\t//LogEvent wrapper\n', '\tfunction ContractLogEvent(int stage, int atype, uint timestamp, string guid, string text) public\n', '\t{\n', '\t\tlogEvent(stage, atype, timestamp, guid, text);\n', '\t}\n', '\n', '\t//Constant function wrappers\n', '\tfunction GetContractStateActive() public constant returns (int)\n', '\t{\n', '\t\treturn ContractStateActive;\n', '\t}\n', '\n', '\tfunction GetContractStateCancelledByTenant() public constant returns (int)\n', '\t{\n', '\t\treturn ContractStateCancelledByTenant;\n', '\t}\n', '\n', '\tfunction GetContractStateCancelledByLandlord() public constant returns (int)\n', '\t{\n', '\t\treturn ContractStateCancelledByLandlord;\n', '\t}\n', '\t\n', '\tfunction GetContractStateTerminatedMisrep() public constant returns (int)\n', '\t{\n', '\t\treturn ContractStateTerminatedMisrep;\n', '\t}\n', '\n', '\tfunction GetContractStateEarlyTerminatedByTenant() public constant returns (int)\n', '\t{\n', '\t\treturn ContractStateEarlyTerminatedByTenant;\n', '\t}\n', '\n', '\tfunction GetContractStateEarlyTerminatedByTenantSecDep() public constant returns (int)\n', '\t{\n', '\t\treturn ContractStateEarlyTerminatedByTenantSecDep;\n', '\t}\n', '\n', '\tfunction GetContractStateEarlyTerminatedByLandlord() public constant returns (int)\n', '\t{\n', '\t\treturn ContractStateEarlyTerminatedByLandlord;\t\t\n', '\t}\n', '\n', '\tfunction GetContractStateTerminatedOK() public constant returns (int)\n', '\t{\n', '\t\treturn ContractStateTerminatedOK;\t\n', '\t}\n', '\n', '\tfunction GetContractStateTerminatedSecDep() public constant returns (int)\n', '\t{\n', '\t\treturn ContractStateTerminatedSecDep;\n', '\t}\n', '\t\n', '\tfunction GetContractStagePreMoveIn() public constant returns (int)\n', '\t{\n', '\t\treturn ContractStagePreMoveIn;\n', '\t}\n', '\n', '\tfunction GetContractStageLiving() public constant returns (int)\n', '\t{\n', '\t\treturn ContractStageLiving;\n', '\t}\n', '\n', '\tfunction GetContractStageTermination() public constant returns (int)\n', '\t{\n', '\t\treturn ContractStageTermination;\n', '\t}\n', '\t\n', '\tfunction GetLogMessageInfo() public constant returns (int)\n', '\t{\n', '\t\treturn LogMessageInfo;\n', '\t}\n', '\n', '\tfunction GetLogMessageWarning() public constant returns (int)\n', '\t{\n', '\t\treturn LogMessageWarning;\n', '\t}\n', '\n', '\tfunction GetLogMessageError() public constant returns (int)\n', '\t{\n', '\t\treturn LogMessageError;\n', '\t}\n', '\n', '\n', '\t//////////////////////////////////////////////////////////////////////////////////////////////////////////////\n', '\tfunction initialize(EscrowContractState storage self) {\n', '\n', '\t\t//Check parameters\n', '\t\t//all dates must be in the future\n', '\n', '\t\trequire(self._CurrentDate < self._MoveInDate);\n', '\t\trequire(self._MoveInDate < self._MoveOutDate);\n', '\t\t\t\t\t\t\t\n', '\t\tint nPotentialBillableDays = (int)(self._MoveOutDate - self._MoveInDate) / (60 * 60 * 24);\n', '\t\tint nPotentialBillableAmount = nPotentialBillableDays * (self._RentPerDay);\n', '\t\t\n', '\t\t//Limit 2 months stay\n', '\t\trequire (nPotentialBillableDays <= 60); \n', '\n', '\t\tself._TotalAmount = nPotentialBillableAmount + self._SecDeposit;\n', '\t\t\t\t\n', '\t\t//Sec Deposit should not be more than 30 perecent\n', '\t\trequire (self._SecDeposit / nPotentialBillableAmount * 100 <= 30);\n', '\t\t\t\t\n', '\n', '\t\tself._TenantConfirmedMoveIn = false;\n', '\t\tself._MisrepSignaled = false;\n', '\t\tself._State = GetContractStateActive();\n', '\t\tself._ActualMoveInDate = 0;\n', '\t\tself._ActualMoveOutDate = 0;\n', '\t\tself._landlBal = 0;\n', '\t\tself._tenantBal = 0;\n', '\t}\n', '\n', '\n', '\tfunction TerminateContract(EscrowContractState storage self, int tenantBal, int landlBal, int state) public\n', '\t{\n', '\t\tint stage = GetCurrentStage(self);\n', '\t\tuint nCurrentDate = GetCurrentDate(self);\n', '\t\tint nActualBalance = int(GetContractBalance(self));\n', '\n', '\t\tif (nActualBalance == 0)\n', '\t\t{\n', '\t\t    //If it was unfunded, just change state\n', '\t\t    self._State = state;   \n', '\t\t}\n', '\t\telse if (self._State == ContractStateActive && state != ContractStateActive)\n', '\t\t{\n', '\t\t\t//Check if some balances are negative\n', '\t\t\tif (landlBal < 0)\n', '\t\t\t{\n', '\t\t\t\ttenantBal += landlBal;\n', '\t\t\t\tlandlBal = 0;\n', '\t\t\t}\n', '\n', '\t\t\tif (tenantBal < 0) {\n', '\t\t\t\tlandlBal += tenantBal;\n', '\t\t\t\ttenantBal = 0;\n', '\t\t\t}\n', '\n', '\t\t\t//Check if balances exceed total amount\n', '\t\t\tif ((landlBal + tenantBal) > nActualBalance)\n', '\t\t\t{\n', '\t\t\t\tvar nOverrun = (landlBal + tenantBal) - self._TotalAmount;\n', '\t\t\t\tlandlBal -= (nOverrun / 2);\n', '\t\t\t\ttenantBal -= (nOverrun / 2);\n', '\t\t\t}\n', '\n', '\t\t\tself._State = state;\n', '\n', '\t\t\tstring memory strState = "";\n', '\n', '\t\t\tif (state == ContractStateTerminatedOK)\n', '\t\t\t{\n', '\t\t\t\tstrState = " State is: OK";\n', '\t\t\t}\n', '\t\t\telse if (state == ContractStateEarlyTerminatedByTenant)\n', '\t\t\t{\n', '\t\t\t\tstrState = " State is: Early terminated by tenant";\n', '\t\t\t}\n', '\t\t\telse if (state == ContractStateEarlyTerminatedByTenantSecDep)\n', '\t\t\t{\n', '\t\t\t\tstrState = " State is: Early terminated by tenant, Security Deposit claimed";\n', '\t\t\t}\n', '\t\t\telse if (state == ContractStateEarlyTerminatedByLandlord)\n', '\t\t\t{\n', '\t\t\t\tstrState = " State is: Early terminated by landlord";\n', '\t\t\t}\n', '\t\t\telse if (state == ContractStateCancelledByTenant)\n', '\t\t\t{\n', '\t\t\t\tstrState = " State is: Cancelled by tenant";\n', '\t\t\t}\n', '\t\t\telse if (state == ContractStateCancelledByLandlord)\n', '\t\t\t{\n', '\t\t\t\tstrState = " State is: Cancelled by landlord";\n', '\t\t\t}\n', '\t\t\telse if (state == ContractStateTerminatedSecDep)\n', '\t\t\t{\n', '\t\t\t\tstrState = " State is: Security Deposit claimed";\n', '\t\t\t}\n', '\t\t\n', '\t\t\t\n', '\t\t\t\n', '\t\t\tbytes32 b1;\n', '\t\t\tbytes32 b2;\n', '\t\t\tb1 = uintToBytes(uint(landlBal));\n', '\t\t\tb2 = uintToBytes(uint(tenantBal));\n', '\n', '                        /*\n', '\t\t    string memory s1;\n', '\t\t    string memory s2;\t\n', '\t\t    s1 = bytes32ToString(b1);\n', '\t\t    s2 = bytes32ToString(b2);\n', '                        */\n', '\t\t\t\n', '\t\t\tstring memory strMessage = strConcat(\n', '\t\t\t    "Contract is termintaing. Landlord balance is _$b_", \n', '\t\t\t    bytes32ToString(b1), \n', '\t\t\t    "_$e_, Tenant balance is _$b_", \n', '\t\t\t    bytes32ToString(b2));\n', '\n', '            \n', '\t\t\tstring memory strMessage2 = strConcat(\n', '\t\t\t\tstrMessage,\n', '\t\t\t\t"_$e_.",\n', '\t\t\t\tstrState\n', '\t\t\t);\n', '\n', '            string memory sGuid;\n', '            sGuid = self._Guid;\n', '\t\t\t\n', '            logEvent(stage, LogMessageInfo, nCurrentDate, sGuid, strMessage2);\n', '            \n', '\t\t\t//Send tokens\n', '\t\t\tself._landlBal = landlBal;\n', '\t\t\tself._tenantBal = tenantBal;\n', '\t\t}\t\n', '\t}\n', '\n', '\tfunction GetCurrentStage(EscrowContractState storage self) public constant returns (int stage)\n', '\t{\n', '\t\tuint nCurrentDate = GetCurrentDate(self);\n', '\t\tuint nActualBalance = GetContractBalance(self);\n', '        \n', '        stage = ContractStagePreMoveIn;\n', '        \n', '\t\tif (self._State == ContractStateActive && uint(self._TotalAmount) > nActualBalance)\n', '\t\t{\n', '\t\t\t//Contract unfunded\n', '\t\t\tstage = ContractStagePreMoveIn;\n', '\t\t}\t\t\n', '\t\telse if (DateTime.compareDateTimesForContract(nCurrentDate, self._MoveInDate) < 0)\n', '\t\t{\n', '\t\t\tstage = ContractStagePreMoveIn;\n', '\t\t}\n', '\t\telse if (DateTime.compareDateTimesForContract(nCurrentDate, self._MoveInDate) >= 0 && \n', '\t\t         DateTime.compareDateTimesForContract(nCurrentDate, self._MoveOutDate) < 0 && \n', '\t\t         self._TenantConfirmedMoveIn)\n', '\t\t{\n', '\t\t\tstage = ContractStageLiving;\n', '\t\t}\n', '\t\telse if (DateTime.compareDateTimesForContract(nCurrentDate, self._MoveOutDate) >= 0)\n', '\t\t{\n', '\t\t\tstage = ContractStageTermination;\n', '\t\t}\t\n', '\t}\n', '\n', '\n', '\n', '\t///Helper functions\n', '\tfunction SimulateCurrentDate(EscrowContractState storage self, uint n) public\n', '\t{\n', '\t\tif (EnableSimulatedCurrentDate)\n', '\t\t{\n', '\t\t\tself._CurrentDate = n;\n', '\t\t\t//int stage = GetCurrentStage(self);\n', '\t\t\t//logEvent(stage, LogMessageInfo, self._CurrentDate, "SimulateCurrentDate was called.");\t\n', '\t\t}\n', '\t}\n', '\t\n', '\t\n', '\t\n', '\tfunction GetCurrentDate(EscrowContractState storage self) public constant returns (uint nCurrentDate)\n', '\t{\n', '\t\tif (EnableSimulatedCurrentDate)\n', '\t\t{\n', '\t\t\tnCurrentDate = self._CurrentDate;\n', '\t\t}\n', '\t\telse\n', '\t\t{\n', '\t\t\tnCurrentDate = now;\n', '\t\t}\t\n', '\t}\n', '\n', '\tfunction GetContractBalance(EscrowContractState storage self) public returns (uint res)\n', '\t{\n', '\t    res = self._Balance;\n', '\t}\n', '\n', '\n', '\tfunction splitBalanceAccordingToRatings(int balance, int tenantScore, int landlScore) public constant returns (int tenantBal, int landlBal)\n', '\t{\n', '\t\tif (tenantScore == landlScore) {\n', '\t\t\t//Just split in two \n', '\t\t\ttenantBal = balance / 2;\n', '\t\t\tlandlBal = balance / 2;\n', '\t\t}\n', '\t\telse if (tenantScore == 0)\n', '\t\t{\n', '\t\t\ttenantBal = 0;\n', '\t\t\tlandlBal = balance;\t\t\t\n', '\t\t}\n', '\t\telse if (landlScore == 0) {\n', '\t\t\ttenantBal = balance;\n', '\t\t\tlandlBal = 0;\n', '\t\t}\n', '\t\telse if (tenantScore > landlScore) {\t\t\t\n', '\t\t\tlandlBal = ((landlScore * balance / 2) / tenantScore);\n', '\t\t\ttenantBal = balance - landlBal;\t\t\t\n', '\t\t}\n', '\t\telse if (tenantScore < landlScore) {\t\t\t\n', '\t\t\ttenantBal = ((tenantScore * balance / 2) / landlScore);\n', '\t\t\tlandlBal = balance - tenantBal;\t\t\t\n', '\t\t}\t\t\n', '\t}\n', '\n', '\tfunction formatDate(uint dt) public constant returns (string strDate)\n', '\t{\n', '\t\tbytes32 b1;\n', '\t\tbytes32 b2;\n', '\t\tbytes32 b3;\n', '\t\tb1 = uintToBytes(uint(DateTime.getMonth(dt)));\n', '\t\tb2 = uintToBytes(uint(DateTime.getDay(dt)));\n', '\t\tb3 = uintToBytes(uint(DateTime.getYear(dt)));\n', '\t\tstring memory s1;\n', '\t\tstring memory s2;\t\n', '\t\tstring memory s3;\n', '\t\ts1 = bytes32ToString(b1);\n', '\t\ts2 = bytes32ToString(b2);\n', '\t\ts3 = bytes32ToString(b3);\n', '\t\t\n', '\t\tstring memory strDate1 = strConcat(s1, "/", s2, "/");\n', '\t\tstrDate = strConcat(strDate1, s3);\t\t\t\n', '\t}\n', '\t\n', '\n', '    function strConcat(string _a, string _b, string _c, string _d, string _e) internal constant returns (string){\n', '        bytes memory _ba = bytes(_a);\n', '        bytes memory _bb = bytes(_b);\n', '        bytes memory _bc = bytes(_c);\n', '        bytes memory _bd = bytes(_d);\n', '        bytes memory _be = bytes(_e);\n', '        string memory abcde = new string(_ba.length + _bb.length + _bc.length + _bd.length + _be.length);\n', '        bytes memory babcde = bytes(abcde);\n', '        uint k = 0;\n', '        for (uint i = 0; i < _ba.length; i++) babcde[k++] = _ba[i];\n', '        for (i = 0; i < _bb.length; i++) babcde[k++] = _bb[i];\n', '        for (i = 0; i < _bc.length; i++) babcde[k++] = _bc[i];\n', '        for (i = 0; i < _bd.length; i++) babcde[k++] = _bd[i];\n', '        for (i = 0; i < _be.length; i++) babcde[k++] = _be[i];\n', '        return string(babcde);\n', '    }\n', '    \n', '    function strConcat(string _a, string _b, string _c, string _d) internal constant returns (string) {\n', '        return strConcat(_a, _b, _c, _d, "");\n', '    }\n', '    \n', '    function strConcat(string _a, string _b, string _c) internal constant returns (string) {\n', '        return strConcat(_a, _b, _c, "", "");\n', '    }\n', '    \n', '    function strConcat(string _a, string _b) internal constant returns (string) {\n', '        return strConcat(_a, _b, "", "", "");\n', '    } \n', '    \n', '    function bytes32ToString(bytes32 x) internal constant returns (string) {\n', '        bytes memory bytesString = new bytes(32);\n', '        uint charCount = 0;\n', '        for (uint j = 0; j < 32; j++) {\n', '            byte char = byte(bytes32(uint(x) * 2 ** (8 * j)));\n', '            if (char != 0) {\n', '                bytesString[charCount] = char;\n', '                charCount++;\n', '            }\n', '        }\n', '        bytes memory bytesStringTrimmed = new bytes(charCount);\n', '        for (j = 0; j < charCount; j++) {\n', '            bytesStringTrimmed[j] = bytesString[j];\n', '        }\n', '        return string(bytesStringTrimmed);\n', '    }\n', '\n', '    function bytes32ArrayToString(bytes32[] data) internal constant returns (string) {\n', '        bytes memory bytesString = new bytes(data.length * 32);\n', '        uint urlLength;\n', '        for (uint i=0; i<data.length; i++) {\n', '            for (uint j=0; j<32; j++) {\n', '                byte char = byte(bytes32(uint(data[i]) * 2 ** (8 * j)));\n', '                if (char != 0) {\n', '                    bytesString[urlLength] = char;\n', '                    urlLength += 1;\n', '                }\n', '            }\n', '        }\n', '        bytes memory bytesStringTrimmed = new bytes(urlLength);\n', '        for (i=0; i<urlLength; i++) {\n', '            bytesStringTrimmed[i] = bytesString[i];\n', '        }\n', '        return string(bytesStringTrimmed);\n', '    }  \n', '    \n', '    \n', '    function uintToBytes(uint v) internal constant returns (bytes32 ret) {\n', '        if (v == 0) {\n', "            ret = '0';\n", '        }\n', '        else {\n', '            while (v > 0) {\n', '                ret = bytes32(uint(ret) / (2 ** 8));\n', '                ret |= bytes32(((v % 10) + 48) * 2 ** (8 * 31));\n', '                v /= 10;\n', '            }\n', '        }\n', '        return ret;\n', '    }\n', '\n', "    /// @dev Converts a numeric string to it's unsigned integer representation.\n", '    /// @param v The string to be converted.\n', '    function bytesToUInt(bytes32 v) internal constant returns (uint ret) {\n', '        if (v == 0x0) {\n', '            throw;\n', '        }\n', '\n', '        uint digit;\n', '\n', '        for (uint i = 0; i < 32; i++) {\n', '            digit = uint((uint(v) / (2 ** (8 * (31 - i)))) & 0xff);\n', '            if (digit == 0) {\n', '                break;\n', '            }\n', '            else if (digit < 48 || digit > 57) {\n', '                throw;\n', '            }\n', '            ret *= 10;\n', '            ret += (digit - 48);\n', '        }\n', '        return ret;\n', '    }    \n', '\n', '\n', '}\n', '\n', '\n', 'library FlexibleEscrowLib\n', '{\n', '\tusing BaseEscrowLib for BaseEscrowLib.EscrowContractState;\n', '\n', '    //Cancel days\n', '\tint internal constant FreeCancelBeforeMoveInDays = 14;\n', '\n', '\t//Expiration\n', '\tint internal constant ExpireAfterMoveOutDays = 14;\n', '\t\t    \n', '\n', '    \n', '\tfunction TenantTerminate(BaseEscrowLib.EscrowContractState storage self) public\n', '    {\n', '\t\tint nCurrentStage = BaseEscrowLib.GetCurrentStage(self);\n', '\t\tuint nCurrentDate = BaseEscrowLib.GetCurrentDate(self);\n', '\t\tint nActualBalance = int(BaseEscrowLib.GetContractBalance(self));\n', '\t\tint tenantBal = 0;\n', '\t\tint landlBal = 0;\n', '\t\tint state = 0; \n', '\t\tbool bProcessed = false;\n', '        string memory sGuid;\n', '        sGuid = self._Guid;\n', '\n', '\t\tif (nActualBalance == 0)\n', '\t\t{\n', '\t\t\t//If contract is unfunded, just cancel it\n', '\t\t\tstate = BaseEscrowLib.GetContractStateCancelledByTenant();\n', '\t\t\tbProcessed = true;\t\t\t\n', '\t\t}\n', '\t\telse if (nCurrentStage == BaseEscrowLib.GetContractStagePreMoveIn())\n', '\t\t{\t\t\t\n', '\t\t\tint nDaysBeforeMoveIn = (int)(self._MoveInDate - nCurrentDate) / (60 * 60 * 24);\n', '\t\t\tif (nDaysBeforeMoveIn < FreeCancelBeforeMoveInDays)\n', '\t\t\t{\n', '\t\t\t\t//Pay cancel fee\n', '\t\t\t\t//Contract must be fully funded\n', '\t\t\t\trequire(self._RentPerDay <= nActualBalance);\n', '\n', '\t\t\t\t//Cancellation fee is one day rent\n', '\t\t\t\ttenantBal = nActualBalance - self._RentPerDay;\n', '\t\t\t\tlandlBal = self._RentPerDay;\n', '\t\t\t\tstate = BaseEscrowLib.GetContractStateCancelledByTenant();\n', '\t\t\t\tbProcessed = true;\n', '\n', '\t\t\t\tBaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageWarning(), nCurrentDate, sGuid, "Tenant cancelled escrow. Cancellation fee will be withheld from tenant.");\t\t\t\t\t\t\t\t\t\t\n', '\t\t\t}\n', '\t\t\telse\n', '\t\t\t{\n', '\t\t\t\t//No cancel fee\n', '\t\t\t\ttenantBal = nActualBalance;\n', '\t\t\t\tlandlBal = 0;\n', '\t\t\t\tstate = BaseEscrowLib.GetContractStateCancelledByTenant();\n', '\t\t\t\tbProcessed = true;\n', '\n', '\t\t\t\tBaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageWarning(), nCurrentDate, sGuid, "Tenant cancelled escrow.");\n', '\t\t\t}\t\t\t\t\t\n', '\t\t}\n', '\t\telse if (nCurrentStage == BaseEscrowLib.GetContractStageLiving())\n', '\t\t{\n', '\t\t\tstate = 0;\n', '\t\t\tself._ActualMoveOutDate = nCurrentDate;\n', '\t\t\tbProcessed = true;\n', '\t\t\t//In this case landlord will close escrow\n', '\n', '\t\t\tBaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageWarning(), nCurrentDate, sGuid, "Tenant signaled early move-out");\n', '\t\t}\n', '\t\telse if (nCurrentStage == BaseEscrowLib.GetContractStageTermination())\n', '\t\t{\n', '\t\t\t//If landlord did not close the escrow, and if it is expired, tenant may only pay for rent without sec deposit\n', '\t\t\tint nDaysAfterMoveOut = (int)(nCurrentDate - self._MoveOutDate) / (60 * 60 * 24);\n', '\n', '\t\t\tif (nDaysAfterMoveOut > ExpireAfterMoveOutDays)\n', '\t\t\t{\n', '\t\t\t\tint nPotentialBillableDays = (int)(self._MoveOutDate - self._MoveInDate) / (60 * 60 * 24);\n', '\t\t\t\trequire(self._RentPerDay * nPotentialBillableDays <= nActualBalance);\n', '\n', '\t\t\t\tlandlBal = self._RentPerDay * nPotentialBillableDays;\n', '\t\t\t\ttenantBal = nActualBalance - landlBal;\n', '\t\t\t\tbProcessed = true;\n', '\t\t\t\tstate = BaseEscrowLib.GetContractStateTerminatedOK();\n', '\n', '\t\t\t\tBaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageInfo(), nCurrentDate, sGuid, "Tenant closed escrow because it was expired");\n', '\t\t\t}\n', '\t\t}\n', '\n', '\t\trequire(bProcessed);\n', '\t\tif (state > 0)\n', '\t\t{\n', '\t\t\tBaseEscrowLib.TerminateContract(self,tenantBal,landlBal,state);\n', '\t\t}\n', '\n', '    }\n', '    \n', '    function TenantMoveIn(BaseEscrowLib.EscrowContractState storage self) public\n', '    {\n', '\t\tint nCurrentStage = BaseEscrowLib.GetCurrentStage(self);\n', '\t\tuint nCurrentDate = BaseEscrowLib.GetCurrentDate(self);\n', '\t\tint nActualBalance = int(BaseEscrowLib.GetContractBalance(self));\n', '\t\tstring memory sGuid;\n', '        sGuid = self._Guid;\n', '\t\t\t\t\n', '\t\trequire(nCurrentStage == BaseEscrowLib.GetContractStagePreMoveIn() && nActualBalance >= self._TotalAmount && \n', '\t\t\t\tDateTime.compareDateTimesForContract(nCurrentDate, self._MoveInDate) >= 0);\n', '\n', '        BaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageInfo(), nCurrentDate, sGuid, "Tenant signaled move-in");\n', '\n', '\t\tself._TenantConfirmedMoveIn = true;\n', '    } \n', '\t       \n', '    function TenantTerminateMisrep(BaseEscrowLib.EscrowContractState storage self) public\n', '    {\n', '\t\tint nCurrentStage = BaseEscrowLib.GetCurrentStage(self);\n', '\t\tuint nCurrentDate = BaseEscrowLib.GetCurrentDate(self);\n', '\t\tint nActualBalance = int(BaseEscrowLib.GetContractBalance(self));\n', '\t\tint tenantBal = 0;\n', '\t\tint landlBal = 0;\n', '        string memory sGuid;\n', '        sGuid = self._Guid;\n', '\n', '\t\trequire(nCurrentStage == BaseEscrowLib.GetContractStagePreMoveIn() && nActualBalance >= self._RentPerDay && \n', '\t\t\t\tDateTime.compareDateTimesForContract(nCurrentDate, self._MoveInDate) == 0);\n', '\n', '\t\t(tenantBal, landlBal) = BaseEscrowLib.splitBalanceAccordingToRatings(self._RentPerDay,0,0);\n', '\t\t\t\t\t\n', '\t\ttenantBal = nActualBalance - landlBal;\n', '\t\t\n', '\t\tBaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageWarning(), nCurrentDate, sGuid, "Tenant signaled misrepresentation and terminated escrow!");\n', '\t\tself._MisrepSignaled = true;\n', '\n', '\t\tBaseEscrowLib.TerminateContract(self,tenantBal,landlBal,BaseEscrowLib.GetContractStateTerminatedMisrep());\t         \n', '    }    \n', '\t\n', '\tfunction LandlordTerminate(BaseEscrowLib.EscrowContractState storage self, uint SecDeposit) public\n', '\t{\n', '\t\tint nCurrentStage = BaseEscrowLib.GetCurrentStage(self);\n', '\t\tuint nCurrentDate = BaseEscrowLib.GetCurrentDate(self);\n', '\t\tint nActualBalance = int(BaseEscrowLib.GetContractBalance(self));\n', '\t\tint tenantBal = 0;\n', '\t\tint landlBal = 0;\n', '\t\tint state = 0; \n', '\t\tbool bProcessed = false;\n', '\t\tint nPotentialBillableDays = 0;\n', '        string memory sGuid;\n', '        sGuid = self._Guid;\n', '\n', '\t\tif (nActualBalance == 0)\n', '\t\t{\n', '\t\t\t//If contract is unfunded, just cancel it\n', '\t\t\tstate = BaseEscrowLib.GetContractStateCancelledByLandlord();\n', '\t\t\tbProcessed = true;\t\t\t\n', '\t\t}\n', '\t\telse if (nCurrentStage == BaseEscrowLib.GetContractStagePreMoveIn())\n', '\t\t{\t\n', '\t\t\tif (DateTime.compareDateTimesForContract(nCurrentDate, self._MoveInDate) > 0 && \n', '\t\t\t\t!self._TenantConfirmedMoveIn)\n', '\t\t\t{\n', '\t\t\t\t//Landlord gets cancell fee if tenant did not signal anything after move in date\n', '\t\t\t\ttenantBal = nActualBalance - self._RentPerDay;\t\n', '\t\t\t\tlandlBal = self._RentPerDay;\n', '\t\t\t\tstate = BaseEscrowLib.GetContractStateCancelledByLandlord();\n', '\t\t\t\tbProcessed = true;\n', '\t\t\t\tBaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageWarning(), nCurrentDate, sGuid, "Landlord cancelled escrow. Tenant did not show up and will pay cancellation fee.");\t\t\t\t\t\t\t\t\n', '\t\t\t}\n', '\t\t\telse\n', '\t\t\t{\t\t        \t\t\t\t\n', '\t\t\t\t//No cancel fee\n', '\t\t\t\ttenantBal = nActualBalance;\n', '\t\t\t\tlandlBal = 0;\n', '\t\t\t\tstate = BaseEscrowLib.GetContractStateCancelledByLandlord();\n', '\t\t\t\tbProcessed = true;\n', '\t\t\t\tBaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageInfo(), nCurrentDate, sGuid, "Landlord cancelled esqrow");\t\t\t\t\t\t\t\t\n', '\t\t\t}\n', '\t\t}\n', '\t\telse if (nCurrentStage == BaseEscrowLib.GetContractStageLiving())\n', '\t\t{\n', '\t\t\tnPotentialBillableDays = (int)(nCurrentDate - self._MoveInDate) / (60 * 60 * 24);\n', '\t\t\t\n', '\t\t\tif (self._ActualMoveOutDate == 0)\n', '\t\t\t{\n', '\t\t\t\t//If landlord initiates it, he cannot claim sec deposit\n', '\t\t\t\trequire(nActualBalance >= nPotentialBillableDays * self._RentPerDay);\n', '\t\t\t\tstate = BaseEscrowLib.GetContractStateEarlyTerminatedByLandlord();\n', '\t\t\t\tlandlBal = nPotentialBillableDays * self._RentPerDay;\n', '\t\t\t\ttenantBal = nActualBalance - landlBal;\n', '\t\t\t\tbProcessed = true;\n', '\t\t\t\tBaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageInfo(), nCurrentDate, sGuid, "Landlord signaled early move-out");\n', '\t\t\t}\n', '\t\t\telse{\n', '\t\t\t\t//If tenant initiates it, landlord can claim sec deposit, and tenant pays for one extra day\n', '\t\t\t\trequire(int(SecDeposit) <= self._SecDeposit && nActualBalance >= (nPotentialBillableDays + 1) * self._RentPerDay + int(SecDeposit));\n', '\t\t\t\t\n', '\t\t\t\tif (SecDeposit == 0)\n', '\t\t\t\t{\n', '\t\t\t\t\tstate = BaseEscrowLib.GetContractStateEarlyTerminatedByTenant();\n', '\t\t\t\t}\n', '\t\t\t\telse\n', '\t\t\t\t{\n', '\t\t\t\t\tBaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageInfo(), nCurrentDate, sGuid, "Landlord signaled Security Deposit");\n', '\t\t\t\t\tstate = BaseEscrowLib.GetContractStateEarlyTerminatedByTenantSecDep();\n', '\t\t\t\t}\n', '\n', '\t\t\t\tlandlBal = (nPotentialBillableDays + 1) * self._RentPerDay + int(SecDeposit);\n', '\t\t\t\ttenantBal = nActualBalance - landlBal;\n', '\t\t\t\tbProcessed = true;\n', '\t\t\t}\n', '\t\t}\n', '\t\telse if (nCurrentStage == BaseEscrowLib.GetContractStageTermination())\n', '\t\t{\n', '\t\t\tnPotentialBillableDays = (int)(self._MoveOutDate - self._MoveInDate) / (60 * 60 * 24);\n', '\t\t\trequire(int(SecDeposit) <= self._SecDeposit && nActualBalance >= nPotentialBillableDays * self._RentPerDay + int(SecDeposit));\n', '\t\t\tif (SecDeposit == 0)\n', '\t\t\t{\n', '\t\t\t\tstate = BaseEscrowLib.GetContractStateTerminatedOK();\n', '\t\t\t}\n', '\t\t\telse\n', '\t\t\t{\n', '\t\t\t\tBaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageInfo(), nCurrentDate, sGuid, "Landlord signaled Security Deposit");\n', '\t\t\t\tstate = BaseEscrowLib.GetContractStateTerminatedSecDep();\n', '\t\t\t}\n', '\t\t\tlandlBal = nPotentialBillableDays * self._RentPerDay + int(SecDeposit);\n', '\t\t\ttenantBal = nActualBalance - landlBal;\n', '\t\t\tbProcessed = true;\n', '\t\t}\n', '\n', '\t\trequire(bProcessed);\n', '\t\tif (state > 0)\n', '\t\t{\n', '\t\t\tBaseEscrowLib.TerminateContract(self,tenantBal,landlBal,state);\n', '\t\t}\t\n', '\t}\n', '}\n', '\n', 'library ModerateEscrowLib\n', '{\n', '\tusing BaseEscrowLib for BaseEscrowLib.EscrowContractState;\n', '\n', '    //Cancel days\n', '\tint internal constant FreeCancelBeforeMoveInDays = 30;\n', '\n', '\t//Expiration\n', '\tint internal constant ExpireAfterMoveOutDays = 14;\n', '\t\t    \n', '    \n', '\tfunction TenantTerminate(BaseEscrowLib.EscrowContractState storage self) public\n', '    {\n', '\t\tint nCurrentStage = BaseEscrowLib.GetCurrentStage(self);\n', '\t\tuint nCurrentDate = BaseEscrowLib.GetCurrentDate(self);\n', '\t\tint nActualBalance = int(BaseEscrowLib.GetContractBalance(self));\n', '\t\tint tenantBal = 0;\n', '\t\tint landlBal = 0;\n', '\t\tint state = 0; \n', '\t\tbool bProcessed = false;\n', '        string memory sGuid;\n', '        sGuid = self._Guid;\n', '\n', '\t\tif (nActualBalance == 0)\n', '\t\t{\n', '\t\t\t//If contract is unfunded, just cancel it\n', '\t\t\tstate = BaseEscrowLib.GetContractStateCancelledByTenant();\n', '\t\t\tbProcessed = true;\t\t\t\n', '\t\t}\n', '\t\telse if (nCurrentStage == BaseEscrowLib.GetContractStagePreMoveIn())\n', '\t\t{\t\t\t\n', '\t\t\tint nDaysBeforeMoveIn = (int)(self._MoveInDate - nCurrentDate) / (60 * 60 * 24);\n', '\t\t\tif (nDaysBeforeMoveIn < FreeCancelBeforeMoveInDays)\n', '\t\t\t{\n', '\t\t\t\t//Pay cancel fee\n', '\t\t\t\t//Contract must be fully funded\n', '\n', '\t\t\t\tint cancelFee = (self._TotalAmount - self._SecDeposit) / 2;\n', '\n', '\t\t\t\trequire(cancelFee <= nActualBalance);\n', '\n', '\t\t\t\t//Cancellation fee is half of the rent to pay\n', '\t\t\t\ttenantBal = nActualBalance - cancelFee;\n', '\t\t\t\tlandlBal = cancelFee;\n', '\t\t\t\tstate = BaseEscrowLib.GetContractStateCancelledByTenant();\n', '\t\t\t\tbProcessed = true;\n', '\n', '\t\t\t\tBaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageWarning(), nCurrentDate, sGuid, "Tenant cancelled escrow. Cancellation fee will be withheld from tenant.");\t\t\t\t\t\t\t\t\t\t\n', '\t\t\t}\n', '\t\t\telse\n', '\t\t\t{\n', '\t\t\t\t//No cancel fee\n', '\t\t\t\ttenantBal = nActualBalance;\n', '\t\t\t\tlandlBal = 0;\n', '\t\t\t\tstate = BaseEscrowLib.GetContractStateCancelledByTenant();\n', '\t\t\t\tbProcessed = true;\n', '\n', '\t\t\t\tBaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageWarning(), nCurrentDate, sGuid, "Tenant cancelled escrow.");\n', '\t\t\t}\t\t\t\t\t\n', '\t\t}\n', '\t\telse if (nCurrentStage == BaseEscrowLib.GetContractStageLiving())\n', '\t\t{\n', '\t\t\tstate = 0;\n', '\t\t\tself._ActualMoveOutDate = nCurrentDate;\n', '\t\t\tbProcessed = true;\n', '\t\t\t//In this case landlord will close escrow\n', '\n', '\t\t\tBaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageWarning(), nCurrentDate, sGuid, "Tenant signaled early move-out");\n', '\t\t}\n', '\t\telse if (nCurrentStage == BaseEscrowLib.GetContractStageTermination())\n', '\t\t{\n', '\t\t\t//If landlord did not close the escrow, and if it is expired, tenant may only pay for rent without sec deposit\n', '\t\t\tint nDaysAfterMoveOut = (int)(nCurrentDate - self._MoveOutDate) / (60 * 60 * 24);\n', '\n', '\t\t\tif (nDaysAfterMoveOut > ExpireAfterMoveOutDays)\n', '\t\t\t{\n', '\t\t\t\tint nPotentialBillableDays = (int)(self._MoveOutDate - self._MoveInDate) / (60 * 60 * 24);\n', '\t\t\t\trequire(self._RentPerDay * nPotentialBillableDays <= nActualBalance);\n', '\n', '\t\t\t\tlandlBal = self._RentPerDay * nPotentialBillableDays;\n', '\t\t\t\ttenantBal = nActualBalance - landlBal;\n', '\t\t\t\tbProcessed = true;\n', '\t\t\t\tstate = BaseEscrowLib.GetContractStateTerminatedOK();\n', '\n', '\t\t\t\tBaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageInfo(), nCurrentDate, sGuid, "Tenant closed escrow because it was expired");\n', '\t\t\t}\n', '\t\t}\n', '\n', '\t\trequire(bProcessed);\n', '\t\tif (state > 0)\n', '\t\t{\n', '\t\t\tBaseEscrowLib.TerminateContract(self,tenantBal,landlBal,state);\n', '\t\t}\n', '\n', '    }\n', '    \n', '    function TenantMoveIn(BaseEscrowLib.EscrowContractState storage self) public\n', '    {\n', '\t\tint nCurrentStage = BaseEscrowLib.GetCurrentStage(self);\n', '\t\tuint nCurrentDate = BaseEscrowLib.GetCurrentDate(self);\n', '\t\tint nActualBalance = int(BaseEscrowLib.GetContractBalance(self));\n', '        string memory sGuid;\n', '        sGuid = self._Guid;\n', '\t\t\t\t\n', '\t\trequire(nCurrentStage == BaseEscrowLib.GetContractStagePreMoveIn() && nActualBalance >= self._TotalAmount && \n', '\t\t\t\tDateTime.compareDateTimesForContract(nCurrentDate, self._MoveInDate) >= 0);\n', '\n', '        BaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageInfo(), nCurrentDate, sGuid, "Tenant signaled move-in");\n', '\n', '\t\tself._TenantConfirmedMoveIn = true;\n', '    } \n', '\t       \n', '    function TenantTerminateMisrep(BaseEscrowLib.EscrowContractState storage self) public\n', '    {\n', '\t\tint nCurrentStage = BaseEscrowLib.GetCurrentStage(self);\n', '\t\tuint nCurrentDate = BaseEscrowLib.GetCurrentDate(self);\n', '\t\tint nActualBalance = int(BaseEscrowLib.GetContractBalance(self));\n', '\t\tint tenantBal = 0;\n', '\t\tint landlBal = 0;\n', '\t\tint cancelFee = (self._TotalAmount - self._SecDeposit) / 2;\n', '        string memory sGuid;\n', '        sGuid = self._Guid;\n', '\n', '\t\trequire(nCurrentStage == BaseEscrowLib.GetContractStagePreMoveIn() && nActualBalance >= cancelFee && \n', '\t\t\t\tDateTime.compareDateTimesForContract(nCurrentDate, self._MoveInDate) == 0);\n', '\n', '\t\t(tenantBal, landlBal) = BaseEscrowLib.splitBalanceAccordingToRatings(cancelFee,0,0);\n', '\t\t\t\t\t\n', '\t\ttenantBal = nActualBalance - landlBal;\n', '\t\t\n', '\t\tBaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageWarning(), nCurrentDate, sGuid, "Tenant signaled misrepresentation and terminated escrow!");\n', '\t\tself._MisrepSignaled = true;\n', '\n', '\t\tBaseEscrowLib.TerminateContract(self,tenantBal,landlBal,BaseEscrowLib.GetContractStateTerminatedMisrep());\t         \n', '    }    \n', '\t\n', '\tfunction LandlordTerminate(BaseEscrowLib.EscrowContractState storage self, uint SecDeposit) public\n', '\t{\n', '\t\t//int nCurrentStage = BaseEscrowLib.GetCurrentStage(self);\n', '\t\tuint nCurrentDate = BaseEscrowLib.GetCurrentDate(self);\n', '\t\tint nActualBalance = int(BaseEscrowLib.GetContractBalance(self));\n', '\t\tint tenantBal = 0;\n', '\t\tint landlBal = 0;\n', '\t\tint state = 0; \n', '\t\tbool bProcessed = false;\n', '\t\tint nPotentialBillableDays = 0;\n', '\t\tint cancelFee = (self._TotalAmount - self._SecDeposit) / 2;\n', '        string memory sGuid;\n', '        sGuid = self._Guid;\n', '\n', '\t\tif (nActualBalance == 0)\n', '\t\t{\n', '\t\t\t//If contract is unfunded, just cancel it\n', '\t\t\tstate = BaseEscrowLib.GetContractStateCancelledByLandlord();\n', '\t\t\tbProcessed = true;\t\t\t\n', '\t\t}\n', '\t\telse if (BaseEscrowLib.GetCurrentStage(self) == BaseEscrowLib.GetContractStagePreMoveIn())\n', '\t\t{\t\n', '\t\t\tif (DateTime.compareDateTimesForContract(nCurrentDate, self._MoveInDate) > 0 && \n', '\t\t\t\t!self._TenantConfirmedMoveIn)\n', '\t\t\t{\n', '\t\t\t\t//Landlord gets cancell fee if tenant did not signal anything after move in date\n', '\t\t\t\ttenantBal = nActualBalance - cancelFee;\t\n', '\t\t\t\tlandlBal = cancelFee;\n', '\t\t\t\tstate = BaseEscrowLib.GetContractStateCancelledByLandlord();\n', '\t\t\t\tbProcessed = true;\n', '\t\t\t\tBaseEscrowLib.ContractLogEvent(BaseEscrowLib.GetCurrentStage(self), BaseEscrowLib.GetLogMessageWarning(), nCurrentDate, sGuid, "Landlord cancelled escrow. Tenant did not show up and will pay cancellation fee.");\t\t\t\t\t\t\t\t\n', '\t\t\t}\n', '\t\t\telse\n', '\t\t\t{\t\t        \t\t\t\t\n', '\t\t\t\t//No cancel fee\n', '\t\t\t\ttenantBal = nActualBalance;\n', '\t\t\t\tlandlBal = 0;\n', '\t\t\t\tstate = BaseEscrowLib.GetContractStateCancelledByLandlord();\n', '\t\t\t\tbProcessed = true;\n', '\t\t\t\tBaseEscrowLib.ContractLogEvent(BaseEscrowLib.GetCurrentStage(self), BaseEscrowLib.GetLogMessageInfo(), nCurrentDate, sGuid, "Landlord cancelled esqrow");\t\t\t\t\t\t\t\t\n', '\t\t\t}\n', '\t\t}\n', '\t\telse if (BaseEscrowLib.GetCurrentStage(self) == BaseEscrowLib.GetContractStageLiving())\n', '\t\t{\n', '\t\t\tnPotentialBillableDays = (int)(nCurrentDate - self._MoveInDate) / (60 * 60 * 24);\n', '\t\t\t\n', '\t\t\tif (self._ActualMoveOutDate == 0)\n', '\t\t\t{\n', '\t\t\t\t//If landlord initiates it, he cannot claim sec deposit\n', '\t\t\t\trequire(nActualBalance >= nPotentialBillableDays * self._RentPerDay);\n', '\t\t\t\tstate = BaseEscrowLib.GetContractStateEarlyTerminatedByLandlord();\n', '\t\t\t\tlandlBal = nPotentialBillableDays * self._RentPerDay;\n', '\t\t\t\ttenantBal = nActualBalance - landlBal;\n', '\t\t\t\tbProcessed = true;\n', '\t\t\t\tBaseEscrowLib.ContractLogEvent(BaseEscrowLib.GetCurrentStage(self), BaseEscrowLib.GetLogMessageInfo(), nCurrentDate, sGuid, "Landlord signaled early move-out");\n', '\t\t\t}\n', '\t\t\telse{\n', '\t\t\t\t//If tenant initiates it, landlord can claim sec deposit, and tenant pays cancellation fee\n', '\t\t\t\tint nContractBillableDays = (int)(self._MoveOutDate - self._MoveInDate) / (60 * 60 * 24);\n', '\t\t\t\tcancelFee = (nContractBillableDays - nPotentialBillableDays) * self._RentPerDay / 2;\n', '\n', '\t\t\t\trequire(int(SecDeposit) <= self._SecDeposit && nActualBalance >= (nPotentialBillableDays * self._RentPerDay + int(SecDeposit) + cancelFee));\n', '\t\t\t\t\n', '\t\t\t\tif (SecDeposit == 0)\n', '\t\t\t\t{\n', '\t\t\t\t\tstate = BaseEscrowLib.GetContractStateEarlyTerminatedByTenant();\n', '\t\t\t\t}\n', '\t\t\t\telse\n', '\t\t\t\t{\n', '\t\t\t\t\tBaseEscrowLib.ContractLogEvent(BaseEscrowLib.GetCurrentStage(self), BaseEscrowLib.GetLogMessageInfo(), nCurrentDate, sGuid, "Landlord signaled Security Deposit");\n', '\t\t\t\t\tstate = BaseEscrowLib.GetContractStateEarlyTerminatedByTenantSecDep();\n', '\t\t\t\t}\n', '\n', '\t\t\t\tlandlBal = nPotentialBillableDays * self._RentPerDay + int(SecDeposit) + cancelFee;\n', '\t\t\t\ttenantBal = nActualBalance - landlBal;\n', '\t\t\t\tbProcessed = true;\n', '\t\t\t}\n', '\t\t}\n', '\t\telse if (BaseEscrowLib.GetCurrentStage(self) == BaseEscrowLib.GetContractStageTermination())\n', '\t\t{\n', '\t\t\tnPotentialBillableDays = (int)(self._MoveOutDate - self._MoveInDate) / (60 * 60 * 24);\n', '\t\t\trequire(int(SecDeposit) <= self._SecDeposit && nActualBalance >= nPotentialBillableDays * self._RentPerDay + int(SecDeposit));\n', '\t\t\tif (SecDeposit == 0)\n', '\t\t\t{\n', '\t\t\t\tstate = BaseEscrowLib.GetContractStateTerminatedOK();\n', '\t\t\t}\n', '\t\t\telse\n', '\t\t\t{\n', '\t\t\t\tBaseEscrowLib.ContractLogEvent(BaseEscrowLib.GetCurrentStage(self), BaseEscrowLib.GetLogMessageInfo(), nCurrentDate, sGuid, "Landlord signaled Security Deposit");\n', '\t\t\t\tstate = BaseEscrowLib.GetContractStateTerminatedSecDep();\n', '\t\t\t}\n', '\t\t\tlandlBal = nPotentialBillableDays * self._RentPerDay + int(SecDeposit);\n', '\t\t\ttenantBal = nActualBalance - landlBal;\n', '\t\t\tbProcessed = true;\n', '\t\t}\n', '\n', '\t\trequire(bProcessed);\n', '\t\tif (state > 0)\n', '\t\t{\n', '\t\t\tBaseEscrowLib.TerminateContract(self,tenantBal,landlBal,state);\n', '\t\t}\t\n', '\t}\n', '}\n', '\n', 'library StrictEscrowLib\n', '{\n', '\tusing BaseEscrowLib for BaseEscrowLib.EscrowContractState;\n', '\n', '    //Cancel days\n', '\tint internal constant FreeCancelBeforeMoveInDays = 60;\n', '\n', '\t//Expiration\n', '\tint internal constant ExpireAfterMoveOutDays = 14;\n', '\t\t    \n', '    \n', '\tfunction TenantTerminate(BaseEscrowLib.EscrowContractState storage self) public\n', '    {\n', '\t\tint nCurrentStage = BaseEscrowLib.GetCurrentStage(self);\n', '\t\tuint nCurrentDate = BaseEscrowLib.GetCurrentDate(self);\n', '\t\tint nActualBalance = int(BaseEscrowLib.GetContractBalance(self));\n', '\t\tint tenantBal = 0;\n', '\t\tint landlBal = 0;\n', '\t\tint state = 0; \n', '\t\tbool bProcessed = false;\n', '        string memory sGuid;\n', '        sGuid = self._Guid;\n', '\n', '\n', '\t\tif (nActualBalance == 0)\n', '\t\t{\n', '\t\t\t//If contract is unfunded, just cancel it\n', '\t\t\tstate = BaseEscrowLib.GetContractStateCancelledByTenant();\n', '\t\t\tbProcessed = true;\t\t\t\n', '\t\t}\n', '\t\telse if (nCurrentStage == BaseEscrowLib.GetContractStagePreMoveIn())\n', '\t\t{\t\t\t\n', '\t\t\tint nDaysBeforeMoveIn = (int)(self._MoveInDate - nCurrentDate) / (60 * 60 * 24);\n', '\t\t\tif (nDaysBeforeMoveIn < FreeCancelBeforeMoveInDays)\n', '\t\t\t{\n', '\t\t\t\t//Pay cancel fee\n', '\t\t\t\tint cancelFee = self._TotalAmount - self._SecDeposit;\n', '\n', '\t\t\t\t//Contract must be fully funded\n', '\t\t\t\trequire(cancelFee <= nActualBalance);\n', '\n', '\t\t\t\t//Cancel fee is the whole rent\n', '\t\t\t\ttenantBal = nActualBalance - cancelFee;\n', '\t\t\t\tlandlBal = cancelFee;\n', '\t\t\t\tstate = BaseEscrowLib.GetContractStateCancelledByTenant();\n', '\t\t\t\tbProcessed = true;\n', '\n', '\t\t\t\tBaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageWarning(), nCurrentDate, sGuid, "Tenant cancelled escrow. Cancellation fee will be withheld from tenant.");\t\t\t\t\t\t\t\t\t\t\n', '\t\t\t}\n', '\t\t\telse\n', '\t\t\t{\n', '\t\t\t\t//No cancel fee\n', '\t\t\t\ttenantBal = nActualBalance;\n', '\t\t\t\tlandlBal = 0;\n', '\t\t\t\tstate = BaseEscrowLib.GetContractStateCancelledByTenant();\n', '\t\t\t\tbProcessed = true;\n', '\n', '\t\t\t\tBaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageWarning(), nCurrentDate, sGuid, "Tenant cancelled escrow.");\n', '\t\t\t}\t\t\t\t\t\n', '\t\t}\n', '\t\telse if (nCurrentStage == BaseEscrowLib.GetContractStageTermination())\n', '\t\t{\n', '\t\t\t//If landlord did not close the escrow, and if it is expired, tenant may only pay for rent without sec deposit\n', '\t\t\tint nDaysAfterMoveOut = (int)(nCurrentDate - self._MoveOutDate) / (60 * 60 * 24);\n', '\n', '\t\t\tif (nDaysAfterMoveOut > ExpireAfterMoveOutDays)\n', '\t\t\t{\n', '\t\t\t\tint nPotentialBillableDays = (int)(self._MoveOutDate - self._MoveInDate) / (60 * 60 * 24);\n', '\t\t\t\trequire(self._RentPerDay * nPotentialBillableDays <= nActualBalance);\n', '\n', '\t\t\t\tlandlBal = self._RentPerDay * nPotentialBillableDays;\n', '\t\t\t\ttenantBal = nActualBalance - landlBal;\n', '\t\t\t\tbProcessed = true;\n', '\t\t\t\tstate = BaseEscrowLib.GetContractStateTerminatedOK();\n', '\n', '\t\t\t\tBaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageInfo(), nCurrentDate, sGuid, "Tenant closed escrow because it was expired");\n', '\t\t\t}\n', '\t\t}\n', '\n', '\t\trequire(bProcessed);\n', '\t\tif (state > 0)\n', '\t\t{\n', '\t\t\tBaseEscrowLib.TerminateContract(self,tenantBal,landlBal,state);\n', '\t\t}\n', '    }\n', '    \n', '    function TenantMoveIn(BaseEscrowLib.EscrowContractState storage self) public\n', '    {\n', '\t\tint nCurrentStage = BaseEscrowLib.GetCurrentStage(self);\n', '\t\tuint nCurrentDate = BaseEscrowLib.GetCurrentDate(self);\n', '\t\tint nActualBalance = int(BaseEscrowLib.GetContractBalance(self));\n', '        string memory sGuid;\n', '        sGuid = self._Guid;\n', '\n', '\t\t\t\t\n', '\t\trequire(nCurrentStage == BaseEscrowLib.GetContractStagePreMoveIn() && nActualBalance >= self._TotalAmount && \n', '\t\t\t\tDateTime.compareDateTimesForContract(nCurrentDate, self._MoveInDate) >= 0);\n', '\n', '        BaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageInfo(), nCurrentDate, sGuid, "Tenant signaled move-in");\n', '\n', '\t\tself._TenantConfirmedMoveIn = true;\n', '    } \n', '\t       \n', '    function TenantTerminateMisrep(BaseEscrowLib.EscrowContractState storage self) public\n', '    {\n', '\t\tint nCurrentStage = BaseEscrowLib.GetCurrentStage(self);\n', '\t\tuint nCurrentDate = BaseEscrowLib.GetCurrentDate(self);\n', '\t\tint nActualBalance = int(BaseEscrowLib.GetContractBalance(self));\n', '\t\tint tenantBal = 0;\n', '\t\tint landlBal = 0;\n', '\t\tint cancelFee = self._TotalAmount - self._SecDeposit;\n', '        string memory sGuid;\n', '        sGuid = self._Guid;\n', '\n', '\t\trequire(nCurrentStage == BaseEscrowLib.GetContractStagePreMoveIn() && nActualBalance >= cancelFee && \n', '\t\t\t\tDateTime.compareDateTimesForContract(nCurrentDate, self._MoveInDate) == 0);\n', '\t\t\n', '\t\t//For strict escrow, give everything to landl\n', '\t\tlandlBal = cancelFee;\t\t\t\n', '\t\ttenantBal = nActualBalance - landlBal;\n', '\t\t\n', '\t\tBaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageWarning(), nCurrentDate, sGuid, "Tenant signaled misrepresentation and terminated escrow!");\n', '\t\tself._MisrepSignaled = true;\n', '\n', '\t\tBaseEscrowLib.TerminateContract(self,tenantBal,landlBal,BaseEscrowLib.GetContractStateTerminatedMisrep());    \n', '\t}    \n', '\t\n', '\tfunction LandlordTerminate(BaseEscrowLib.EscrowContractState storage self, uint SecDeposit) public\n', '\t{\n', '\t\tint nCurrentStage = BaseEscrowLib.GetCurrentStage(self);\n', '\t\tuint nCurrentDate = BaseEscrowLib.GetCurrentDate(self);\n', '\t\tint nActualBalance = int(BaseEscrowLib.GetContractBalance(self));\n', '\t\tint tenantBal = 0;\n', '\t\tint landlBal = 0;\n', '\t\tint state = 0; \n', '\t\tbool bProcessed = false;\n', '\t\tint nPotentialBillableDays = 0;\n', '\t\tint cancelFee = self._TotalAmount - self._SecDeposit;\n', '        string memory sGuid;\n', '        sGuid = self._Guid;\n', '\n', '\t\tif (nActualBalance == 0)\n', '\t\t{\n', '\t\t\t//If contract is unfunded, just cancel it\n', '\t\t\tstate = BaseEscrowLib.GetContractStateCancelledByLandlord();\n', '\t\t\tbProcessed = true;\t\t\t\n', '\t\t}\n', '\t\telse if (nCurrentStage == BaseEscrowLib.GetContractStagePreMoveIn())\n', '\t\t{\t\n', '\t\t\tif (DateTime.compareDateTimesForContract(nCurrentDate, self._MoveInDate) > 0 && \n', '\t\t\t\t!self._TenantConfirmedMoveIn)\n', '\t\t\t{\n', '\t\t\t\t//Landlord gets cancell fee if tenant did not signal anything after move in date\n', '\t\t\t\ttenantBal = nActualBalance - cancelFee;\t\n', '\t\t\t\tlandlBal = cancelFee;\n', '\t\t\t\tstate = BaseEscrowLib.GetContractStateCancelledByLandlord();\n', '\t\t\t\tbProcessed = true;\n', '\t\t\t\tBaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageWarning(), nCurrentDate, sGuid, "Landlord cancelled escrow. Tenant did not show up and will pay cancellation fee.");\t\t\t\t\t\t\t\t\n', '\t\t\t}\n', '\t\t\telse\n', '\t\t\t{\t\t        \t\t\t\t\n', '\t\t\t\t//No cancel fee\n', '\t\t\t\ttenantBal = nActualBalance;\n', '\t\t\t\tlandlBal = 0;\n', '\t\t\t\tstate = BaseEscrowLib.GetContractStateCancelledByLandlord();\n', '\t\t\t\tbProcessed = true;\n', '\t\t\t\tBaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageInfo(), nCurrentDate, sGuid, "Landlord cancelled esqrow");\t\t\t\t\t\t\t\t\n', '\t\t\t}\n', '\t\t}\n', '\t\telse if (nCurrentStage == BaseEscrowLib.GetContractStageLiving())\n', '\t\t{\n', '\t\t\tnPotentialBillableDays = (int)(self._MoveOutDate - self._MoveInDate) / (60 * 60 * 24);\n', '\t\t\t\n', '\n', '\t\t\t//If landlord initiates it, he cannot claim sec deposit\n', '\t\t\trequire(nActualBalance >= nPotentialBillableDays * self._RentPerDay);\n', '\t\t\tstate = BaseEscrowLib.GetContractStateEarlyTerminatedByLandlord();\n', '\t\t\tlandlBal = nPotentialBillableDays * self._RentPerDay;\n', '\t\t\ttenantBal = nActualBalance - landlBal;\n', '\t\t\tbProcessed = true;\n', '\t\t\tBaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageInfo(), nCurrentDate, sGuid, "Landlord signaled early move-out");\t\t\t\n', '\t\t}\n', '\t\telse if (nCurrentStage == BaseEscrowLib.GetContractStageTermination())\n', '\t\t{\n', '\t\t\tnPotentialBillableDays = (int)(self._MoveOutDate - self._MoveInDate) / (60 * 60 * 24);\n', '\t\t\trequire(int(SecDeposit) <= self._SecDeposit && nActualBalance >= nPotentialBillableDays * self._RentPerDay + int(SecDeposit));\n', '\t\t\tif (SecDeposit == 0)\n', '\t\t\t{\n', '\t\t\t\tstate = BaseEscrowLib.GetContractStateTerminatedOK();\n', '\t\t\t}\n', '\t\t\telse\n', '\t\t\t{\n', '\t\t\t\tBaseEscrowLib.ContractLogEvent(nCurrentStage, BaseEscrowLib.GetLogMessageInfo(), nCurrentDate, sGuid, "Landlord signaled Security Deposit");\n', '\t\t\t\tstate = BaseEscrowLib.GetContractStateTerminatedSecDep();\n', '\t\t\t}\n', '\t\t\tlandlBal = nPotentialBillableDays * self._RentPerDay + int(SecDeposit);\n', '\t\t\ttenantBal = nActualBalance - landlBal;\n', '\t\t\tbProcessed = true;\n', '\t\t}\n', '\n', '\t\trequire(bProcessed);\n', '\t\tif (state > 0)\n', '\t\t{\n', '\t\t\tBaseEscrowLib.TerminateContract(self,tenantBal,landlBal,state);\n', '\t\t}\t\n', '\t}\n', '}\n', '\n', '/**\n', ' * @title Ownable\n', ' * @dev The Ownable contract has an owner address, and provides basic authorization control\n', ' * functions, this simplifies the implementation of "user permissions".\n', ' */\n', 'contract Ownable {\n', '  address private owner_;\n', '\n', '  \n', '  event OwnershipTransferred(\n', '    address indexed previousOwner,\n', '    address indexed newOwner\n', '  );\n', '\n', '\n', '  /**\n', '   * @dev The Ownable constructor sets the original `owner` of the contract to the sender\n', '   * account.\n', '   */\n', '  function Ownable() public {\n', '    owner_ = msg.sender;\n', '  }\n', '\n', '  /**\n', '   * @return the address of the owner.\n', '   */\n', '  function owner() public constant returns(address) {\n', '    return owner_;\n', '  }\n', '\n', '  /**\n', '   * @dev Throws if called by any account other than the owner.\n', '   */\n', '  modifier onlyOwner() {\n', '    require(msg.sender == owner_);\n', '    _;\n', '  }\n', '\n', '\n', '  /**\n', '   * @dev Allows the current owner to transfer control of the contract to a newOwner.\n', '   * @param _newOwner The address to transfer ownership to.\n', '   */\n', '  function transferOwnership(address _newOwner) public onlyOwner {\n', '    _transferOwnership(_newOwner);\n', '  }\n', '\n', '  /**\n', '   * @dev Transfers control of the contract to a newOwner.\n', '   * @param _newOwner The address to transfer ownership to.\n', '   */\n', '  function _transferOwnership(address _newOwner) internal {\n', '    require(_newOwner != address(0));\n', '    OwnershipTransferred(owner_, _newOwner);\n', '    owner_ = _newOwner;\n', '  }\n', '}\n', '\n', 'contract StayBitContractFactory is Ownable\n', '{\n', '    struct EscrowTokenInfo { \n', '\t\tuint _RentMin;  //Min value for rent per day\n', '\t\tuint _RentMax;  //Max value for rent per day\n', '\t\taddress _ContractAddress; //Token address\n', '\t\tuint _ContractFeeBal;  //Earned balance\n', '    }\n', '\n', '\tusing BaseEscrowLib for BaseEscrowLib.EscrowContractState;\n', '    mapping(bytes32 => BaseEscrowLib.EscrowContractState) private contracts;\n', '\tmapping(uint => EscrowTokenInfo) private supportedTokens;\n', '\tbool private CreateEnabled; // Enables / disables creation of new contracts\n', '\tbool private PercentageFee;  // true - percentage fee per contract false - fixed fee per contract\n', '\tuint ContractFee;  //Either fixed amount or percentage\n', '\t\t\n', '\tevent contractCreated(int rentPerDay, int cancelPolicy, uint moveInDate, uint moveOutDate, int secDeposit, address landlord, uint tokenId, int Id, string Guid, uint extraAmount);\n', '\tevent contractTerminated(int Id, string Guid, int State);\n', '\n', '\tfunction StayBitContractFactory()\n', '\t{\n', '\t\tCreateEnabled = true;\n', '\t\tPercentageFee = false;\n', '\t\tContractFee = 0;\n', '\t}\n', '\n', '\tfunction SetFactoryParams(bool enable, bool percFee, uint contrFee) public onlyOwner\n', '\t{\n', '\t\tCreateEnabled = enable;\t\n', '\t\tPercentageFee = percFee;\n', '\t\tContractFee = contrFee;\n', '\t}\n', '\n', '\tfunction GetFeeBalance(uint tokenId) public constant returns (uint)\n', '\t{\n', '\t\treturn supportedTokens[tokenId]._ContractFeeBal;\n', '\t}\n', '\n', '\tfunction WithdrawFeeBalance(uint tokenId, address to, uint amount) public onlyOwner\n', '\t{\t    \n', '\t\trequire(supportedTokens[tokenId]._RentMax > 0);\t\t\n', '\t\trequire(supportedTokens[tokenId]._ContractFeeBal >= amount);\t\t\n', '\t\tsupportedTokens[tokenId]._ContractFeeBal -= amount;\t\t\n', '\t\tERC20Interface tokenApi = ERC20Interface(supportedTokens[tokenId]._ContractAddress);\n', '\t\ttokenApi.transfer(to, amount);\n', '\t}\n', '\n', '\n', '\tfunction SetTokenInfo(uint tokenId, address tokenAddress, uint rentMin, uint rentMax) public onlyOwner\n', '\t{\n', '\t\tsupportedTokens[tokenId]._RentMin = rentMin;\n', '\t\tsupportedTokens[tokenId]._RentMax = rentMax;\n', '\t\tsupportedTokens[tokenId]._ContractAddress = tokenAddress;\n', '\t}\n', '\n', '\tfunction CalculateCreateFee(uint amount) public constant returns (uint)\n', '\t{\n', '\t\tuint result = 0;\n', '\t\tif (PercentageFee)\n', '\t\t{\n', '\t\t\tresult = amount * ContractFee / 100;\n', '\t\t}\n', '\t\telse\n', '\t\t{\n', '\t\t\tresult = ContractFee;\n', '\t\t}\n', '\t\treturn result;\n', '\t}\n', '\n', '\n', '    //75, 1, 1533417601, 1534281601, 100, "0x4b0897b0513fdc7c541b6d9d7e929c4e5364d2db", "", "0x4514d8d91a10bda73c10e2b8ffd99cb9646620a9", 1, "test"\n', '\tfunction CreateContract(int rentPerDay, int cancelPolicy, uint moveInDate, uint moveOutDate, int secDeposit, address landlord, string doorLockData, uint tokenId, int Id, string Guid, uint extraAmount) public\n', '\t{\n', '\t\t//It must be enabled\n', '\t\trequire (CreateEnabled && rentPerDay > 0 && secDeposit > 0 && moveInDate > 0 && moveOutDate > 0 && landlord != address(0) && landlord != msg.sender && Id > 0);\n', '\n', '\t\t//Token must be supported\n', '\t\trequire(supportedTokens[tokenId]._RentMax > 0);\n', '\n', '\t\t//Rent per day values must be within range for this token\n', '\t\trequire(supportedTokens[tokenId]._RentMin <= uint(rentPerDay) && supportedTokens[tokenId]._RentMax >= uint(rentPerDay));\n', '\n', '\t\t//Check that we support cancel policy\n', '\t\t//TESTNET\n', '\t\t//require (cancelPolicy == 1 || cancelPolicy == 2 || cancelPolicy == 3);\n', '\n', '\t\t//PRODUCTION\n', '\t\trequire (cancelPolicy == 1 || cancelPolicy == 2);\n', '\n', '\t\t//Check that GUID does not exist\t\t\n', '\t\trequire (contracts[keccak256(Guid)]._Id == 0);\n', '\n', '\t\tcontracts[keccak256(Guid)]._CurrentDate = now;\n', '\t\tcontracts[keccak256(Guid)]._CreatedDate = now;\n', '\t\tcontracts[keccak256(Guid)]._RentPerDay = rentPerDay;\n', '\t\tcontracts[keccak256(Guid)]._MoveInDate = moveInDate;\n', '\t\tcontracts[keccak256(Guid)]._MoveOutDate = moveOutDate;\n', '\t\tcontracts[keccak256(Guid)]._SecDeposit = secDeposit;\n', '\t\tcontracts[keccak256(Guid)]._DoorLockData = doorLockData;\n', '\t\tcontracts[keccak256(Guid)]._landlord = landlord;\n', '\t\tcontracts[keccak256(Guid)]._tenant = msg.sender;\n', '\t\tcontracts[keccak256(Guid)]._ContractAddress = this;\t\t\n', '\t\tcontracts[keccak256(Guid)]._tokenApi = ERC20Interface(supportedTokens[tokenId]._ContractAddress);\n', '\t\tcontracts[keccak256(Guid)]._Id = Id;\n', '\t\tcontracts[keccak256(Guid)]._Guid = Guid;\n', '\t\tcontracts[keccak256(Guid)]._CancelPolicy = cancelPolicy;\n', '\n', '\t\tcontracts[keccak256(Guid)].initialize();\n', '\n', '\t\tuint256 startBalance = contracts[keccak256(Guid)]._tokenApi.balanceOf(this);\n', '\n', '\t\t//Calculate our fees\n', '\t\tsupportedTokens[tokenId]._ContractFeeBal += CalculateCreateFee(uint(contracts[keccak256(Guid)]._TotalAmount));\n', '\n', '\t\t//Check that tenant has funds\n', '\t\trequire(extraAmount + uint(contracts[keccak256(Guid)]._TotalAmount) + CalculateCreateFee(uint(contracts[keccak256(Guid)]._TotalAmount)) <= contracts[keccak256(Guid)]._tokenApi.balanceOf(msg.sender));\n', '\n', '\t\t//Fund. Token fee, if any, will be witheld here \n', '\t\tcontracts[keccak256(Guid)]._tokenApi.transferFrom(msg.sender, this, extraAmount + uint(contracts[keccak256(Guid)]._TotalAmount) + CalculateCreateFee(uint(contracts[keccak256(Guid)]._TotalAmount)));\n', '\n', '\t\t//We need to measure balance diff because some tokens (TrueUSD) charge fees per transfer\n', '\t\tcontracts[keccak256(Guid)]._Balance = contracts[keccak256(Guid)]._tokenApi.balanceOf(this) - startBalance - CalculateCreateFee(uint(contracts[keccak256(Guid)]._TotalAmount));\n', '\n', "\t\t//Check that balance is still greater than contract's amount\n", '\t\trequire(contracts[keccak256(Guid)]._Balance >= uint(contracts[keccak256(Guid)]._TotalAmount));\n', '\n', '\t\t//raise event\n', '\t\tcontractCreated(rentPerDay, cancelPolicy, moveInDate, moveOutDate, secDeposit, landlord, tokenId, Id, Guid, extraAmount);\n', '\t}\n', '\n', '\tfunction() payable\n', '\t{\t\n', '\t\trevert();\n', '\t}\n', '\n', '\tfunction SimulateCurrentDate(uint n, string Guid) public {\n', '\t    if (contracts[keccak256(Guid)]._Id != 0)\n', '\t\t{\n', '\t\t\tcontracts[keccak256(Guid)].SimulateCurrentDate(n);\n', '\t\t}\n', '\t}\n', '\t\n', '\t\n', '\tfunction GetContractInfo(string Guid) public constant returns (uint curDate, int escrState, int escrStage, bool tenantMovedIn, uint actualBalance, bool misrepSignaled, string doorLockData, int calcAmount, uint actualMoveOutDate, int cancelPolicy)\n', '\t{\n', '\t\tif (contracts[keccak256(Guid)]._Id != 0)\n', '\t\t{\n', '\t\t\tactualBalance = contracts[keccak256(Guid)].GetContractBalance();\n', '\t\t\tcurDate = contracts[keccak256(Guid)].GetCurrentDate();\n', '\t\t\ttenantMovedIn = contracts[keccak256(Guid)]._TenantConfirmedMoveIn;\n', '\t\t\tmisrepSignaled = contracts[keccak256(Guid)]._MisrepSignaled;\n', '\t\t\tdoorLockData = contracts[keccak256(Guid)]._DoorLockData;\n', '\t\t\tescrStage = contracts[keccak256(Guid)].GetCurrentStage();\n', '\t\t\tescrState = contracts[keccak256(Guid)]._State;\n', '\t\t\tcalcAmount = contracts[keccak256(Guid)]._TotalAmount;\n', '\t\t\tactualMoveOutDate = contracts[keccak256(Guid)]._ActualMoveOutDate;\n', '\t\t\tcancelPolicy = contracts[keccak256(Guid)]._CancelPolicy;\n', '\t\t}\n', '\t}\n', '\t\t\n', '\tfunction TenantTerminate(string Guid) public\n', '\t{\n', '\t\tif (contracts[keccak256(Guid)]._Id != 0)\n', '\t\t{\n', '\t\t\trequire(contracts[keccak256(Guid)]._State == BaseEscrowLib.GetContractStateActive() && msg.sender == contracts[keccak256(Guid)]._tenant);\n', '\n', '\t\t\tif (contracts[keccak256(Guid)]._CancelPolicy == 1)\n', '\t\t\t{\n', '\t\t\t\tFlexibleEscrowLib.TenantTerminate(contracts[keccak256(Guid)]);\n', '\t\t\t}\n', '\t\t\telse if (contracts[keccak256(Guid)]._CancelPolicy == 2)\n', '\t\t\t{\n', '\t\t\t\tModerateEscrowLib.TenantTerminate(contracts[keccak256(Guid)]);\n', '\t\t\t}\n', '\t\t\telse if (contracts[keccak256(Guid)]._CancelPolicy == 3)\n', '\t\t\t{\n', '\t\t\t\tStrictEscrowLib.TenantTerminate(contracts[keccak256(Guid)]);\n', '\t\t\t}\n', '\t\t\telse{\n', '\t\t\t\trevert();\n', '\t\t\t\treturn;\n', '\t\t\t}\n', '\n', '\t\t\tSendTokens(Guid);\n', '\n', '\t\t\t//Raise event\n', '\t\t\tcontractTerminated(contracts[keccak256(Guid)]._Id, Guid, contracts[keccak256(Guid)]._State);\n', '\n', '\t\t}\n', '\t}\n', '\n', '\tfunction TenantTerminateMisrep(string Guid) public\n', '\t{\t\n', '\t\tif (contracts[keccak256(Guid)]._Id != 0)\n', '\t\t{\n', '\t\t\trequire(contracts[keccak256(Guid)]._State == BaseEscrowLib.GetContractStateActive() && msg.sender == contracts[keccak256(Guid)]._tenant);\n', '\n', '\t\t\tif (contracts[keccak256(Guid)]._CancelPolicy == 1)\n', '\t\t\t{\n', '\t\t\t\tFlexibleEscrowLib.TenantTerminateMisrep(contracts[keccak256(Guid)]);\n', '\t\t\t}\n', '\t\t\telse if (contracts[keccak256(Guid)]._CancelPolicy == 2)\n', '\t\t\t{\n', '\t\t\t\tModerateEscrowLib.TenantTerminateMisrep(contracts[keccak256(Guid)]);\n', '\t\t\t}\n', '\t\t\telse if (contracts[keccak256(Guid)]._CancelPolicy == 3)\n', '\t\t\t{\n', '\t\t\t\tStrictEscrowLib.TenantTerminateMisrep(contracts[keccak256(Guid)]);\n', '\t\t\t}\n', '\t\t\telse{\n', '\t\t\t\trevert();\n', '\t\t\t\treturn;\n', '\t\t\t}\n', '\n', '\t\t\tSendTokens(Guid);\n', '\n', '\t\t\t//Raise event\n', '\t\t\tcontractTerminated(contracts[keccak256(Guid)]._Id, Guid, contracts[keccak256(Guid)]._State);\n', '\t\t}\n', '\t}\n', '    \n', '\tfunction TenantMoveIn(string Guid) public\n', '\t{\t\n', '\t\tif (contracts[keccak256(Guid)]._Id != 0)\n', '\t\t{\n', '\t\t\trequire(contracts[keccak256(Guid)]._State == BaseEscrowLib.GetContractStateActive() && msg.sender == contracts[keccak256(Guid)]._tenant);\n', '\n', '\t\t\tif (contracts[keccak256(Guid)]._CancelPolicy == 1)\n', '\t\t\t{\n', '\t\t\t\tFlexibleEscrowLib.TenantMoveIn(contracts[keccak256(Guid)]);\n', '\t\t\t}\n', '\t\t\telse if (contracts[keccak256(Guid)]._CancelPolicy == 2)\n', '\t\t\t{\n', '\t\t\t\tModerateEscrowLib.TenantMoveIn(contracts[keccak256(Guid)]);\n', '\t\t\t}\n', '\t\t\telse if (contracts[keccak256(Guid)]._CancelPolicy == 3)\n', '\t\t\t{\n', '\t\t\t\tStrictEscrowLib.TenantMoveIn(contracts[keccak256(Guid)]);\n', '\t\t\t}\n', '\t\t\telse{\n', '\t\t\t\trevert();\n', '\t\t\t}\n', '\t\t}\n', '\t}\n', '\n', '\tfunction LandlordTerminate(uint SecDeposit, string Guid) public\n', '\t{\t\t\n', '\t\tif (contracts[keccak256(Guid)]._Id != 0)\n', '\t\t{\n', '\t\t\trequire(SecDeposit >= 0 && SecDeposit <= uint256(contracts[keccak256(Guid)]._SecDeposit));\n', '\t\t\trequire(contracts[keccak256(Guid)]._State == BaseEscrowLib.GetContractStateActive() && msg.sender == contracts[keccak256(Guid)]._landlord);\n', '\n', '\t\t\tif (contracts[keccak256(Guid)]._CancelPolicy == 1)\n', '\t\t\t{\n', '\t\t\t\tFlexibleEscrowLib.LandlordTerminate(contracts[keccak256(Guid)], SecDeposit);\n', '\t\t\t}\n', '\t\t\telse if (contracts[keccak256(Guid)]._CancelPolicy == 2)\n', '\t\t\t{\n', '\t\t\t\tModerateEscrowLib.LandlordTerminate(contracts[keccak256(Guid)], SecDeposit);\n', '\t\t\t}\n', '\t\t\telse if (contracts[keccak256(Guid)]._CancelPolicy == 3)\n', '\t\t\t{\n', '\t\t\t\tStrictEscrowLib.LandlordTerminate(contracts[keccak256(Guid)], SecDeposit);\n', '\t\t\t}\n', '\t\t\telse{\n', '\t\t\t\trevert();\n', '\t\t\t\treturn;\n', '\t\t\t}\n', '\n', '\t\t\tSendTokens(Guid);\n', '\n', '\t\t\t//Raise event\n', '\t\t\tcontractTerminated(contracts[keccak256(Guid)]._Id, Guid, contracts[keccak256(Guid)]._State);\n', '\t\t}\n', '\t}\n', '\n', '\tfunction SendTokens(string Guid) private\n', '\t{\t\t\n', '\t\tif (contracts[keccak256(Guid)]._Id != 0)\n', '\t\t{\n', '\t\t\tif (contracts[keccak256(Guid)]._landlBal > 0)\n', '\t\t\t{\t\n', '\t\t\t\tuint landlBal = uint(contracts[keccak256(Guid)]._landlBal);\n', '\t\t\t\tcontracts[keccak256(Guid)]._landlBal = 0;\t\t\n', '\t\t\t\tcontracts[keccak256(Guid)]._tokenApi.transfer(contracts[keccak256(Guid)]._landlord, landlBal);\n', '\t\t\t\tcontracts[keccak256(Guid)]._Balance -= landlBal;\t\t\t\t\t\t\n', '\t\t\t}\n', '\t    \n', '\t\t\tif (contracts[keccak256(Guid)]._tenantBal > 0)\n', '\t\t\t{\t\t\t\n', '\t\t\t\tuint tenantBal = uint(contracts[keccak256(Guid)]._tenantBal);\n', '\t\t\t\tcontracts[keccak256(Guid)]._tenantBal = 0;\n', '\t\t\t\tcontracts[keccak256(Guid)]._tokenApi.transfer(contracts[keccak256(Guid)]._tenant, tenantBal);\t\t\t\n', '\t\t\t\tcontracts[keccak256(Guid)]._Balance -= tenantBal;\n', '\t\t\t}\n', '\t\t}\t\t\t    \n', '\t}\n', '}']
