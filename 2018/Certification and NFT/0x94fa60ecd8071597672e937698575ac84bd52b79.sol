['/*************************************************************************\n', ' * This contract has been merged with solidify\n', ' * https://github.com/tiesnetwork/solidify\n', ' *************************************************************************/\n', ' \n', ' pragma solidity ^0.4.18;\n', '\n', '/*************************************************************************\n', ' * import "../common/Owned.sol" : start\n', ' *************************************************************************/\n', '\n', '/*************************************************************************\n', ' * import "./IOwned.sol" : start\n', ' *************************************************************************/\n', '\n', '/**@dev Simple interface to Owned base class */\n', 'contract IOwned {\n', '    function owner() public constant returns (address) {}\n', '    function transferOwnership(address _newOwner) public;\n', '}/*************************************************************************\n', ' * import "./IOwned.sol" : end\n', ' *************************************************************************/\n', '\n', 'contract Owned is IOwned {\n', '    address public owner;        \n', '\n', '    function Owned() public {\n', '        owner = msg.sender;\n', '    }\n', '\n', '    // allows execution by the owner only\n', '    modifier ownerOnly {\n', '        require(msg.sender == owner);\n', '        _;\n', '    }\n', '\n', '    /**@dev allows transferring the contract ownership. */\n', '    function transferOwnership(address _newOwner) public ownerOnly {\n', '        require(_newOwner != owner);\n', '        owner = _newOwner;\n', '    }\n', '}\n', '/*************************************************************************\n', ' * import "../common/Owned.sol" : end\n', ' *************************************************************************/\n', '/*************************************************************************\n', ' * import "../token/IERC20Token.sol" : start\n', ' *************************************************************************/\n', '\n', '/**@dev ERC20 compliant token interface. \n', 'https://theethereum.wiki/w/index.php/ERC20_Token_Standard \n', 'https://github.com/ethereum/EIPs/blob/master/EIPS/eip-20-token-standard.md */\n', 'contract IERC20Token {\n', '\n', "    // these functions aren't abstract since the compiler emits automatically generated getter functions as external    \n", '    function name() public constant returns (string _name) { _name; }\n', '    function symbol() public constant returns (string _symbol) { _symbol; }\n', '    function decimals() public constant returns (uint8 _decimals) { _decimals; }\n', '    \n', '    function totalSupply() public constant returns (uint total) {total;}\n', '    function balanceOf(address _owner) public constant returns (uint balance) {_owner; balance;}    \n', '    function allowance(address _owner, address _spender) public constant returns (uint remaining) {_owner; _spender; remaining;}\n', '\n', '    function transfer(address _to, uint _value) public returns (bool success);\n', '    function transferFrom(address _from, address _to, uint _value) public returns (bool success);\n', '    function approve(address _spender, uint _value) public returns (bool success);\n', '    \n', '\n', '    event Transfer(address indexed _from, address indexed _to, uint _value);\n', '    event Approval(address indexed _owner, address indexed _spender, uint _value);\n', '}\n', '/*************************************************************************\n', ' * import "../token/IERC20Token.sol" : end\n', ' *************************************************************************/\n', '\n', '/**@dev This contract holds tokens and unlock at specific dates.\n', 'unlockDates - array of UNIX timestamps when unlock happens\n', 'unlockAmounts - total amount of tokens that are unlocked on that date, the last element should equal to 0\n', 'For example, if \n', '1st tranche unlocks 10 tokens, \n', '2nd unlocks 15 tokens more\n', '3rd unlocks 30 tokens more\n', '4th unlocks 40 tokens more - all the rest \n', 'then unlockAmounts should be [10, 25, 55, 95]\n', ' */\n', 'contract CustomTrancheWallet is Owned {\n', '\n', '    IERC20Token public token;\n', '    address public beneficiary;\n', '    uint256 public initialFunds; //initial funds at the moment of lock \n', '    bool public locked; //true if funds are locked\n', '    uint256[] public unlockDates;\n', '    uint256[] public unlockAmounts;\n', '    uint256 public alreadyWithdrawn; //amount of tokens already withdrawn\n', '\n', '    function CustomTrancheWallet(\n', '        IERC20Token _token, \n', '        address _beneficiary, \n', '        uint256[] _unlockDates, \n', '        uint256[] _unlockAmounts\n', '    ) \n', '    public \n', '    {\n', '        token = _token;\n', '        beneficiary = _beneficiary;\n', '        unlockDates = _unlockDates;\n', '        unlockAmounts = _unlockAmounts;\n', '\n', '        require(paramsValid());\n', '    }\n', '\n', '    /**@dev Returns total number of scheduled unlocks */\n', '    function unlocksCount() public constant returns(uint256) {\n', '        return unlockDates.length;\n', '    }\n', '\n', '    /**@dev Returns amount of tokens available for withdraw */\n', '    function getAvailableAmount() public constant returns(uint256) {\n', '        if (!locked) {\n', '            return token.balanceOf(this);\n', '        } else {\n', '            return amountToWithdrawOnDate(now) - alreadyWithdrawn;\n', '        }\n', '    }    \n', '\n', '    /**@dev Returns how many token can be withdrawn on specific date */\n', '    function amountToWithdrawOnDate(uint256 currentDate) public constant returns (uint256) {\n', '        for (uint256 i = unlockDates.length; i != 0; --i) {\n', '            if (currentDate > unlockDates[i - 1]) {\n', '                return unlockAmounts[i - 1];\n', '            }\n', '        }\n', '        return 0;\n', '    }\n', '\n', '    /**@dev Returns true if params are valid */\n', '    function paramsValid() public constant returns (bool) {        \n', '        if (unlockDates.length == 0 || unlockDates.length != unlockAmounts.length) {\n', '            return false;\n', '        }        \n', '\n', '        for (uint256 i = 0; i < unlockAmounts.length - 1; ++i) {\n', '            if (unlockAmounts[i] >= unlockAmounts[i + 1]) {\n', '                return false;\n', '            }\n', '            if (unlockDates[i] >= unlockDates[i + 1]) {\n', '                return false;\n', '            }\n', '        }\n', '        return true;\n', '    }\n', '\n', '    /**@dev Sends available amount to stored beneficiary */\n', '    function sendToBeneficiary() public {\n', '        uint256 amount = getAvailableAmount();\n', '        alreadyWithdrawn += amount;\n', '        require(token.transfer(beneficiary, amount));\n', '    }\n', '\n', '    /**@dev Locks tokens according to stored schedule */\n', '    function lock() public ownerOnly {\n', '        require(!locked);\n', '        require(token.balanceOf(this) == unlockAmounts[unlockAmounts.length - 1]);\n', '\n', '        locked = true;\n', '    }\n', '\n', '    /**@dev Changes unlock schedule, can be called only by the owner and if funds are not locked*/\n', '    function setParams(        \n', '        uint256[] _unlockDates, \n', '        uint256[] _unlockAmounts\n', '    ) \n', '    public \n', '    ownerOnly \n', '    {\n', '        require(!locked);        \n', '\n', '        unlockDates = _unlockDates;\n', '        unlockAmounts = _unlockAmounts;\n', '\n', '        require(paramsValid());\n', '    }    \n', '\n', '    /**@dev Sets new beneficiary, can be called only by the owner */\n', '    function setBeneficiary(address _beneficiary) public ownerOnly {\n', '        beneficiary = _beneficiary;\n', '    }\n', '}']