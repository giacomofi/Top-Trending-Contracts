['/**************************************************************************\n', ' *            ____        _                              \n', ' *           / ___|      | |     __ _  _   _   ___  _ __ \n', " *          | |    _____ | |    / _` || | | | / _ \\| '__|\n", ' *          | |___|_____|| |___| (_| || |_| ||  __/| |   \n', ' *           \\____|      |_____|\\__,_| \\__, | \\___||_|   \n', ' *                                     |___/             \n', ' * \n', ' **************************************************************************\n', ' *\n', ' *  The MIT License (MIT)\n', ' * SPDX-License-Identifier: MIT\n', ' *\n', ' * Copyright (c) 2016-2020 Cyril Lapinte\n', ' *\n', ' * Permission is hereby granted, free of charge, to any person obtaining\n', ' * a copy of this software and associated documentation files (the\n', ' * "Software"), to deal in the Software without restriction, including\n', ' * without limitation the rights to use, copy, modify, merge, publish,\n', ' * distribute, sublicense, and/or sell copies of the Software, and to\n', ' * permit persons to whom the Software is furnished to do so, subject to\n', ' * the following conditions:\n', ' *\n', ' * The above copyright notice and this permission notice shall be included\n', ' * in all copies or substantial portions of the Software.\n', ' *\n', ' * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS\n', ' * OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\n', ' * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.\n', ' * IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY\n', ' * CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,\n', ' * TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE\n', ' * SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n', ' *\n', ' **************************************************************************\n', ' *\n', ' * Flatten Contract: VotingSessionManager\n', ' *\n', ' * Git Commit:\n', ' * https://github.com/c-layer/contracts/commit/9993912325afde36151b04d0247ac9ea9ffa2a93\n', ' *\n', ' **************************************************************************/\n', '\n', '\n', '// File: @c-layer/common/contracts/call/DelegateCall.sol\n', '\n', 'pragma solidity ^0.6.0;\n', '\n', '\n', '/**\n', ' * @title DelegateCall\n', ' * @dev Calls delegates for non view functions only\n', ' *\n', ' * @author Cyril Lapinte - <cyril.lapinte@openfiz.com>\n', ' *\n', ' * Error Messages:\n', ' **/\n', 'library DelegateCall {\n', '\n', '  function _delegateCall(address _delegate) internal virtual returns (bool status)\n', '  {\n', '    bytes memory result;\n', '    // solhint-disable-next-line avoid-low-level-calls\n', '    (status, result) = _delegate.delegatecall(msg.data);\n', '    require(status, string(result));\n', '  }\n', '\n', '  function _delegateCallBool(address _delegate) internal returns (bool status)\n', '  {\n', '    return abi.decode(_delegateCallBytes(_delegate), (bool));\n', '  }\n', '\n', '  function _delegateCallUint256(address _delegate) internal returns (uint256)\n', '  {\n', '    return abi.decode(_delegateCallBytes(_delegate), (uint256));\n', '  }\n', '\n', '  function _delegateCallBytes(address _delegate)\n', '    internal returns (bytes memory result)\n', '  {\n', '    bool status;\n', '    // solhint-disable-next-line avoid-low-level-calls\n', '    (status, result) = _delegate.delegatecall(msg.data);\n', '    require(status, string(result));\n', '  }\n', '}\n', '\n', '// File: @c-layer/common/contracts/call/DelegateCallView.sol\n', '\n', 'pragma solidity ^0.6.0;\n', '\n', '\n', '/**\n', ' * @title DelegateCallView\n', ' * @dev Calls delegates for view and non view functions\n', ' *\n', ' * @author Cyril Lapinte - <cyril.lapinte@openfiz.com>\n', ' *\n', ' * Error Messages:\n', ' *   DV01: Cannot call forwardCallBytes directly\n', ' **/\n', 'contract DelegateCallView {\n', '\n', '  bytes4 internal constant FORWARD_CALL_BYTES = bytes4(keccak256("forwardCallBytes(address,bytes)"));\n', '\n', '  function _delegateCallBool(address _delegate)\n', '    internal view returns (bool)\n', '  {\n', '    return abi.decode(_delegateCallBytes(_delegate), (bool));\n', '  }\n', '\n', '  function _delegateCallUint256(address _delegate)\n', '    internal view returns (uint256)\n', '  {\n', '    return abi.decode(_delegateCallBytes(_delegate), (uint256));\n', '  }\n', '\n', '  function _delegateCallBytes(address _delegate)\n', '    internal view returns (bytes memory result)\n', '  {\n', '    bool status;\n', '    (status, result) = address(this).staticcall(\n', '      abi.encodeWithSelector(FORWARD_CALL_BYTES, _delegate, msg.data));\n', '    require(status, string(result));\n', '    result = abi.decode(result, (bytes));\n', '  }\n', '\n', '  /**\n', '   * @dev enforce static immutability (view)\n', '   * @dev in order to read delegate value through internal delegateCall\n', '   */\n', '  function forwardCallBytes(address _delegate, bytes memory _data)\n', '    public returns (bytes memory result)\n', '  {\n', '    require(msg.sender == address(this), "DV01");\n', '    bool status;\n', '    // solhint-disable-next-line avoid-low-level-calls\n', '    (status, result) = _delegate.delegatecall(_data);\n', '    require(status, string(result));\n', '  }\n', '}\n', '\n', '// File: @c-layer/common/contracts/operable/Ownable.sol\n', '\n', 'pragma solidity ^0.6.0;\n', '\n', '\n', '/**\n', ' * @title Ownable\n', ' * @dev The Ownable contract has an owner address, and provides basic authorization control\n', ' * @dev functions, this simplifies the implementation of "user permissions".\n', ' *\n', ' *\n', ' * Error messages\n', ' *   OW01: Message sender is not the owner\n', ' *   OW02: New owner must be valid\n', '*/\n', 'contract Ownable {\n', '  address public owner;\n', '\n', '  event OwnershipRenounced(address indexed previousOwner);\n', '  event OwnershipTransferred(\n', '    address indexed previousOwner,\n', '    address indexed newOwner\n', '  );\n', '\n', '\n', '  /**\n', '   * @dev The Ownable constructor sets the original `owner` of the contract to the sender\n', '   * account.\n', '   */\n', '  constructor() public {\n', '    owner = msg.sender;\n', '  }\n', '\n', '  /**\n', '   * @dev Throws if called by any account other than the owner.\n', '   */\n', '  modifier onlyOwner() {\n', '    require(msg.sender == owner, "OW01");\n', '    _;\n', '  }\n', '\n', '  /**\n', '   * @dev Allows the current owner to relinquish control of the contract.\n', '   */\n', '  function renounceOwnership() public onlyOwner {\n', '    emit OwnershipRenounced(owner);\n', '    owner = address(0);\n', '  }\n', '\n', '  /**\n', '   * @dev Allows the current owner to transfer control of the contract to a newOwner.\n', '   * @param _newOwner The address to transfer ownership to.\n', '   */\n', '  function transferOwnership(address _newOwner) public onlyOwner {\n', '    _transferOwnership(_newOwner);\n', '  }\n', '\n', '  /**\n', '   * @dev Transfers control of the contract to a newOwner.\n', '   * @param _newOwner The address to transfer ownership to.\n', '   */\n', '  function _transferOwnership(address _newOwner) internal {\n', '    require(_newOwner != address(0), "OW02");\n', '    emit OwnershipTransferred(owner, _newOwner);\n', '    owner = _newOwner;\n', '  }\n', '}\n', '\n', '// File: @c-layer/common/contracts/interface/IERC20.sol\n', '\n', 'pragma solidity ^0.6.0;\n', '\n', '\n', '/**\n', ' * @title IERC20 interface\n', ' * @dev see https://github.com/ethereum/EIPs/issues/20\n', ' * @dev see https://github.com/ethereum/EIPs/issues/179\n', ' *\n', ' */\n', 'interface IERC20 {\n', '\n', '  event Transfer(address indexed from, address indexed to, uint256 value);\n', '  event Approval(\n', '    address indexed owner,\n', '    address indexed spender,\n', '    uint256 value\n', '  );\n', '\n', '  function name() external view returns (string memory);\n', '  function symbol() external view returns (string memory);\n', '  function decimals() external view returns (uint256);\n', '  function totalSupply() external view returns (uint256);\n', '  function balanceOf(address _owner) external view returns (uint256);\n', '\n', '  function transfer(address _to, uint256 _value) external returns (bool);\n', '\n', '  function allowance(address _owner, address _spender)\n', '    external view returns (uint256);\n', '\n', '  function transferFrom(address _from, address _to, uint256 _value)\n', '    external returns (bool);\n', '\n', '  function approve(address _spender, uint256 _value) external returns (bool);\n', '\n', '  function increaseApproval(address _spender, uint256 _addedValue)\n', '    external returns (bool);\n', '\n', '  function decreaseApproval(address _spender, uint256 _subtractedValue)\n', '    external returns (bool);\n', '}\n', '\n', '// File: @c-layer/common/contracts/interface/IProxy.sol\n', '\n', 'pragma solidity ^0.6.0;\n', '\n', '/**\n', ' * @title IProxy\n', ' *\n', ' * @author Cyril Lapinte - <cyril.lapinte@openfiz.com>\n', ' *\n', ' * Error messages\n', ' **/\n', 'interface IProxy {\n', '\n', '  function core() external view returns (address);\n', '\n', '}\n', '\n', '// File: @c-layer/common/contracts/core/Proxy.sol\n', '\n', 'pragma solidity ^0.6.0;\n', '\n', '\n', '\n', '/**\n', ' * @title Proxy\n', ' *\n', ' * @author Cyril Lapinte - <cyril.lapinte@openfiz.com>\n', ' *\n', ' * Error messages\n', ' *   PR01: Only accessible by core\n', ' *   PR02: Core request should be successful\n', ' **/\n', 'contract Proxy is IProxy {\n', '\n', '  address public override core;\n', '\n', '  /**\n', '   * @dev Throws if called by any account other than a core\n', '   */\n', '  modifier onlyCore {\n', '    require(core == msg.sender, "PR01");\n', '    _;\n', '  }\n', '\n', '  constructor(address _core) public {\n', '    core = _core;\n', '  }\n', '\n', '  /**\n', '   * @dev update the core\n', '   */\n', '  function updateCore(address _core)\n', '    public onlyCore returns (bool)\n', '  {\n', '    core = _core;\n', '    return true;\n', '  }\n', '\n', '  /**\n', '   * @dev enforce static immutability (view)\n', '   * @dev in order to read core value through internal core delegateCall\n', '   */\n', '  function staticCallUint256() internal view returns (uint256 value) {\n', '    (bool status, bytes memory result) = core.staticcall(msg.data);\n', '    require(status, string(result));\n', '    value = abi.decode(result, (uint256));\n', '  }\n', '}\n', '\n', '// File: @c-layer/token/contracts/interface/ITokenProxy.sol\n', '\n', 'pragma solidity ^0.6.0;\n', '\n', '\n', '\n', '\n', '/**\n', ' * @title IToken proxy\n', ' * @dev Token proxy interface\n', ' *\n', ' * @author Cyril Lapinte - <cyril.lapinte@openfiz.com>\n', ' */\n', 'abstract contract ITokenProxy is IERC20, Proxy {\n', '\n', '  function canTransfer(address, address, uint256)\n', '    virtual public view returns (uint256);\n', '\n', '  function emitTransfer(address _from, address _to, uint256 _value)\n', '    virtual public returns (bool);\n', '\n', '  function emitApproval(address _owner, address _spender, uint256 _value)\n', '    virtual public returns (bool);\n', '}\n', '\n', '// File: contracts/interface/IVotingDefinitions.sol\n', '\n', 'pragma solidity ^0.6.0;\n', '\n', '\n', '/**\n', ' * @title IVotingDefinitions\n', ' * @dev IVotingDefinitions interface\n', ' * @author Cyril Lapinte - <cyril.lapinte@openfiz.com>\n', ' *\n', ' * Error messages\n', ' */\n', 'abstract contract IVotingDefinitions {\n', '\n', '  address internal constant ANY_TARGET = address(bytes20("AnyTarget"));\n', '  bytes4 internal constant ANY_METHOD = bytes4(bytes32("AnyMethod"));\n', '\n', '  enum SessionState {\n', '    UNDEFINED,\n', '    PLANNED,\n', '    CAMPAIGN,\n', '    VOTING,\n', '    EXECUTION,\n', '    GRACE,\n', '    CLOSED,\n', '    ARCHIVED\n', '  }\n', '\n', '  enum ProposalState {\n', '    UNDEFINED,\n', '    DEFINED,\n', '    CANCELLED,\n', '    LOCKED,\n', '    APPROVED,\n', '    REJECTED,\n', '    RESOLVED,\n', '    CLOSED,\n', '    ARCHIVED\n', '  }\n', '\n', '  // 4 digits precisions on percentage values\n', '  uint256 internal constant PERCENT = 1000000;\n', '\n', '  uint64 internal constant MIN_PERIOD_LENGTH = 200;\n', '  // MAX_PERIOD_LENGTH (approx 10000 years) protects against period overflow\n', '  uint64 internal constant MAX_PERIOD_LENGTH = 3652500 days;\n', '  uint64 internal constant CAMPAIGN_PERIOD = 5 days;\n', '  uint64 internal constant VOTING_PERIOD = 2 days;\n', '  uint64 internal constant EXECUTION_PERIOD = 1 days;\n', '  uint64 internal constant GRACE_PERIOD = 6 days;\n', '  uint64 internal constant OFFSET_PERIOD = 2 days;\n', '\n', '  // Proposal requirements in percent\n', '  uint256 internal constant NEW_PROPOSAL_THRESHOLD = 1;\n', '  uint256 internal constant DEFAULT_EXECUTION_THRESHOLD = 1;\n', '  uint128 internal constant DEFAULT_MAJORITY = 500000; // 50%\n', '  uint128 internal constant DEFAULT_QUORUM = 200000; // 20%\n', '\n', '  uint8 internal constant OPEN_PROPOSALS = 5;\n', '  uint8 internal constant MAX_PROPOSALS = 20;\n', '  uint8 internal constant MAX_PROPOSALS_OPERATOR = 25;\n', '\n', '  uint256 internal constant SESSION_RETENTION_PERIOD = 365 days;\n', '  uint256 internal constant SESSION_RETENTION_COUNT = 10;\n', '}\n', '\n', '// File: @c-layer/common/contracts/interface/IAccessDefinitions.sol\n', '\n', 'pragma solidity ^0.6.0;\n', '\n', '\n', '/**\n', ' * @title IAccessDefinitions\n', ' * @dev IAccessDefinitions\n', ' *\n', ' * @author Cyril Lapinte - <cyril.lapinte@openfiz.com>\n', ' */\n', 'contract IAccessDefinitions {\n', '\n', '  // Hardcoded role granting all - non sysop - privileges\n', '  bytes32 internal constant ALL_PRIVILEGES = bytes32("AllPrivileges");\n', '  address internal constant ALL_PROXIES = address(0x416c6C50726F78696573); // "AllProxies"\n', '\n', '  // Roles\n', '  bytes32 internal constant FACTORY_CORE_ROLE = bytes32("FactoryCoreRole");\n', '  bytes32 internal constant FACTORY_PROXY_ROLE = bytes32("FactoryProxyRole");\n', '\n', '  // Sys Privileges\n', '  bytes4 internal constant DEFINE_ROLE_PRIV =\n', '    bytes4(keccak256("defineRole(bytes32,bytes4[])"));\n', '  bytes4 internal constant ASSIGN_OPERATORS_PRIV =\n', '    bytes4(keccak256("assignOperators(bytes32,address[])"));\n', '  bytes4 internal constant REVOKE_OPERATORS_PRIV =\n', '    bytes4(keccak256("revokeOperators(address[])"));\n', '  bytes4 internal constant ASSIGN_PROXY_OPERATORS_PRIV =\n', '    bytes4(keccak256("assignProxyOperators(address,bytes32,address[])"));\n', '}\n', '\n', '// File: @c-layer/common/contracts/interface/IOperableStorage.sol\n', '\n', 'pragma solidity ^0.6.0;\n', '\n', '\n', '\n', '/**\n', ' * @title IOperableStorage\n', ' * @dev The Operable storage\n', ' *\n', ' * @author Cyril Lapinte - <cyril.lapinte@openfiz.com>\n', ' *\n', ' * Error messages\n', ' */\n', 'abstract contract IOperableStorage is IAccessDefinitions {\n', '  function proxyDelegateId(address _proxy) virtual public view returns (uint256);\n', '  function delegate(uint256 _delegateId) virtual public view returns (address);\n', '\n', '  function coreRole(address _address) virtual public view returns (bytes32);\n', '  function proxyRole(address _proxy, address _address) virtual public view returns (bytes32);\n', '  function rolePrivilege(bytes32 _role, bytes4 _privilege) virtual public view returns (bool);\n', '  function roleHasPrivilege(bytes32 _role, bytes4 _privilege) virtual public view returns (bool);\n', '  function hasCorePrivilege(address _address, bytes4 _privilege) virtual public view returns (bool);\n', '  function hasProxyPrivilege(address _address, address _proxy, bytes4 _privilege) virtual public view returns (bool);\n', '\n', '  event RoleDefined(bytes32 role);\n', '  event OperatorAssigned(bytes32 role, address operator);\n', '  event ProxyOperatorAssigned(address proxy, bytes32 role, address operator);\n', '  event OperatorRevoked(address operator);\n', '  event ProxyOperatorRevoked(address proxy, address operator);\n', '\n', '  event ProxyDefined(address proxy, uint256 delegateId);\n', '  event ProxyMigrated(address proxy, address newCore);\n', '  event ProxyRemoved(address proxy);\n', '}\n', '\n', '// File: @c-layer/common/contracts/interface/IOperableCore.sol\n', '\n', 'pragma solidity ^0.6.0;\n', '\n', '\n', '\n', '/**\n', ' * @title IOperableCore\n', ' * @dev The Operable contract enable the restrictions of operations to a set of operators\n', ' *\n', ' * @author Cyril Lapinte - <cyril.lapinte@openfiz.com>\n', ' *\n', ' * Error messages\n', ' */\n', 'abstract contract IOperableCore is IOperableStorage {\n', '  function defineRole(bytes32 _role, bytes4[] memory _privileges) virtual public returns (bool);\n', '  function assignOperators(bytes32 _role, address[] memory _operators) virtual public returns (bool);\n', '  function assignProxyOperators(\n', '    address _proxy, bytes32 _role, address[] memory _operators) virtual public returns (bool);\n', '  function revokeOperators(address[] memory _operators) virtual public returns (bool);\n', '  function revokeProxyOperators(address _proxy, address[] memory _operators) virtual public returns (bool);\n', '\n', '  function defineProxy(address _proxy, uint256 _delegateId) virtual public returns (bool);\n', '  function migrateProxy(address _proxy, address _newCore) virtual public returns (bool);\n', '  function removeProxy(address _proxy) virtual public returns (bool);\n', '}\n', '\n', '// File: @c-layer/oracle/contracts/interface/IUserRegistry.sol\n', '\n', 'pragma solidity ^0.6.0;\n', '\n', '\n', '/**\n', ' * @title IUserRegistry\n', ' * @dev IUserRegistry interface\n', ' *\n', ' * @author Cyril Lapinte - <cyril.lapinte@openfiz.com>\n', ' **/\n', 'abstract contract IUserRegistry {\n', '\n', '  enum KeyCode {\n', '    KYC_LIMIT_KEY,\n', '    RECEPTION_LIMIT_KEY,\n', '    EMISSION_LIMIT_KEY\n', '  }\n', '\n', '  event UserRegistered(uint256 indexed userId, address address_, uint256 validUntilTime);\n', '  event AddressAttached(uint256 indexed userId, address address_);\n', '  event AddressDetached(uint256 indexed userId, address address_);\n', '  event UserSuspended(uint256 indexed userId);\n', '  event UserRestored(uint256 indexed userId);\n', '  event UserValidity(uint256 indexed userId, uint256 validUntilTime);\n', '  event UserExtendedKey(uint256 indexed userId, uint256 key, uint256 value);\n', '  event UserExtendedKeys(uint256 indexed userId, uint256[] values);\n', '  event ExtendedKeysDefinition(uint256[] keys);\n', '\n', '  function registerManyUsersExternal(address[] calldata _addresses, uint256 _validUntilTime)\n', '    virtual external returns (bool);\n', '  function registerManyUsersFullExternal(\n', '    address[] calldata _addresses,\n', '    uint256 _validUntilTime,\n', '    uint256[] calldata _values) virtual external returns (bool);\n', '  function attachManyAddressesExternal(uint256[] calldata _userIds, address[] calldata _addresses)\n', '    virtual external returns (bool);\n', '  function detachManyAddressesExternal(address[] calldata _addresses)\n', '    virtual external returns (bool);\n', '  function suspendManyUsersExternal(uint256[] calldata _userIds) virtual external returns (bool);\n', '  function restoreManyUsersExternal(uint256[] calldata _userIds) virtual external returns (bool);\n', '  function updateManyUsersExternal(\n', '    uint256[] calldata _userIds,\n', '    uint256 _validUntilTime,\n', '    bool _suspended) virtual external returns (bool);\n', '  function updateManyUsersExtendedExternal(\n', '    uint256[] calldata _userIds,\n', '    uint256 _key, uint256 _value) virtual external returns (bool);\n', '  function updateManyUsersAllExtendedExternal(\n', '    uint256[] calldata _userIds,\n', '    uint256[] calldata _values) virtual external returns (bool);\n', '  function updateManyUsersFullExternal(\n', '    uint256[] calldata _userIds,\n', '    uint256 _validUntilTime,\n', '    bool _suspended,\n', '    uint256[] calldata _values) virtual external returns (bool);\n', '\n', '  function name() virtual public view returns (string memory);\n', '  function currency() virtual public view returns (bytes32);\n', '\n', '  function userCount() virtual public view returns (uint256);\n', '  function userId(address _address) virtual public view returns (uint256);\n', '  function validUserId(address _address) virtual public view returns (uint256);\n', '  function validUser(address _address, uint256[] memory _keys)\n', '    virtual public view returns (uint256, uint256[] memory);\n', '  function validity(uint256 _userId) virtual public view returns (uint256, bool);\n', '\n', '  function extendedKeys() virtual public view returns (uint256[] memory);\n', '  function extended(uint256 _userId, uint256 _key)\n', '    virtual public view returns (uint256);\n', '  function manyExtended(uint256 _userId, uint256[] memory _key)\n', '    virtual public view returns (uint256[] memory);\n', '\n', '  function isAddressValid(address _address) virtual public view returns (bool);\n', '  function isValid(uint256 _userId) virtual public view returns (bool);\n', '\n', '  function defineExtendedKeys(uint256[] memory _extendedKeys) virtual public returns (bool);\n', '\n', '  function registerUser(address _address, uint256 _validUntilTime)\n', '    virtual public returns (bool);\n', '  function registerUserFull(\n', '    address _address,\n', '    uint256 _validUntilTime,\n', '    uint256[] memory _values) virtual public returns (bool);\n', '\n', '  function attachAddress(uint256 _userId, address _address) virtual public returns (bool);\n', '  function detachAddress(address _address) virtual public returns (bool);\n', '  function detachSelf() virtual public returns (bool);\n', '  function detachSelfAddress(address _address) virtual public returns (bool);\n', '  function suspendUser(uint256 _userId) virtual public returns (bool);\n', '  function restoreUser(uint256 _userId) virtual public returns (bool);\n', '  function updateUser(uint256 _userId, uint256 _validUntilTime, bool _suspended)\n', '    virtual public returns (bool);\n', '  function updateUserExtended(uint256 _userId, uint256 _key, uint256 _value)\n', '    virtual public returns (bool);\n', '  function updateUserAllExtended(uint256 _userId, uint256[] memory _values)\n', '    virtual public returns (bool);\n', '  function updateUserFull(\n', '    uint256 _userId,\n', '    uint256 _validUntilTime,\n', '    bool _suspended,\n', '    uint256[] memory _values) virtual public returns (bool);\n', '}\n', '\n', '// File: @c-layer/oracle/contracts/interface/IRatesProvider.sol\n', '\n', 'pragma solidity ^0.6.0;\n', '\n', '\n', '/**\n', ' * @title IRatesProvider\n', ' * @dev IRatesProvider interface\n', ' *\n', ' * @author Cyril Lapinte - <cyril.lapinte@openfiz.com>\n', ' */\n', 'abstract contract IRatesProvider {\n', '\n', '  function defineRatesExternal(uint256[] calldata _rates) virtual external returns (bool);\n', '\n', '  function name() virtual public view returns (string memory);\n', '\n', '  function rate(bytes32 _currency) virtual public view returns (uint256);\n', '\n', '  function currencies() virtual public view\n', '    returns (bytes32[] memory, uint256[] memory, uint256);\n', '  function rates() virtual public view returns (uint256, uint256[] memory);\n', '\n', '  function convert(uint256 _amount, bytes32 _fromCurrency, bytes32 _toCurrency)\n', '    virtual public view returns (uint256);\n', '\n', '  function defineCurrencies(\n', '    bytes32[] memory _currencies,\n', '    uint256[] memory _decimals,\n', '    uint256 _rateOffset) virtual public returns (bool);\n', '  function defineRates(uint256[] memory _rates) virtual public returns (bool);\n', '\n', '  event RateOffset(uint256 rateOffset);\n', '  event Currencies(bytes32[] currencies, uint256[] decimals);\n', '  event Rate(bytes32 indexed currency, uint256 rate);\n', '}\n', '\n', '// File: @c-layer/token/contracts/interface/IRule.sol\n', '\n', 'pragma solidity ^0.6.0;\n', '\n', '\n', '/**\n', ' * @title IRule\n', ' * @dev IRule interface\n', ' *\n', ' * @author Cyril Lapinte - <cyril.lapinte@openfiz.com>\n', ' **/\n', 'interface IRule {\n', '  function isAddressValid(address _address) external view returns (bool);\n', '  function isTransferValid(address _from, address _to, uint256 _amount)\n', '    external view returns (bool);\n', '}\n', '\n', '// File: @c-layer/token/contracts/interface/ITokenStorage.sol\n', '\n', 'pragma solidity ^0.6.0;\n', '\n', '\n', '\n', '\n', '\n', '/**\n', ' * @title ITokenStorage\n', ' * @dev Token storage interface\n', ' *\n', ' * @author Cyril Lapinte - <cyril.lapinte@openfiz.com>\n', ' */\n', 'abstract contract ITokenStorage {\n', '  enum TransferCode {\n', '    UNKNOWN,\n', '    OK,\n', '    INVALID_SENDER,\n', '    NO_RECIPIENT,\n', '    INSUFFICIENT_TOKENS,\n', '    LOCKED,\n', '    FROZEN,\n', '    RULE,\n', '    INVALID_RATE,\n', '    NON_REGISTRED_SENDER,\n', '    NON_REGISTRED_RECEIVER,\n', '    LIMITED_EMISSION,\n', '    LIMITED_RECEPTION\n', '  }\n', '\n', '  enum Scope {\n', '    DEFAULT\n', '  }\n', '\n', '  enum AuditStorageMode {\n', '    ADDRESS,\n', '    USER_ID,\n', '    SHARED\n', '  }\n', '\n', '  enum AuditTriggerMode {\n', '    UNDEFINED,\n', '    NONE,\n', '    SENDER_ONLY,\n', '    RECEIVER_ONLY,\n', '    BOTH\n', '  }\n', '\n', '  address internal constant ANY_ADDRESSES = address(0x416e79416464726573736573); // "AnyAddresses"\n', '\n', '  event OracleDefined(\n', '    IUserRegistry userRegistry,\n', '    IRatesProvider ratesProvider,\n', '    address currency);\n', '  event TokenDelegateDefined(uint256 indexed delegateId, address delegate, uint256[] configurations);\n', '  event TokenDelegateRemoved(uint256 indexed delegateId);\n', '  event AuditConfigurationDefined(\n', '    uint256 indexed configurationId,\n', '    uint256 scopeId,\n', '    AuditTriggerMode mode,\n', '    uint256[] senderKeys,\n', '    uint256[] receiverKeys,\n', '    IRatesProvider ratesProvider,\n', '    address currency);\n', '  event AuditTriggersDefined(\n', '    uint256 indexed configurationId,\n', '    address[] senders,\n', '    address[] receivers,\n', '    AuditTriggerMode[] modes);\n', '  event AuditsRemoved(address scope, uint256 scopeId);\n', '  event SelfManaged(address indexed holder, bool active);\n', '\n', '  event Minted(address indexed token, uint256 amount);\n', '  event MintFinished(address indexed token);\n', '  event Burned(address indexed token, uint256 amount);\n', '  event RulesDefined(address indexed token, IRule[] rules);\n', '  event LockDefined(\n', '    address indexed lock,\n', '    address sender,\n', '    address receiver,\n', '    uint256 startAt,\n', '    uint256 endAt\n', '  );\n', '  event Seize(address indexed token, address account, uint256 amount);\n', '  event Freeze(address address_, uint256 until);\n', '  event ClaimDefined(\n', '    address indexed token,\n', '    address indexed claim,\n', '    uint256 claimAt);\n', '  event TokenLocksDefined(\n', '    address indexed token,\n', '    address[] locks);\n', '  event TokenDefined(\n', '    address indexed token,\n', '    string name,\n', '    string symbol,\n', '    uint256 decimals);\n', '  event LogTransferData(\n', '    address token, address caller, address sender, address receiver,\n', '    uint256 senderId, uint256[] senderKeys, bool senderFetched,\n', '    uint256 receiverId, uint256[] receiverKeys, bool receiverFetched,\n', '    uint256 value, uint256 convertedValue);\n', '  event LogTransferAuditData(\n', '    uint256 auditConfigurationId, uint256 scopeId,\n', '    address currency, IRatesProvider ratesProvider,\n', '    bool senderAuditRequired, bool receiverAuditRequired);\n', '  event LogAuditData(\n', '    uint64 createdAt, uint64 lastTransactionAt,\n', '    uint256 cumulatedEmission, uint256 cumulatedReception\n', '  );\n', '}\n', '\n', '// File: @c-layer/token/contracts/interface/ITokenCore.sol\n', '\n', 'pragma solidity ^0.6.0;\n', '\n', '\n', '\n', '\n', '/**\n', ' * @title ITokenCore\n', ' *\n', ' * @author Cyril Lapinte - <cyril.lapinte@openfiz.com>\n', ' *\n', ' * Error messages\n', ' **/\n', 'abstract contract ITokenCore is ITokenStorage, IOperableCore {\n', '\n', '  function name() virtual public view returns (string memory);\n', '  function oracle() virtual public view returns (\n', '    IUserRegistry userRegistry,\n', '    IRatesProvider ratesProvider,\n', '    address currency);\n', '\n', '  function auditConfiguration(uint256 _configurationId)\n', '    virtual public view returns (\n', '      uint256 scopeId,\n', '      AuditTriggerMode _mode,\n', '      uint256[] memory senderKeys,\n', '      uint256[] memory receiverKeys,\n', '      IRatesProvider ratesProvider,\n', '      address currency);\n', '  function auditTrigger(uint256 _configurationId, address _sender, address _receiver)\n', '    virtual public view returns (AuditTriggerMode);\n', '  function delegatesConfigurations(uint256 _delegateId)\n', '    virtual public view returns (uint256[] memory);\n', '\n', '  function auditCurrency(\n', '    address _scope,\n', '    uint256 _scopeId\n', '  ) virtual external view returns (address currency);\n', '  function audit(\n', '    address _scope,\n', '    uint256 _scopeId,\n', '    AuditStorageMode _storageMode,\n', '    bytes32 _storageId) virtual external view returns (\n', '    uint64 createdAt,\n', '    uint64 lastTransactionAt,\n', '    uint256 cumulatedEmission,\n', '    uint256 cumulatedReception);\n', '\n', '  /**************  ERC20  **************/\n', '  function tokenName() virtual external view returns (string memory);\n', '  function tokenSymbol() virtual external view returns (string memory);\n', '\n', '  function decimals() virtual external returns (uint256);\n', '  function totalSupply() virtual external returns (uint256);\n', '  function balanceOf(address) virtual external returns (uint256);\n', '  function allowance(address, address) virtual external returns (uint256);\n', '  function transfer(address, address, uint256)\n', '    virtual external returns (bool status);\n', '  function transferFrom(address, address, address, uint256)\n', '    virtual external returns (bool status);\n', '  function approve(address, address, uint256)\n', '    virtual external returns (bool status);\n', '  function increaseApproval(address, address, uint256)\n', '    virtual external returns (bool status);\n', '  function decreaseApproval(address, address, uint256)\n', '    virtual external returns (bool status);\n', '\n', '  /***********  TOKEN DATA   ***********/\n', '  function token(address _token) virtual external view returns (\n', '    bool mintingFinished,\n', '    uint256 allTimeMinted,\n', '    uint256 allTimeBurned,\n', '    uint256 allTimeSeized,\n', '    address[] memory locks,\n', '    uint256 freezedUntil,\n', '    IRule[] memory);\n', '  function lock(address _lock, address _sender, address _receiver) virtual external view returns (\n', '    uint64 startAt, uint64 endAt);\n', '  function canTransfer(address, address, uint256)\n', '    virtual external returns (uint256);\n', '\n', '  /***********  TOKEN ADMIN  ***********/\n', '  function mint(address, address[] calldata, uint256[] calldata)\n', '    virtual external returns (bool);\n', '  function finishMinting(address)\n', '    virtual external returns (bool);\n', '  function burn(address, uint256)\n', '    virtual external returns (bool);\n', '  function seize(address _token, address, uint256)\n', '    virtual external returns (bool);\n', '  function defineLock(address, address, address, uint64, uint64)\n', '    virtual external returns (bool);\n', '  function defineTokenLocks(address _token, address[] memory locks)\n', '    virtual external returns (bool);\n', '  function freezeManyAddresses(\n', '    address _token,\n', '    address[] calldata _addresses,\n', '    uint256 _until) virtual external returns (bool);\n', '  function defineRules(address, IRule[] calldata) virtual external returns (bool);\n', '\n', '  /************  CORE ADMIN  ************/\n', '  function defineToken(\n', '    address _token,\n', '    uint256 _delegateId,\n', '    string memory _name,\n', '    string memory _symbol,\n', '    uint256 _decimals) virtual external returns (bool);\n', '\n', '  function defineOracle(\n', '    IUserRegistry _userRegistry,\n', '    IRatesProvider _ratesProvider,\n', '    address _currency) virtual external returns (bool);\n', '  function defineTokenDelegate(\n', '    uint256 _delegateId,\n', '    address _delegate,\n', '    uint256[] calldata _configurations) virtual external returns (bool);\n', '  function defineAuditConfiguration(\n', '    uint256 _configurationId,\n', '    uint256 _scopeId,\n', '    AuditTriggerMode _mode,\n', '    uint256[] calldata _senderKeys,\n', '    uint256[] calldata _receiverKeys,\n', '    IRatesProvider _ratesProvider,\n', '    address _currency) virtual external returns (bool);\n', '  function removeAudits(address _scope, uint256 _scopeId)\n', '    virtual external returns (bool);\n', '  function defineAuditTriggers(\n', '    uint256 _configurationId,\n', '    address[] calldata _senders,\n', '    address[] calldata _receivers,\n', '    AuditTriggerMode[] calldata _modes) virtual external returns (bool);\n', '\n', '  function isSelfManaged(address _owner)\n', '    virtual external view returns (bool);\n', '  function manageSelf(bool _active)\n', '    virtual external returns (bool);\n', '}\n', '\n', '// File: contracts/interface/IVotingSessionStorage.sol\n', '\n', 'pragma solidity ^0.6.0;\n', '\n', '\n', '\n', '\n', '\n', '/**\n', ' * @title IVotingSessionStorage\n', ' * @dev IVotingSessionStorage interface\n', ' * @author Cyril Lapinte - <cyril.lapinte@openfiz.com>\n', ' *\n', ' * Error messages\n', ' */\n', 'abstract contract IVotingSessionStorage is IVotingDefinitions {\n', '\n', '  event SessionRuleUpdated(\n', '    uint64 campaignPeriod,\n', '    uint64 votingPeriod,\n', '    uint64 executionPeriod,\n', '    uint64 gracePeriod,\n', '    uint64 periodOffset,\n', '    uint8 openProposals,\n', '    uint8 maxProposals,\n', '    uint8 maxProposalsOperator,\n', '    uint256 newProposalThreshold,\n', '    address[] nonVotingAddresses);\n', '  event ResolutionRequirementUpdated(\n', '    address target,\n', '    bytes4 methodSignature,\n', '    uint128 majority,\n', '    uint128 quorum,\n', '    uint256 executionThreshold\n', '  );\n', '\n', '  event TokenDefined(address token, address core);\n', '  event DelegateDefined(address delegate);\n', '\n', '  event SponsorDefined(address indexed voter, address address_, uint64 until);\n', '\n', '  event SessionScheduled(uint256 indexed sessionId, uint64 voteAt);\n', '  event SessionArchived(uint256 indexed sessionId);\n', '  event ProposalDefined(uint256 indexed sessionId, uint8 proposalId);\n', '  event ProposalUpdated(uint256 indexed sessionId, uint8 proposalId);\n', '  event ProposalCancelled(uint256 indexed sessionId, uint8 proposalId);\n', '  event ResolutionExecuted(uint256 indexed sessionId, uint8 proposalId);\n', '\n', '  event Vote(uint256 indexed sessionId, address voter, uint256 weight);\n', '}\n', '\n', '// File: contracts/interface/IVotingSessionDelegate.sol\n', '\n', 'pragma solidity ^0.6.0;\n', '\n', '\n', '\n', '/**\n', ' * @title IVotingSessionDelegate\n', ' * @dev IVotingSessionDelegate interface\n', ' * @author Cyril Lapinte - <cyril.lapinte@openfiz.com>\n', ' *\n', ' * Error messages\n', ' */\n', 'abstract contract IVotingSessionDelegate is IVotingSessionStorage {\n', '\n', '  function nextSessionAt(uint256 _time) virtual public view returns (uint256 at);\n', '\n', '  function sessionStateAt(uint256 _sessionId, uint256 _time) virtual public view returns (SessionState);\n', '\n', '  function newProposalThresholdAt(uint256 _sessionId, uint256 _proposalsCount)\n', '    virtual public view returns (uint256);\n', '\n', '  function proposalApproval(uint256 _sessionId, uint8 _proposalId)\n', '    virtual public view returns (bool);\n', '\n', '  function proposalStateAt(uint256 _sessionId, uint8 _proposalId, uint256 _time)\n', '    virtual public view returns (ProposalState);\n', '\n', '  function updateSessionRule(\n', '    uint64 _campaignPeriod,\n', '    uint64 _votingPeriod,\n', '    uint64 _executionPeriod,\n', '    uint64 _gracePeriod,\n', '    uint64 _periodOffset,\n', '    uint8 _openProposals,\n', '    uint8 _maxProposals,\n', '    uint8 _maxProposalsQuaestor,\n', '    uint256 _newProposalThreshold,\n', '    address[] memory _nonVotingAddresses\n', '  ) virtual public returns (bool);\n', '\n', '  function updateResolutionRequirements(\n', '    address[] memory _targets,\n', '    bytes4[] memory _methodSignatures,\n', '    uint128[] memory _majority,\n', '    uint128[] memory _quorum,\n', '    uint256[] memory _executionThreshold\n', '  ) virtual public returns (bool);\n', '\n', '  function defineProposal(\n', '    string memory _name,\n', '    string memory _url,\n', '    bytes32 _proposalHash,\n', '    address _resolutionTarget,\n', '    bytes memory _resolutionAction,\n', '    uint8 _dependsOn,\n', '    uint8 _alternativeOf\n', '  ) virtual public returns (bool);\n', '\n', '  function updateProposal(\n', '    uint8 _proposalId,\n', '    string memory _name,\n', '    string memory _url,\n', '    bytes32 _proposalHash,\n', '    address _resolutionTarget,\n', '    bytes memory _resolutionAction,\n', '    uint8 _dependsOn,\n', '    uint8 _alternativeOf\n', '  ) virtual public returns (bool);\n', '  function cancelProposal(uint8 _proposalId) virtual public returns (bool);\n', '\n', '  function submitVote(uint256 _votes) virtual public returns (bool);\n', '  function submitVotesOnBehalf(\n', '    address[] memory _voters,\n', '    uint256 _votes\n', '  ) virtual public returns (bool);\n', '\n', '  function executeResolutions(uint8[] memory _proposalIds) virtual public returns (bool);\n', '\n', '  function archiveSession() virtual public returns (bool);\n', '\n', '}\n', '\n', '// File: contracts/interface/IVotingSessionManager.sol\n', '\n', 'pragma solidity ^0.6.0;\n', '\n', '\n', '\n', '\n', '\n', '\n', '/**\n', ' * @title IVotingSessionManager\n', ' * @dev IVotingSessionManager interface\n', ' * @author Cyril Lapinte - <cyril.lapinte@openfiz.com>\n', ' *\n', ' * Error messages\n', ' */\n', 'abstract contract IVotingSessionManager is IVotingSessionStorage {\n', '\n', '  function contracts() public virtual view returns (\n', '    IVotingSessionDelegate delegate, ITokenProxy token, ITokenCore core);\n', '\n', '  function sessionRule() virtual public view returns (\n', '    uint64 campaignPeriod,\n', '    uint64 votingPeriod,\n', '    uint64 executionPeriod,\n', '    uint64 gracePeriod,\n', '    uint64 periodOffset,\n', '    uint8 openProposals,\n', '    uint8 maxProposals,\n', '    uint8 maxProposalsOperator,\n', '    uint256 newProposalThreshold,\n', '    address[] memory nonVotingAddresses);\n', '\n', '  function resolutionRequirement(address _target, bytes4 _method) virtual public view returns (\n', '    uint128 majority,\n', '    uint128 quorum,\n', '    uint256 executionThreshold);\n', '\n', '  function oldestSessionId() virtual public view returns (uint256);\n', '\n', '  function currentSessionId() virtual public view returns (uint256);\n', '\n', '  function session(uint256 _sessionId) virtual public view returns (\n', '    uint64 campaignAt,\n', '    uint64 voteAt,\n', '    uint64 executionAt,\n', '    uint64 graceAt,\n', '    uint64 closedAt,\n', '    uint256 sessionProposalsCount,\n', '    uint256 participation,\n', '    uint256 totalSupply,\n', '    uint256 circulatingSupply);\n', '\n', '  function proposal(uint256 _sessionId, uint8 _proposalId) virtual public view returns (\n', '    string memory name,\n', '    string memory url,\n', '    bytes32 proposalHash,\n', '    address resolutionTarget,\n', '    bytes memory resolutionAction);\n', '  function proposalData(uint256 _sessionId, uint8 _proposalId) virtual public view returns (\n', '    address proposedBy,\n', '    uint128 requirementMajority,\n', '    uint128 requirementQuorum,\n', '    uint256 executionThreshold,\n', '    uint8 dependsOn,\n', '    uint8 alternativeOf,\n', '    uint256 alternativesMask,\n', '    uint256 approvals);\n', '\n', '  function sponsorOf(address _voter) virtual public view returns (address sponsor, uint64 until);\n', '\n', '  function lastVoteOf(address _voter) virtual public view returns (uint64 at);\n', '\n', '  function nextSessionAt(uint256 _time) virtual public view returns (uint256 at);\n', '\n', '  function sessionStateAt(uint256 _sessionId, uint256 _time) virtual public view returns (SessionState);\n', '\n', '  function newProposalThresholdAt(uint256 _sessionId, uint256 _proposalsCount)\n', '    virtual public view returns (uint256);\n', '\n', '  function proposalApproval(uint256 _sessionId, uint8 _proposalId)\n', '    virtual public view returns (bool);\n', '\n', '  function proposalStateAt(uint256 _sessionId, uint8 _proposalId, uint256 _time)\n', '    virtual public view returns (ProposalState);\n', '\n', '  function defineContracts(ITokenProxy _token, IVotingSessionDelegate _delegate)\n', '    virtual public returns (bool);\n', '\n', '  function updateSessionRule(\n', '    uint64 _campaignPeriod,\n', '    uint64 _votingPeriod,\n', '    uint64 _executionPeriod,\n', '    uint64 _gracePeriod,\n', '    uint64 _periodOffset,\n', '    uint8 _openProposals,\n', '    uint8 _maxProposals,\n', '    uint8 _maxProposalsQuaestor,\n', '    uint256 _newProposalThreshold,\n', '    address[] memory _nonVotingAddresses\n', '  ) virtual public returns (bool);\n', '\n', '  function updateResolutionRequirements(\n', '    address[] memory _targets,\n', '    bytes4[] memory _methodSignatures,\n', '    uint128[] memory _majority,\n', '    uint128[] memory _quorum,\n', '    uint256[] memory _executionThreshold\n', '  ) virtual public returns (bool);\n', '\n', '  function defineSponsor(address _sponsor, uint64 _until) virtual public returns (bool);\n', '  function defineSponsorOf(Ownable _contract, address _sponsor, uint64 _until)\n', '    virtual public returns (bool);\n', '\n', '  function defineProposal(\n', '    string memory _name,\n', '    string memory _url,\n', '    bytes32 _proposalHash,\n', '    address _resolutionTarget,\n', '    bytes memory _resolutionAction,\n', '    uint8 _dependsOn,\n', '    uint8 _alternativeOf\n', '  ) virtual public returns (bool);\n', '\n', '  function updateProposal(\n', '    uint8 _proposalId,\n', '    string memory _name,\n', '    string memory _url,\n', '    bytes32 _proposalHash,\n', '    address _resolutionTarget,\n', '    bytes memory _resolutionAction,\n', '    uint8 _dependsOn,\n', '    uint8 _alternativeOf\n', '  ) virtual public returns (bool);\n', '  function cancelProposal(uint8 _proposalId) virtual public returns (bool);\n', '\n', '  function submitVote(uint256 _votes) virtual public returns (bool);\n', '  function submitVotesOnBehalf(\n', '    address[] memory _voters,\n', '    uint256 _votes\n', '  ) virtual public returns (bool);\n', '\n', '  function executeResolutions(uint8[] memory _proposalIds) virtual public returns (bool);\n', '\n', '  function archiveSession() virtual public returns (bool);\n', '}\n', '\n', '// File: @c-layer/common/contracts/math/SafeMath.sol\n', '\n', 'pragma solidity ^0.6.0;\n', '\n', '\n', '/**\n', ' * @title SafeMath\n', ' * @dev Math operations with safety checks that throw on error\n', ' */\n', 'library SafeMath {\n', '\n', '  /**\n', '  * @dev Multiplies two numbers, throws on overflow.\n', '  */\n', '  function mul(uint256 a, uint256 b) internal pure returns (uint256 c) {\n', "    // Gas optimization: this is cheaper than asserting 'a' not being zero, but the\n", "    // benefit is lost if 'b' is also tested.\n", '    // See: https://github.com/OpenZeppelin/openzeppelin-solidity/pull/522\n', '    if (a == 0) {\n', '      return 0;\n', '    }\n', '\n', '    c = a * b;\n', '    assert(c / a == b);\n', '    return c;\n', '  }\n', '\n', '  /**\n', '  * @dev Integer division of two numbers, truncating the quotient.\n', '  */\n', '  function div(uint256 a, uint256 b) internal pure returns (uint256) {\n', '    // assert(b > 0); // Solidity automatically throws when dividing by 0\n', '    // uint256 c = a / b;\n', "    // assert(a == b * c + a % b); // There is no case in which this doesn't hold\n", '    return a / b;\n', '  }\n', '\n', '  /**\n', '  * @dev Subtracts two numbers, throws on overflow (i.e. if subtrahend is greater than minuend).\n', '  */\n', '  function sub(uint256 a, uint256 b) internal pure returns (uint256) {\n', '    assert(b <= a);\n', '    return a - b;\n', '  }\n', '\n', '  /**\n', '  * @dev Adds two numbers, throws on overflow.\n', '  */\n', '  function add(uint256 a, uint256 b) internal pure returns (uint256 c) {\n', '    c = a + b;\n', '    assert(c >= a);\n', '    return c;\n', '  }\n', '}\n', '\n', '// File: contracts/voting/VotingSessionStorage.sol\n', '\n', 'pragma solidity ^0.6.0;\n', '\n', '\n', '\n', '\n', '\n', '/**\n', ' * @title VotingSessionStorage\n', ' * @dev VotingSessionStorage contract\n', ' * @author Cyril Lapinte - <cyril.lapinte@openfiz.com>\n', ' *\n', ' * Error messages\n', ' */\n', 'contract VotingSessionStorage is IVotingSessionStorage {\n', '  using SafeMath for uint256;\n', '\n', '  address internal constant ANY_ADDRESSES = address(0x416e79416464726573736573); // "AnyAddresses"\n', '\n', '  struct SessionRule {\n', '    uint64 campaignPeriod; // Before it starts, the vote will be locked\n', '    uint64 votingPeriod; // Time period for voters to submit their votes\n', '    uint64 executionPeriod; // Time period for executing resolutions\n', '    uint64 gracePeriod; // delay between two votes\n', '\n', '    uint64 periodOffset; // Offset before the first session period\n', '\n', '    uint8 openProposals;\n', '    uint8 maxProposals;\n', '    uint8 maxProposalsOperator;\n', '    uint256 newProposalThreshold;\n', '\n', '    address[] nonVotingAddresses;\n', '  }\n', '\n', '  struct ResolutionRequirement {\n', '    uint128 majority;\n', '    uint128 quorum;\n', '    uint256 executionThreshold;\n', '  }\n', '\n', '  struct Session {\n', '    uint64 campaignAt;\n', '    uint64 voteAt;\n', '    uint64 executionAt;\n', '    uint64 graceAt;\n', '    uint64 closedAt;\n', '    uint8 proposalsCount;\n', '    uint256 participation;\n', '    uint256 totalSupply;\n', '    uint256 votingSupply;\n', '\n', '    mapping(uint256 => Proposal) proposals;\n', '  }\n', '\n', '  // A proposal may be semanticaly in one of the following state:\n', '  // DEFINED, VOTED, RESOLVED(?), PROCESSED\n', '  struct Proposal {\n', '    string name;\n', '    string url;\n', '    bytes32 proposalHash;\n', '    address proposedBy;\n', '    address resolutionTarget;\n', '    bytes resolutionAction;\n', '\n', '    ResolutionRequirement requirement;\n', '    uint8 dependsOn; // The previous proposal must be either non approved or executed\n', '    bool resolutionExecuted;\n', '    bool cancelled;\n', '\n', '    uint8 alternativeOf;\n', '    uint256 approvals;\n', '    uint256 alternativesMask; // only used for the parent alternative proposal\n', '  }\n', '\n', '  struct Sponsor {\n', '    address address_;\n', '    uint64 until;\n', '  }\n', '\n', '  IVotingSessionDelegate internal delegate_;\n', '  ITokenProxy internal token_;\n', '  ITokenCore internal core_;\n', '\n', '  SessionRule internal sessionRule_ = SessionRule(\n', '    CAMPAIGN_PERIOD,\n', '    VOTING_PERIOD,\n', '    EXECUTION_PERIOD,\n', '    GRACE_PERIOD,\n', '    OFFSET_PERIOD,\n', '    OPEN_PROPOSALS,\n', '    MAX_PROPOSALS,\n', '    MAX_PROPOSALS_OPERATOR,\n', '    NEW_PROPOSAL_THRESHOLD,\n', '    new address[](0)\n', '  );\n', '\n', '  mapping(address => mapping(bytes4 => ResolutionRequirement)) internal resolutionRequirements;\n', '\n', "  uint256 internal oldestSessionId_ = 1; // '1' simplifies checks when no sessions exists\n", '  uint256 internal currentSessionId_ = 0;\n', '  mapping(uint256 => Session) internal sessions;\n', '  mapping(address => uint64) internal lastVotes;\n', '  mapping(address => Sponsor) internal sponsors;\n', '\n', '  /**\n', '   * @dev currentTime\n', '   */\n', '  function currentTime() internal view returns (uint256) {\n', '    // solhint-disable-next-line not-rely-on-time\n', '    return block.timestamp;\n', '  }\n', '}\n', '\n', '// File: contracts/voting/VotingSessionManager.sol\n', '\n', 'pragma solidity ^0.6.0;\n', '\n', '\n', '\n', '\n', '\n', '\n', '/**\n', ' * @title VotingSessionManager\n', ' * @dev VotingSessionManager contract\n', ' * @author Cyril Lapinte - <cyril.lapinte@openfiz.com>\n', ' *\n', ' * Error messages\n', " *   VM01: Session doesn't exist\n", ' *   VM02: Token is invalid\n', ' *   VM03: Delegate is invalid\n', ' *   VM04: Token has no valid core\n', ' *   VM05: Only contract owner may define its sponsor\n', ' */\n', 'contract VotingSessionManager is IVotingSessionManager, DelegateCallView, VotingSessionStorage {\n', '  using DelegateCall for address;\n', '\n', '  modifier onlyOperator() {\n', '    require(core_.hasProxyPrivilege(\n', '      msg.sender, address(this), msg.sig), "VM01");\n', '    _;\n', '  }\n', '\n', '  /**\n', '   * @dev constructor\n', '   */\n', '  constructor(ITokenProxy _token, IVotingSessionDelegate _delegate) public {\n', '    defineContractsInternal(_token, _delegate);\n', '\n', '    resolutionRequirements[ANY_TARGET][ANY_METHOD] =\n', '      ResolutionRequirement(DEFAULT_MAJORITY, DEFAULT_QUORUM, DEFAULT_EXECUTION_THRESHOLD);\n', '  }\n', '\n', '  /**\n', '   * @dev token\n', '   */\n', '  function contracts() public override view returns (\n', '    IVotingSessionDelegate delegate, ITokenProxy token, ITokenCore core)\n', '  {\n', '    return (delegate_, token_, core_);\n', '  }\n', '\n', '  /**\n', '   * @dev sessionRule\n', '   */\n', '  function sessionRule() public override view returns (\n', '    uint64 campaignPeriod,\n', '    uint64 votingPeriod,\n', '    uint64 executionPeriod,\n', '    uint64 gracePeriod,\n', '    uint64 periodOffset,\n', '    uint8 openProposals,\n', '    uint8 maxProposals,\n', '    uint8 maxProposalsOperator,\n', '    uint256 newProposalThreshold,\n', '    address[] memory nonVotingAddresses) {\n', '    return (\n', '      sessionRule_.campaignPeriod,\n', '      sessionRule_.votingPeriod,\n', '      sessionRule_.executionPeriod,\n', '      sessionRule_.gracePeriod,\n', '      sessionRule_.periodOffset,\n', '      sessionRule_.openProposals,\n', '      sessionRule_.maxProposals,\n', '      sessionRule_.maxProposalsOperator,\n', '      sessionRule_.newProposalThreshold,\n', '      sessionRule_.nonVotingAddresses);\n', '  }\n', '\n', '  /**\n', '   * @dev resolutionRequirement\n', '   */\n', '  function resolutionRequirement(address _target, bytes4 _method) public override view returns (\n', '    uint128 majority,\n', '    uint128 quorum,\n', '    uint256 executionThreshold) {\n', '    ResolutionRequirement storage requirement =\n', '      resolutionRequirements[_target][_method];\n', '\n', '    return (\n', '      requirement.majority,\n', '      requirement.quorum,\n', '      requirement.executionThreshold);\n', '  }\n', '\n', '  /**\n', '   * @dev oldestSessionId\n', '   */\n', '  function oldestSessionId() public override view returns (uint256) {\n', '    return oldestSessionId_;\n', '  }\n', '\n', '  /**\n', '   * @dev currentSessionId\n', '   */\n', '  function currentSessionId() public override view returns (uint256) {\n', '    return currentSessionId_;\n', '  }\n', '\n', '  /**\n', '   * @dev session\n', '   */\n', '  function session(uint256 _sessionId) public override view returns (\n', '    uint64 campaignAt,\n', '    uint64 voteAt,\n', '    uint64 executionAt,\n', '    uint64 graceAt,\n', '    uint64 closedAt,\n', '    uint256 proposalsCount,\n', '    uint256 participation,\n', '    uint256 totalSupply,\n', '    uint256 votingSupply)\n', '  {\n', '    Session storage session_ = sessions[_sessionId];\n', '    return (\n', '      session_.campaignAt,\n', '      session_.voteAt,\n', '      session_.executionAt,\n', '      session_.graceAt,\n', '      session_.closedAt,\n', '      session_.proposalsCount,\n', '      session_.participation,\n', '      session_.totalSupply,\n', '      session_.votingSupply);\n', '  }\n', '\n', '  /**\n', '   * @dev sponsorOf\n', '   */\n', '  function sponsorOf(address _voter) public override view returns (address address_, uint64 until) {\n', '    Sponsor storage sponsor_ = sponsors[_voter];\n', '    address_ = sponsor_.address_;\n', '    until = sponsor_.until;\n', '  }\n', '\n', '  /**\n', '   * @dev lastVoteOf\n', '   */\n', '  function lastVoteOf(address _voter) public override view returns (uint64 at) {\n', '    return lastVotes[_voter];\n', '  }\n', '\n', '  /**\n', '   * @dev proposal\n', '   */\n', '  function proposal(uint256 _sessionId, uint8 _proposalId) public override view returns (\n', '    string memory name,\n', '    string memory url,\n', '    bytes32 proposalHash,\n', '    address resolutionTarget,\n', '    bytes memory resolutionAction)\n', '  {\n', '    Proposal storage proposal_ = sessions[_sessionId].proposals[_proposalId];\n', '    return (\n', '      proposal_.name,\n', '      proposal_.url,\n', '      proposal_.proposalHash,\n', '      proposal_.resolutionTarget,\n', '      proposal_.resolutionAction);\n', '  }\n', '\n', '  /**\n', '   * @dev proposalData\n', '   */\n', '  function proposalData(uint256 _sessionId, uint8 _proposalId) public override view returns (\n', '    address proposedBy,\n', '    uint128 requirementMajority,\n', '    uint128 requirementQuorum,\n', '    uint256 executionThreshold,\n', '    uint8 dependsOn,\n', '    uint8 alternativeOf,\n', '    uint256 alternativesMask,\n', '    uint256 approvals)\n', '  {\n', '    Proposal storage proposal_ = sessions[_sessionId].proposals[_proposalId];\n', '    return (\n', '      proposal_.proposedBy,\n', '      proposal_.requirement.majority,\n', '      proposal_.requirement.quorum,\n', '      proposal_.requirement.executionThreshold,\n', '      proposal_.dependsOn,\n', '      proposal_.alternativeOf,\n', '      proposal_.alternativesMask,\n', '      proposal_.approvals);\n', '  }\n', '\n', '  /**\n', '   * @dev nextSessionAt\n', '   */\n', '  function nextSessionAt(uint256) public override view returns (uint256) {\n', '    return _delegateCallUint256(address(delegate_));\n', '  }\n', '\n', '  /**\n', '   * @dev sessionStateAt\n', '   */\n', '  function sessionStateAt(uint256, uint256) public override\n', '    view returns (SessionState)\n', '  {\n', '    return SessionState(_delegateCallUint256(address(delegate_)));\n', '  }\n', '\n', '  /**\n', '   * @dev newProposalThresholdAt\n', '   */\n', '  function newProposalThresholdAt(uint256, uint256)\n', '    public override view returns (uint256)\n', '  {\n', '    return _delegateCallUint256(address(delegate_));\n', '  }\n', '\n', '  /**\n', '   * @dev proposalApproval\n', '   */\n', '  function proposalApproval(uint256, uint8)\n', '    public override view returns (bool)\n', '  {\n', '    return _delegateCallBool(address(delegate_));\n', '  }\n', '\n', '  /**\n', '   * @dev proposalStateAt\n', '   */\n', '  function proposalStateAt(uint256, uint8, uint256)\n', '    public override view returns (ProposalState)\n', '  {\n', '    return ProposalState(_delegateCallUint256(address(delegate_)));\n', '  }\n', '\n', '  /**\n', '   * @dev define contracts\n', '   */\n', '  function defineContracts(ITokenProxy _token, IVotingSessionDelegate _delegate)\n', '    public override onlyOperator() returns (bool)\n', '  {\n', '    return defineContractsInternal(_token, _delegate);\n', '  }\n', '\n', '  /**\n', '   * @dev updateSessionRule\n', '   */\n', '  function updateSessionRule(\n', '    uint64, uint64, uint64, uint64, uint64, uint8, uint8, uint8, uint256, address[] memory)\n', '    public override onlyOperator() returns (bool)\n', '  {\n', '    return address(delegate_)._delegateCall();\n', '  }\n', '\n', '  /**\n', '   * @dev updateResolutionRequirements\n', '   */\n', '  function updateResolutionRequirements(\n', '    address[] memory, bytes4[] memory, uint128[] memory, uint128[] memory, uint256[] memory)\n', '    public override onlyOperator() returns (bool)\n', '  {\n', '    return address(delegate_)._delegateCall();\n', '  }\n', '\n', '  /**\n', '   * @dev defineSponsor\n', '   */\n', '  function defineSponsor(address _sponsor, uint64 _until) public override returns (bool) {\n', '    sponsors[msg.sender] = Sponsor(_sponsor, _until);\n', '    emit SponsorDefined(msg.sender, _sponsor, _until);\n', '    return true;\n', '  }\n', '\n', '  /**\n', '   * @dev defineSponsorOf\n', '   */\n', '  function defineSponsorOf(Ownable _contract, address _sponsor, uint64 _until)\n', '    public override returns (bool)\n', '  {\n', '    require(_contract.owner() == msg.sender, "VM05");\n', '    sponsors[address(_contract)] = Sponsor(_sponsor, _until);\n', '    emit SponsorDefined(address(_contract), _sponsor, _until);\n', '    return true;\n', '  }\n', '\n', '  /**\n', '   * @dev defineProposal\n', '   */\n', '  function defineProposal(string memory, string memory,\n', '    bytes32, address, bytes memory, uint8, uint8) public override returns (bool)\n', '  {\n', '    return address(delegate_)._delegateCall();\n', '  }\n', '\n', '  /**\n', '   * @dev updateProposal\n', '   */\n', '  function updateProposal(\n', '    uint8, string memory, string memory, bytes32, address, bytes memory, uint8, uint8)\n', '    public override returns (bool)\n', '  {\n', '    return address(delegate_)._delegateCall();\n', '  }\n', '\n', '  /**\n', '   * @dev cancelProposal\n', '   */\n', '  function cancelProposal(uint8) public override returns (bool)\n', '  {\n', '    return address(delegate_)._delegateCall();\n', '  }\n', '\n', '  /**\n', '   * @dev submitVote\n', '   */\n', '  function submitVote(uint256) public override returns (bool)\n', '  {\n', '    return address(delegate_)._delegateCall();\n', '  }\n', '\n', '  /**\n', '   * @dev submitVotesOnBehalf\n', '   */\n', '  function submitVotesOnBehalf(address[] memory, uint256) public override returns (bool)\n', '  {\n', '    return address(delegate_)._delegateCall();\n', '  }\n', '\n', '  /**\n', '   * @dev execute resolutions\n', '   */\n', '  function executeResolutions(uint8[] memory) public override returns (bool)\n', '  {\n', '    return address(delegate_)._delegateCall();\n', '  }\n', '\n', '  /**\n', '   * @dev archiveSession\n', '   **/\n', '  function archiveSession() public override returns (bool) {\n', '    return address(delegate_)._delegateCall();\n', '  }\n', '\n', '  /**\n', '   * @dev define contracts internal\n', '   */\n', '  function defineContractsInternal(ITokenProxy _token, IVotingSessionDelegate _delegate)\n', '    internal returns (bool)\n', '  {\n', '    require(address(_token) != address(0), "VM02");\n', '    require(address(_delegate) != address(0), "VM03");\n', '\n', '    ITokenCore core = ITokenCore(_token.core());\n', '    require(address(core) != address(0), "VM04");\n', '\n', '    if (token_ != _token || core_ != core) {\n', '      token_ = _token;\n', '      core_ = core;\n', '      emit TokenDefined(address(token_), address(core_));\n', '    }\n', '\n', '    if (delegate_ != _delegate) {\n', '      delegate_ = _delegate;\n', '      emit DelegateDefined(address(delegate_));\n', '    }\n', '    return true;\n', '  }\n', '}']