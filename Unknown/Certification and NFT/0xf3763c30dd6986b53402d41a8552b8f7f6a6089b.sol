['/**\n', ' * Copyright 2016 Everex https://everex.io\n', ' *\n', ' * Licensed under the Apache License, Version 2.0 (the "License");\n', ' * you may not use this file except in compliance with the License.\n', ' * You may obtain a copy of the License at\n', ' *\n', ' *     http://www.apache.org/licenses/LICENSE-2.0\n', ' *\n', ' * Unless required by applicable law or agreed to in writing, software\n', ' * distributed under the License is distributed on an "AS IS" BASIS,\n', ' * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n', ' * See the License for the specific language governing permissions and\n', ' * limitations under the License.\n', ' */\n', '\n', '\n', '/* String utility library */\n', 'library strUtils {\n', '    string constant CHAINY_JSON_ID = \'"id":"CHAINY"\';\n', '    uint8 constant CHAINY_JSON_MIN_LEN = 32;\n', '\n', '    /* Converts given number to base58, limited by _maxLength symbols */\n', '    function toBase58(uint256 _value, uint8 _maxLength) internal returns (string) {\n', '        string memory letters = "123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ";\n', '        bytes memory alphabet = bytes(letters);\n', '        uint8 base = 58;\n', '        uint8 len = 0;\n', '        uint256 remainder = 0;\n', '        bool needBreak = false;\n', '        bytes memory bytesReversed = bytes(new string(_maxLength));\n', '\n', '        for (uint8 i = 0; i < _maxLength; i++) {\n', '            if(_value < base){\n', '                needBreak = true;\n', '            }\n', '            remainder = _value % base;\n', '            _value = uint256(_value / base);\n', '            bytesReversed[i] = alphabet[remainder];\n', '            len++;\n', '            if(needBreak){\n', '                break;\n', '            }\n', '        }\n', '\n', '        // Reverse\n', '        bytes memory result = bytes(new string(len));\n', '        for (i = 0; i < len; i++) {\n', '            result[i] = bytesReversed[len - i - 1];\n', '        }\n', '        return string(result);\n', '    }\n', '\n', '    /* Concatenates two strings */\n', '    function concat(string _s1, string _s2) internal returns (string) {\n', '        bytes memory bs1 = bytes(_s1);\n', '        bytes memory bs2 = bytes(_s2);\n', '        string memory s3 = new string(bs1.length + bs2.length);\n', '        bytes memory bs3 = bytes(s3);\n', '\n', '        uint256 j = 0;\n', '        for (uint256 i = 0; i < bs1.length; i++) {\n', '            bs3[j++] = bs1[i];\n', '        }\n', '        for (i = 0; i < bs2.length; i++) {\n', '            bs3[j++] = bs2[i];\n', '        }\n', '\n', '        return string(bs3);\n', '    }\n', '\n', '    /* Checks if provided JSON string has valid Chainy format */\n', '    function isValidChainyJson(string _json) internal returns (bool) {\n', '        bytes memory json = bytes(_json);\n', '        bytes memory id = bytes(CHAINY_JSON_ID);\n', '\n', '        if (json.length < CHAINY_JSON_MIN_LEN) {\n', '            return false;\n', '        } else {\n', '            uint len = 0;\n', '            if (json[1] == id[0]) {\n', '                len = 1;\n', '                while (len < id.length && (1 + len) < json.length && json[1 + len] == id[len]) {\n', '                    len++;\n', '                }\n', '                if (len == id.length) {\n', '                    return true;\n', '                }\n', '            }\n', '        }\n', '\n', '        return false;\n', '    }\n', '}\n', '\n', '\n', '// Ownership\n', 'contract owned {\n', '    address public owner;\n', '\n', '    function owned() {\n', '        owner = msg.sender;\n', '    }\n', '\n', '    modifier onlyOwner {\n', '        if (msg.sender != owner) throw;\n', '        _\n', '    }\n', '\n', '    function transferOwnership(address newOwner) onlyOwner {\n', '        owner = newOwner;\n', '    }\n', '}\n', '\n', 'contract Chainy is owned {\n', '    // Chainy viewer url\n', '    string CHAINY_URL;\n', '\n', '    // Configuration\n', '    mapping(string => uint256) private chainyConfig;\n', '\n', '    // Service accounts\n', '    mapping (address => bool) private srvAccount;\n', '\n', '    // Fee receiver\n', '    address private receiverAddress;\n', '\n', '    struct data {uint256 timestamp; string json; address sender;}\n', '    mapping (string => data) private chainy;\n', '\n', '    event chainyShortLink(uint256 timestamp, string code);\n', '\n', '    // Constructor\n', '    function Chainy(){\n', '        setConfig("fee", 0);\n', '        // change the block offset to 1000000 to use contract in testnet\n', '        setConfig("blockoffset", 2000000);\n', '        setChainyURL("https://txn.me/");\n', '    }\n', '\n', '    // Sets new Chainy viewer URL\n', '    function setChainyURL(string _url) onlyOwner {\n', '        CHAINY_URL = _url;\n', '    }\n', '\n', '    // Returns current Chainy viewer URL\n', '    function getChainyURL() constant returns(string){\n', '        return CHAINY_URL;\n', '    }\n', '\n', '    // Sets configuration option\n', '    function setConfig(string _key, uint256 _value) onlyOwner {\n', '        chainyConfig[_key] = _value;\n', '    }\n', '\n', '    // Returns configuration option\n', '    function getConfig(string _key) constant returns (uint256 _value) {\n', '        return chainyConfig[_key];\n', '    }\n', '\n', '    // Add/Remove service account\n', '    function setServiceAccount(address _address, bool _value) onlyOwner {\n', '        srvAccount[_address] = _value;\n', '    }\n', '\n', '    // Set receiver address\n', '    function setReceiverAddress(address _address) onlyOwner {\n', '        receiverAddress = _address;\n', '    }\n', '\n', '    // Send all ether back to owner\n', '    function releaseFunds() onlyOwner {\n', '        if(!owner.send(this.balance)) throw;\n', '    }\n', '\n', '    // Add record\n', '    function addChainyData(string json) {\n', '        checkFormat(json);\n', '\n', '        var code = generateShortLink();\n', '        // Checks if the record exist\n', '        if (getChainyTimestamp(code) > 0) throw;\n', '\n', '        processFee();\n', '        chainy[code] = data({\n', '            timestamp: block.timestamp,\n', '            json: json,\n', '            sender: tx.origin\n', '        });\n', '\n', '        // Fire event\n', '        var link = strUtils.concat(CHAINY_URL, code);\n', '        chainyShortLink(block.timestamp, link);\n', '    }\n', '\n', '    // Get record timestamp\n', '    function getChainyTimestamp(string code) constant returns (uint256) {\n', '        return chainy[code].timestamp;\n', '    }\n', '\n', '    // Get record JSON\n', '    function getChainyData(string code) constant returns (string) {\n', '        return chainy[code].json;\n', '    }\n', '\n', '    // Get record sender\n', '    function getChainySender(string code) constant returns (address) {\n', '        return chainy[code].sender;\n', '    }\n', '\n', '    // Checks if enough fee provided\n', '    function processFee() internal {\n', '        var fee = getConfig("fee");\n', '        if (srvAccount[msg.sender] || (fee == 0)) return;\n', '\n', '        if (msg.value < fee)\n', '            throw;\n', '        else\n', '            if (!receiverAddress.send(fee)) throw;\n', '    }\n', '\n', '    // Checks if provided string has valid format\n', '    function checkFormat(string json) internal {\n', '        if (!strUtils.isValidChainyJson(json)) throw;\n', '    }\n', '\n', '    // Generates a shortlink code for this transaction\n', '    function generateShortLink() internal returns (string) {\n', '        var s1 = strUtils.toBase58(block.number - getConfig("blockoffset"), 11);\n', '        var s2 = strUtils.toBase58(uint256(tx.origin), 2);\n', '\n', '        var s = strUtils.concat(s1, s2);\n', '        return s;\n', '    }\n', '\n', '}']